# -*- coding: utf-8 -*-
# Generated by Django 1.11.22 on 2019-11-04 19:12
from __future__ import unicode_literals

from django.db import migrations, models

import partial_index

CREATE_SEQUENCE_SQL = "CREATE SEQUENCE xform_instance_update_sequence"
CREATE_TRIGGER_SQL = """
 CREATE OR REPLACE FUNCTION xform_instance_update_sequence_fn()
 RETURNS TRIGGER AS
 $BODY$
 BEGIN
   NEW.update_sequence_id:=nextval('xform_instance_update_sequence');
   Return NEW;
 END;
 $BODY$
 LANGUAGE 'plpgsql' VOLATILE;

CREATE TRIGGER xform_instance_sql_sequence_trigger
BEFORE INSERT OR UPDATE ON "form_processor_xforminstancesql"
FOR EACH ROW EXECUTE PROCEDURE xform_instance_update_sequence_fn();
"""


class Migration(migrations.Migration):

    dependencies = [
        ('form_processor', '0091_auto_20190603_2023'),
    ]

    operations = [
        migrations.AddField(
            model_name='xforminstancesql',
            name='update_sequence_id',
            field=models.BigIntegerField(null=True),
        ),
        migrations.AddIndex(
            model_name='xforminstancesql',
            index=partial_index.PartialIndex(fields=['update_sequence_id'], name='form_proces_update__faf368_partial', unique=False, where=partial_index.PQ(update_sequence_id__isnull=False)),
        ),
        migrations.RunSQL(
            sql=CREATE_SEQUENCE_SQL,
        ),
        migrations.RunSQL(
            sql=CREATE_TRIGGER_SQL,
        ),
    ]
