{% extends 'style/bootstrap2/base_page.html' %}
{% load i18n %}
{% load hq_shared_tags %}
{% load timezone_tags %}

{% block title %}{% trans "Edit Feature Flag: " %}{{ toggle_meta.label }}{% endblock %}

{% block js %}{{ block.super }}
    <script src="{% static 'hqwebapp/js/ajax_csrf_setup.js' %}"></script>
    <script src="{% static 'hqwebapp/js/main.js' %}"></script>
    <script src="{% static 'style/ko/knockout_bindings.ko.js' %}"></script>
    <script src="{% static 'formdesigner/js/lib/underscore-1.5.2.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script>
    $(function () {
        $('.hq-help-template').each(function () {
            COMMCAREHQ.makeHqHelp({
                content: $(this).data('content'),
                title: $(this).data('title')
            }, false).insertAfter(this);
            $(this).remove();
        });
        $('.hq-help').hqHelp();
    });
    $(function(){
        var PAD_CHAR = '&nbsp;'
        function ToggleView() {
            var self = this;
            self.items = ko.observableArray();

            self.init = function (config) {
                self.padded_ns = {};
                var max_ns_len = Math.max.apply(Math, _.map(config.namespaces, function (ns) { return ns.length }));
                _(config.namespaces).each(function (namespace) {
                    var diff = max_ns_len - namespace.length,
                        pad = new Array(diff + 1).join(PAD_CHAR);
                    self.padded_ns[namespace] = namespace + pad;
                });

                self.init_items(config.items);
            };

            self.init_items = function (items) {
                self.items.removeAll();
                _(items).each(function (item) {
                    var fields = item.split(':'),
                        namespace = fields.length > 1 ? fields[0] : 'user',
                        value = fields.length > 1 ? fields[1] : fields[0];
                    self.items.push({
                        namespace: ko.observable(self.padded_ns[namespace]),
                        value: ko.observable(value)
                    });
                });
            };

            self.addItem = function (namespace) {
                self.items.push({
                    namespace: ko.observable(self.padded_ns[namespace]),
                    value: ko.observable()
                });
                self.change();
            };

            self.removeItem = function (item) {
                self.items.remove(item);
                self.change();
            };

            self.change = function () {
                self.saveButton.fire('change');
            };

            self.saveButton = COMMCAREHQ.SaveButton.init({
                unsavedMessage: "You have unchanged changes",
                save: function () {
                    var items = _.map(self.items(), function (item) {
                        var ns_raw = item.namespace().replace(new RegExp(PAD_CHAR, 'g'), ''),
                            namespace = ns_raw === 'user' ? null : ns_raw,
                            value = namespace === null ? item.value() : namespace + ':' + item.value();
                        return value;
                    });
                    self.saveButton.ajax({
                        type: 'post',
                        url: "{% url "edit_toggle" toggle.slug %}",
                        data: {
                            item_list: JSON.stringify(items)
                        },
                        dataType: 'json',
                        success: function (data) {
                            self.init_items(data.item_list);
                        }
                    });
                }
            });
        }

        var home = $('#toggle_editing_ko');
        var view = new ToggleView();
        view.init({
            items: {{ toggle.enabled_users|JSON }},
            namespaces: {{ namespaces|JSON }}
        });
        ko.applyBindings(view, home.get(0));
        home.on('change', 'input', view.change);
    });
</script>
{% endblock %}
{% block page_content %}
    {% if toggle_meta.description %}
        <p>{{ toggle_meta.description|safe }}</p>
    {% endif %}
    <p>{% trans "This flag is tagged as: " %}<span class="label label-{{ toggle_meta.tag.css_class }}">{{ toggle_meta.tag.name }}</span></p>
    {% if toggle_meta.help_link %}
    <p><a href="{{ toggle_meta.help_link }}" target="_blank">{% trans "More information" %}</a></p>
    {% endif %}
    <div id="toggle_editing_ko">
        <div data-bind="saveButton: saveButton"></div>
        <h4>{% trans "Enabled toggle items" %}</h4>
        <div>
            {% if toggle_meta.randomness %}
                <p>
                    {% blocktrans with percent=toggle_meta.randomness_percent namespace=toggle_meta.namespace %}
                    And <strong>{{ percent }}%</strong> of all other {{ namespace }}s.
                    {% endblocktrans %}
                    {% if not expanded %}
                        <a href="{% url 'edit_toggle' toggle_meta.slug %}?expand=true">({% trans "see all" %})</a>
                    {% endif %}
                    <br/>
                    <ul>
                        <li>
                            <span class="muted">{% trans "Go to the project settings page to see if a toggle is randomly enabled for your domain." %}</span>
                        </li>
                    </ul>
                </p>
            {% endif %}
        </div>
        <hr/>
        <!-- ko foreach: items -->
        <div class="row">
            <div class="span1">
                <a href="#" class="btn btn-danger" data-bind="click: $parent.removeItem"><i class="icon-trash"></i></a>
            </div>
            <div class="span6">
                <div class="input-append">
                  <input class="input-medium" type="text" data-bind="value: value">
                  <span class="add-on" data-bind="html: namespace" style="font-family:monospace;"></span>
                </div>
            </div>
        </div>
        <!-- /ko -->
        {% for namespace in namespaces %}
            <button class="btn btn-success" data-bind="click: function (){ addItem('{{ namespace }}') }">
                <i class="icon-plus"></i> {% trans "Add " %}{{ namespace }}
            </button>
        {% endfor %}
    </div>
    {% if expanded %}
        <hr/>
        <h1>{% trans "All domain/toggle statuses" %}</h1>
            <table class="table table-striped">
            <thead>
                <tr>
                    <th>{% trans "Domain" %}</th>
                    <th>{% trans "Enabled?" %}</th>
                </tr>
            </thead>
            <tbody>
            {% for domain, enabled in domain_toggle_list %}
                <tr {% if enabled %}class="info"{% endif %}>
                    <td>{{ domain }}</td>
                    <td>{{ enabled }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
{% endblock %}
