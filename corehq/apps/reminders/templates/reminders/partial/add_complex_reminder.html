{% extends "reminders/reminders_base.html" %}

{% block head %}{{ block.super }}
<style type="text/css">
    h2 {
        border-bottom: 1px solid #555;
    }
    #id_schedule_length {
        width: 50px;
    }
    .errorlist ul {
        margin: 0;
        padding: 0;
    }
    .errorlist li {
        background-color: #F88;
        border: 1px solid #A44;
        padding: 2px;
    }
    div.clickable {
        cursor: pointer;
        font-family: "Courier New";
    }
    span.clickable {
        cursor: pointer;
        font-family: "Courier New";
    }
    
    .hq-oldstyle input.tiny {
      width: 20px;
    }
</style>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
    function create_text_input(class_name) {
        var node = document.createElement("INPUT");
        node.setAttribute("type", "text");
        node.setAttribute("class", class_name);
        return node;
    }
    
    function create_survey_select_td() {
        var td = document.createElement("TD");
        td.setAttribute("name", "for_survey");
        var div = document.createElement("DIV");
        var select = document.createElement("SELECT");
        {% for f in form_list %}
        var option = document.createElement("OPTION");
        option.setAttribute("value", "{{ f.code }}");
        option.innerHTML = "{{ f.name }}";
        select.appendChild(option);
        {% endfor %}
        div.appendChild(select);
        td.appendChild(div);
        return td;
    }
    
    function create_new_row() {
        var tr = document.createElement("TR");
        
        var td1 = document.createElement("TD");
        var span1 = document.createElement("SPAN");
        span1.setAttribute("name", "event_label1");
        td1.appendChild(span1);
        
        var td2 = document.createElement("TD");
        td2.appendChild(create_text_input("short"));
        
        var td3 = document.createElement("TD");
        var span2 = document.createElement("SPAN");
        span2.setAttribute("name", "event_label2");
        td3.appendChild(span2);
        
        var td4 = document.createElement("TD");
        td4.appendChild(create_text_input("short"));
        
        var td5 = document.createElement("TD");
        var span3 = document.createElement("SPAN");
        span3.setAttribute("name", "event_label3");
        td5.appendChild(span3);
        
        var td6 = document.createElement("TD");
        td6.setAttribute("name", "for_sms");
        td6.appendChild(create_message());
        
        var td6a = create_survey_select_td();
        
        var td7 = document.createElement("TD");
        var span4 = document.createElement("SPAN");
        span4.setAttribute("name", "event_label4");
        td7.appendChild(span4);
        
        var td8 = document.createElement("TD");
        td8.setAttribute("name","for_callbacks");
        td8.appendChild(create_text_input("short"));
        
        var td9 = document.createElement("TD");
        var div2 = document.createElement("DIV");
        div2.setAttribute("class","clickable");
        div2.innerHTML = "[-]";
        td9.appendChild(div2);
        td9.onclick = function() { delete_row(this); };
        
        var td10 = document.createElement("TD");
        var div3 = document.createElement("DIV");
        div3.setAttribute("class","clickable");
        div3.innerHTML = "[+]";
        td10.appendChild(div3);
        td10.onclick = function() { add_row(this); };
        
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tr.appendChild(td5);
        tr.appendChild(td6);
        tr.appendChild(td6a);
        tr.appendChild(td7);
        tr.appendChild(td8);
        tr.appendChild(td9);
        tr.appendChild(td10);
        return tr;
    }
    
    function add_row(cell_ref) {
        new_row = create_new_row();
        table_ref = cell_ref.parentNode.parentNode;
        try {
            // Try to add the new row before the next sibling
            next_row = cell_ref.parentNode.nextSibling;
            table_ref.insertBefore(new_row, next_row);
        } catch(e) {
            // If there's no nextSibling, add to the end of the table
            table_ref.appendChild(new_row);
        }
        order_rows(table_ref);
        event_interpretation_changed();
        method_changed();
    }
    
    function delete_row(cell_ref) {
        row_ref = cell_ref.parentNode;
        table_ref = row_ref.parentNode;
        table_ref.removeChild(row_ref);
        order_rows(table_ref);
    }
    
    function order_rows(table_ref) {
        row_num = 0;
        for(i = 0; i < table_ref.childNodes.length; i++) {
            child = table_ref.childNodes[i];
            tag_name = child.tagName;
            if(typeof(tag_name) == "string" && tag_name.toUpperCase() == "TR") {
                if(row_num > 0) {
                    set_row_num(child, row_num);
                }
                row_num++;
            }
        }
    }
    
    function set_row_num(row_ref, row_num) {
        col_num = 0;
        for(j = 0; j < row_ref.childNodes.length; j++) {
            element = row_ref.childNodes[j];
            element_tag_name = element.tagName;
            if(typeof(element_tag_name) == "string" && element_tag_name.toUpperCase() == "TD") {
                col_num++;
                inputs = element.getElementsByTagName("INPUT");
                if(col_num == 2) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".day");
                } else if(col_num == 4) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".time");
                } else if(col_num == 6) {
                    divs = element.getElementsByTagName("DIV");
                    for(k = 0; k < divs.length; k++) {
                        inputs = divs[k].getElementsByTagName("INPUT");
                        for(l = 0; l < inputs.length; l++) {
                            if(inputs[l].getAttribute("name").match(/^.*language.*$/) != null) {
                                inputs[l].setAttribute("name","reminder_events." + row_num + ".messages." + (k + 1) + ".language");
                            } else {
                                inputs[l].setAttribute("name","reminder_events." + row_num + ".messages." + (k + 1) + ".text");
                            }
                        }
                    }
                } else if(col_num == 7) {
                    div = element.getElementsByTagName("DIV");
                    select = div[0].getElementsByTagName("SELECT");
                    select = select[0];
                    select.setAttribute("name", "reminder_events." + row_num + ".survey");
                } else if(col_num == 9) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".timeouts");
                }
            }
        }
    }
    
    function create_message() {
        div = document.createElement("DIV");
        input1 = create_text_input("tiny");
        input1.setAttribute("name","language")
        input2 = create_text_input(null);
        input2.setAttribute("name","message")
        span1 = document.createElement("SPAN");
        span1.setAttribute("class", "clickable");
        span1.onclick = function() { delete_message(this); }
        span1.innerHTML = "[-]";
        span2 = document.createElement("SPAN");
        span2.setAttribute("class", "clickable");
        span2.onclick = function() { add_message(this); }
        span2.innerHTML = "[+]";
        div.appendChild(input1);
        div.appendChild(input2);
        div.appendChild(span1);
        div.appendChild(span2);
        return div;
    }
    
    function add_message(span_ref) {
        div_ref = span_ref.parentNode;
        td_ref = div_ref.parentNode;
        td_ref.appendChild(create_message());
        order_rows(td_ref.parentNode.parentNode);
    }
    
    function delete_message(span_ref) {
        div_ref = span_ref.parentNode;
        td_ref = div_ref.parentNode;
        if(td_ref.getElementsByTagName("DIV").length == 1) {
            alert("You must specify a message in at least one language.");
        } else {
            td_ref.removeChild(div_ref);
            order_rows(td_ref.parentNode.parentNode);
        }
    }
    
    //show_type should be "block", "inline", or "none"
    function show_elements_by_name(name, show_type) {
        elements = document.getElementsByName(name);
        for(i = 0; i < elements.length; i++) {
            elements[i].style.display = show_type;
        }
    }
    
    function change_inner_html(name, inner_html) {
        elements = document.getElementsByName(name);
        for(i = 0; i < elements.length; i++) {
            elements[i].innerHTML = inner_html;
        }
    }
    
    function method_changed() {
        e = document.getElementById("id_method");
        if(e.value == "survey") {
            show_elements_by_name("for_callbacks", "none");
            show_elements_by_name("for_sms", "none");
            show_elements_by_name("for_survey", "block");
            change_inner_html("event_label3","(hh:mm), send survey");
            change_inner_html("event_label4","");
        } else if(e.value == "callback") {
            show_elements_by_name("for_callbacks", "block");
            show_elements_by_name("for_sms", "block");
            show_elements_by_name("for_survey", "none");
            change_inner_html("event_label3","(hh:mm), send message");
            change_inner_html("event_label4","with callback intervals");
        } else {
            show_elements_by_name("for_callbacks", "none");
            show_elements_by_name("for_sms", "block");
            show_elements_by_name("for_survey", "none");
            change_inner_html("event_label3","(hh:mm), send message");
            change_inner_html("event_label4","");
        }
    }
    
    function start_match_type_changed() {
        e = document.getElementById("id_start_match_type");
        sv = document.getElementById("id_start_value");
        if(e.value == "ANY_VALUE") {
            sv.style.display = "none";
        } else {
            sv.style.display = "inline";
        }
    }
    
    function start_choice_changed() {
        e = document.getElementById("id_start_choice");
        sd = document.getElementById("id_start_date");
        if(e.value == "DATE") {
            sd.style.display = "inline";
        } else {
            sd.style.display = "none";
        }
    }
    
    function iteration_type_changed() {
        e = document.getElementById("id_iteration_type");
        e1 = document.getElementById("id_until");
        e2 = document.getElementById("id_max_iteration_count_input");
        if(e.value == "INDEFINITE") {
            e1.style.display = "inline";
            e2.style.display = "none";
        } else {
            e1.style.display = "none";
            e2.style.display = "inline";
        }
    }
    
    function event_interpretation_changed() {
        if(document.getElementById("id_event_interpretation").value == "SCHEDULE") {
            elements = document.getElementsByName("event_label1");
            for(i = 0; i < elements.length; i++) {
                elements[i].innerHTML = "On day";
            }
            elements = document.getElementsByName("event_label2");
            for(i = 0; i < elements.length; i++) {
                elements[i].innerHTML = ", at";
            }
            document.getElementById("schedule_length_label1").innerHTML = "A single schedule cycle lasts";
            document.getElementById("schedule_length_label2").innerHTML = "day(s).";
        } else {
            elements = document.getElementsByName("event_label1");
            for(i = 0; i < elements.length; i++) {
                elements[i].innerHTML = "After";
            }
            elements = document.getElementsByName("event_label2");
            for(i = 0; i < elements.length; i++) {
                elements[i].innerHTML = "day(s) and";
            }
            document.getElementById("schedule_length_label1").innerHTML = "After the last event, wait";
            document.getElementById("schedule_length_label2").innerHTML = "day(s) before restarting the cycle.";
        }
    }
</script>
{% endblock %}

{% block reminders_content %}
<form action="" method="post">
    <br />
    <h2>Reminder Definition</h2>
    <table>
        <tr><th></th><td>{{ form.nickname.errors }}</td></tr>
        <tr><th>Name</th><td>{{ form.nickname }}</td></tr>
        <tr><th></th><td>{{ form.default_lang.errors }}</td></tr>
        <tr><th>Default Language</th><td>{{ form.default_lang }}</td></tr>
    </table>
    <h2>Rule</h2>
    <br />
    {{ form.case_type.errors }}<br />
    For cases of type {{ form.case_type }}, start the below {{ form.method }} schedule, sending to {{ form.recipient }}.<br /><br />
    {{ form.start_property.errors }}{{ form.start_value.errors }}
    Start when case property {{ form.start_property }} {{ form.start_match_type }} <input type="text" name="start_value" id="id_start_value" value="{{ form.start_value.value|default:"" }}" {% if form.start_match_type.value == "ANY_VALUE" %}style="display: none;"{% endif %}/>.<br /><br />
    {{ form.start_date.errors }}{{ form.start_offset.errors }}
    Once this happens, start sending {{ form.start_choice }} <input type="text" name="start_date" id="id_start_date" value="{{ form.start_date.value|default:"" }}" {% if form.start_choice.value == "IMMEDIATELY" %}style="display: none;"{% endif %}/> plus {{ form.start_offset }} day(s).<br /><br />
    {{ form.until.errors }}{{ form.max_iteration_count.errors }}
    Stop sending {{ form.iteration_type }} :
    <input type="text" name="until" id="id_until" value="{{ form.until.value|default:"" }}" {% if form.iteration_type.value == "FIXED" %}style="display: none;"{% endif %}/>
    <input type="text" name="max_iteration_count_input" id="id_max_iteration_count_input" value="{{ form.max_iteration_count_input.value|default:"" }}" {% if form.iteration_type.value != "FIXED" %}style="display: none;"{% endif %}/>.
    <br /><br />
    <h2>Schedule</h2>
    <br />
    The event day(s) and time(s) below {{ form.event_interpretation }}
    <br />
    {{ form.events.errors }}
    <table>
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th name="for_sms" {% if form.method.value == "survey" %}style="display: none;"{% endif %}></th>
            <th name="for_survey" {% if form.method.value != "survey" %}style="display: none;"{% endif %}></th>
            <th></th>
            <th></th>
            <th name="for_callbacks" {% if form.method.value != "callback" %}style="display: none;"{% endif %}></th>
            <th></th>
            <th onClick="add_row(this);"><div class="clickable">[+]</div></th>
        </tr>
        {% for e in form.events.value %}
        <tr>
            <td><span name="event_label1">{% if form.event_interpretation.value == "SCHEDULE" %}On day{% else %}After{% endif %}</span></td>
            <td><input type="text" class="short" name="reminder_events.{{ forloop.counter }}.day" value="{{ e.day }}" /></td>
            <td><span name="event_label2">{% if form.event_interpretation.value == "SCHEDULE" %}, at{% else %}day(s) and{% endif %}</span></td>
            <td><input type="text" class="short" name="reminder_events.{{ forloop.counter }}.time" value="{{ e.time }}" /></td>
            <td><span name="event_label3">(hh:mm), send {% if form.method.value == "survey" %}survey{% else %}message{% endif %}</span></td>
            <td name="for_sms" {% if form.method.value == "survey" %}style="display: none;"{% endif %}>
                {% for message_num, message in e.messages.items %}
                <div>
                    <input type="text" class="tiny" name="reminder_events.{{ forloop.parentloop.counter }}.messages.{{ forloop.counter }}.language" value="{{ message.language }}" /><input type="text" name="reminder_events.{{ forloop.parentloop.counter }}.messages.{{ forloop.counter }}.text" value="{{ message.text }}" /><span class="clickable" onClick="delete_message(this);">[-]</span><span class="clickable" onClick="add_message(this);">[+]</span>
                </div>
                {% empty %}
                <div>
                    <input type="text" class="tiny" name="reminder_events.{{ forloop.counter }}.messages.1.language" value="" /><input type="text" name="reminder_events.{{ forloop.counter }}.messages.1.text" value="" /><span class="clickable" onClick="delete_message(this);">[-]</span><span class="clickable" onClick="add_message(this);">[+]</span>
                </div>
                {% endfor %}
            </td>
            <td name="for_survey" {% if form.method.value != "survey" %}style="display: none;"{% endif %}>
                <div>
                    <select name="reminder_events.{{ forloop.counter }}.survey">
                    {% for f in form_list %}
                        <option value="{{ f.code }}" {% if f.code == e.survey %}selected="selected"{% endif %}>{{ f.name }}</option>
                    {% endfor %}
                    </select>
                </div>
            </td>
            <td><span name="event_label4">{% if form.method.value == "callback" %}with callback intervals{% endif %}</span></td>
            <td name="for_callbacks" {% if form.method.value != "callback" %}style="display: none;"{% endif %}><input type="text" class="short" name="reminder_events.{{ forloop.counter }}.timeouts" value="{{ e.timeouts }}" /></td>
            <td onClick="delete_row(this);"><div class="clickable">[-]</div></td>
            <td onClick="add_row(this);"><div class="clickable">[+]</div></td>
        </tr>
        {% empty %}
        <tr>
            <td><span name="event_label1">{% if form.event_interpretation.value == "SCHEDULE" %}On day{% else %}After{% endif %}</span></td>
            <td><input type="text" class="short" name="reminder_events.1.day" /></td>
            <td><span name="event_label2">{% if form.event_interpretation.value == "SCHEDULE" %}, at{% else %}day(s) and{% endif %}</span></td>
            <td><input type="text" class="short" name="reminder_events.1.time" /></td>
            <td><span name="event_label3">(hh:mm), send {% if form.method.value == "survey" %}survey{% else %}message{% endif %}</span></td>
            <td name="for_sms" {% if form.method.value == "survey" %}style="display: none;"{% endif %}>
                <div>
                    <input type="text" class="tiny" name="reminder_events.1.messages.1.language" /><input type="text" name="reminder_events.1.messages.1.text" /><span class="clickable" onClick="delete_message(this);">[-]</span><span class="clickable" onClick="add_message(this);">[+]</span>
                </div>
            </td>
            <td name="for_survey" {% if form.method.value != "survey" %}style="display: none;"{% endif %}>
                <div>
                    <select name="reminder_events.1.survey">
                    {% for f in form_list %}
                        <option value="{{ f.code }}" {% if f.code == e.survey %}selected="selected"{% endif %}>{{ f.name }}</option>
                    {% endfor %}
                    </select>
                </div>
            </td>
            <td><span name="event_label4">{% if form.method.value == "callback" %}with callback intervals{% endif %}</span></td>
            <td name="for_callbacks" {% if form.method.value != "callback" %}style="display: none;"{% endif %}><input type="text" class="short" name="reminder_events.1.timeouts" /></td>
            <td onClick="delete_row(this);"><div class="clickable">[-]</div></td>
            <td onClick="add_row(this);"><div class="clickable">[+]</div></td>
        </tr>
        {% endfor %}
    </table>
    <div>
        {{ form.schedule_length.errors }}
        <label id="schedule_length_label1">
        {% if form.event_interpretation.value != "SCHEDULE" %}
        After the last event, wait
        {% else %}
        A single schedule cycle lasts
        {% endif %}
        </label>
        {{ form.schedule_length }}
        <label id="schedule_length_label2">
        {% if form.event_interpretation.value != "SCHEDULE" %}
        day(s) before restarting the cycle.
        {% else %}
        day(s).
        {% endif %}
        </label>
    </div>
    <br />
    <input type="Submit" value="Save" />
</form>
{% endblock %}
