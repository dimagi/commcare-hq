{% extends "hqwebapp/centered.html" %}
{% load hq_shared_tags %}
{% load i18n %}

{% block title %}{% trans 'Bulk Upload of Multimedia' %}{% endblock title %}

{% block js %} {{ block.super }}
    {% include 'hqmedia/includes/yui_upload.html' %}
    <script type="text/javascript" src="{% static 'hqmedia/js/hqmedia.uploader.js' %}"></script>
    <script type="text/javascript" src="{% static 'hqwebapp/javascripts/underscore-1.3.1.js' %}"></script>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script type="text/javascript">
        $(function() {
            // use these filters when we figure out what to do with duplicate filenames in different folders
//            new Array({description:"Zip", extensions:"*.zip"},
//                    {description:"Images", extensions:"*.jpg;*.png;*.gif"},
//                    {description:"Audio", extensions:"*.mp3"}),
            var uploader = new HQMediaUploader({
                uploadElem: '#hqmedia-upload',
                fileFilters: new Array({description:"Zip", extensions:"*.zip"}),
                uploadURL: '{% url hqmedia_handle_uploaded domain app.get_id %}',
                onSuccess: showUploadStats,
                swfLocation: '{% static 'hqmedia/yui/uploader/uploader.swf' %}',
                uploadParams: {replace_existing: false},
                uploadFormParams: ['license', 'author', 'attribution-notes']
            });
            uploader.render();

            function showUploadStats (event, resp) {
                var $currentMedia = $('#hqmedia_'+event.id);
                if (resp.zip) {
                    // Handle Zip File Response
                    if ($.isEmptyObject(resp.images) && $.isEmptyObject(resp.audio)) {
                        $currentMedia.find('.match_status').html($('<span class="label label-important" />').text("No Matches Found"));
                    } else {
                        $currentMedia.find('.match_status').html($('<span class="label label-success" />').text("Matches Found"));
                        var $imageList = createMatchList(resp.images),
                            $audioList = createMatchList(resp.audio, true),
                            $detailList = $currentMedia.find('.details');
                        var accordion_id;
                        if (!_.isEmpty(resp.images))
                            $detailList.append(createAccordionItem('imageRef_',
                                                                    "Matched Images ("+resp.images.length+")",
                                                                    $imageList));

                        if (!_.isEmpty(resp.audio))
                            $detailList.append(createAccordionItem('audioRef_',
                                    "Matched Audio ("+resp.audio.length+")",
                                    $audioList));
                    }
                } else if (resp.file) {
                    if (!_.isEmpty(resp.image)) {
                        $currentMedia.find('.match_status').html($('<div class="label label-success" />').text("Image Match Found"));
                        $currentMedia.find('.details').append(createMatchList(new Array(resp.image)));
                    } else if (!$.isEmptyObject(resp.audio)) {
                        $currentMedia.find('.match_status').html($('<div class="label label-success" />').text("Audio Match Found"));
                        $currentMedia.find('.details').append(createMatchList(new Array(resp.audio), true));
                    } else {
                        $currentMedia.find('.match_status').html($('<div class="label label-inverse" />').text("No Match Found"));
                    }
                }
            }

            function createAccordionItem(id_prefix, header_text, content) {
                var accordion_id = _.uniqueId(id_prefix),
                    $accordionToggle = $('<a class="accordion-toggle" data-toggle="collapse" />'),
                    $accordionBody = $('<div class="accordion-body collapse" />');
                $accordionToggle.text(header_text);
                $accordionToggle.attr('href', '#'+accordion_id);
                $accordionBody.attr('id',accordion_id);
                $accordionBody.append($('<div class="accordion-inner" />').append(content));
//                $accordionBody.collapse();
                return $('<div class="accordion-group" />').append($('<div class="accordion-heading" />').html($accordionToggle),
                                                                   $accordionBody);
            }

            function createMatchList (matches, is_audio) {
                var $list = $('<dl style="margin: 5px 0 0;" />');
                for (var i in matches) {
                    var $name = $('<dt />'),
                         $val = $('<dd />'),
                        $view = $('<a style="margin-bottom:6px;" target="_blank" class="btn btn-info btn-mini" />');
                    $view.text('Preview');
                    if (is_audio) {
                        $view.popout({
                            title: 'Click to open in new tab',
                            content: 'Audio not currently available for on-the-fly preview.',
                            placement: 'bottom',
                            trigger: 'hover'
                        });
                    } else {
                        $view.popout({
                            title: 'Click to open in new tab',
                            html: true,
                            content: '<img src="'+matches[i].url+'" alt="'+matches[i].path+'" />',
                            placement: 'bottom',
                            trigger: 'hover'
                        });
                    }
                    $view.attr('href', matches[i].url);
                    $name.text(matches[i].upload_path);
                    $val.text(matches[i].path);
                    $val.append($('<br />'));
                    $val.append($view);
                    $list.append($name);
                    $list.append($val);
                }
                return $list;
            }

        });
    </script>
{% endblock %}

{% block centered-content %}
    <ul class="breadcrumb">
        <li><a href="{% url view_app domain app.get_id %}">{% trans 'Application' %} "{{ app.name }}"</a> <span class="divider">&gt;</span></li>
        <li><a href="{% url hqmedia_references domain app.get_id %}">{% trans 'Multimedia Reference Checker' %}</a> <span class="divider">&gt;</span></li>
        <li class="active"><a href="{% url hqmedia_bulk_upload domain app.get_id %}">{% trans 'Bulk Upload' %}</a></li>
    </ul>
    <div class="page-header">
        <h1><i class="icon icon-cloud-upload"></i> {% trans 'Multimedia Bulk Upload' %}</h1>
    </div>
    <p>{% blocktrans %}Use this tool to upload ZIP files of your multimedia, so you don't have to
        upload each file one-by-one.{% endblocktrans %}</p>
    <p>{% blocktrans %}The bulk uploader will compare the file paths in your form with the file paths
        in your zip to find a matching file.{% endblocktrans %}</p>
    <p>{% blocktrans %}For example, <code>jr://file/commcare/images/hin/image.jpg</code> and your zip's
        <code>commcare/images/hin/image.jpg</code> file would match, but it would <strong>not</strong> match
        <code>commcare/images/image.jpg</code>.{% endblocktrans %}</p>
    
    <div id="hqmedia-upload">
        <div class="btn-toolbar">
            <div class="hqm-overlay" style="position:absolute; z-index:2"></div>
            <a class="hqm-select btn btn-primary" href="#" style="z-index:1;">{% trans 'Select Files' %}</a>
            <a class="hqm-upload-button-helper btn disabled" href="#hqm-upload-modal" onclick="return false;" data-toggle="modal"><i class="icon icon-cloud-upload"></i> {% trans 'Upload Files' %}</a>
        </div>
        <div id="hqm-upload-modal" class="hide modal fade">
            <div class="modal-header">
                <a class="close" href="#" data-dismiss="modal">&times;</a>
                <h3>{% trans 'Please select the license you wish to upload these files under' %}</h3>
            </div>
            <div class="form-horizontal hqm-upload-form">
                <div class="modal-body">
                    {% include 'hqmedia/partials/hqm_upload_form.html' %}
                </div>
                <div class="modal-footer">
                    <a class="hqm-upload-button btn disabled" data-dismiss="modal" onclick="return false;"><i class="icon icon-cloud-upload"></i>
                        {% trans 'Continue with Upload' %}</a> <a href="#" data-dismiss="modal" class="btn">{% trans 'Cancel' %}</a>
                </div>
            </div>
        </div>
        <h3>{% trans 'Bulk Upload File Queue' %}</h3>
        <table class="table table-striped table-bordered hqm-upload-list">
            <thead>
                <tr>
                    <th class="span2">{% trans 'Filename' %}</th>
                    <th class="span1">{% trans 'Size' %}</th>
                    <th class="span2">{% trans 'Upload Progress' %}</th>
                    <th class="span2">{% trans 'Match Status' %}</th>
                    <th class="span5">{% trans 'Details' %}</th>
                </tr>
            </thead>
            <tbody class="queue">
                <tr class="hqm-empty_queue-notice">
                    <td colspan="5">{% blocktrans %}Select files above to add to the queue.{% endblocktrans %}</td>
                </tr>
            </tbody>
            <thead>
                <tr class="hqm-uploaded-notice hide">
                    <th colspan="5">{% trans 'Uploaded Files' %}</th>
                </tr>
            </thead>
            <tbody class="done">
            </tbody>
        </table>
    </div>
{% endblock centered-content %}
