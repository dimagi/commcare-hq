"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[141],{4141:(e,t,n)=>{n.r(t);var o=n(1134),r=n(8324),a=n.n(r),i=n(561),u=n.n(i),l=n(4523),s=n(3586),c=n.n(s),d=a().assert;describe("The commander plugin",(function(){var e,t;before((function(n){o.A.init({javaRosa:{langs:["en"]},features:{rich_text:!1},core:{onReady:function(){e=this,t=c().getQuestionMap(e),n()}}})})),beforeEach((function(){o.A.loadXML()})),l.Ay.each([{cmd:"text",type:"Text"},{cmd:"text before",type:"Text",index:3},{cmd:"text after",type:"Text",index:3,select:"group"},{cmd:"text before #form/group",type:"Text",index:0},{cmd:"Text after #form/group",type:"Text",index:3},{cmd:"Text in #form/group",type:"Text",index:3,indent:"  "},{cmd:"Text before #form/group/select",type:"Text",index:1,indent:"  "},{cmd:"Text after #form/group/select",type:"Text",index:3,indent:"  "},{cmd:"choice",type:"Choice",index:3,indent:"    ",select:"group/select"},{cmd:"Choice in #form/group/select",type:"Choice",index:3,indent:"    "},{cmd:"Choice first in #form/group/select",type:"Choice",index:2,indent:"    "}],(function(t){it("should add a "+t.type+" question with '"+t.cmd+"'",(function(){o.A.paste([["id","type","labelItext:en-default"],["/group","Group","group"],["/group/select","Select","select"],["/group/select/item","Choice","item"],["/text","Text","text"]]),t.select&&o.A.clickQuestion(t.select);var n=c().doCommand(t.cmd,e);d.isOk(n,"question not added"),u()("[name=property-nodeID]").val("new").change(),e.ensureCurrentMugIsSaved();var r=["group","  select","    item","text"];t.hasOwnProperty("index")?r.splice(t.index,0,(t.indent||"")+"new"):r.push("new"),o.A.assertJSTreeState.apply(null,r),d.equal(n.name,"add question"),d.equal(n.value.__className,t.type)}))})),l.Ay.each([{cmd:"text",type:"Text"},{cmd:"text before",type:"Text"},{cmd:"text after",type:"Text"},{cmd:"text in",type:"Text"},{cmd:"text first in",type:"Text"}],(function(t){it("should add a "+t.type+" question with '"+t.cmd+"' and empty tree",(function(){var n=c().doCommand(t.cmd,e);d.isOk(n,"question not added"),u()("[name=property-nodeID]").val("new").change(),e.ensureCurrentMugIsSaved(),o.A.assertJSTreeState("new"),d.equal(n.name,"add question"),d.equal(n.value.__className,t.type)}))})),l.Ay.each(["#form/group","#form/group/select","#form/text"],(function(t){it("should select "+t,(function(){o.A.paste([["id","type","labelItext:en-default"],["/group","Group","group"],["/group/select","Select","select"],["/group/select/item","Choice","item"],["/text","Text","text"]]);var n=c().doCommand(t,e);d.isOk(n,"question not selected"),d.equal(n.name,"select question");var r=e.getCurrentlySelectedMug();d.equal(r.hashtagPath,t)}))})),l.Ay.each(["choice","choice in #form/group"],(function(t){it("should not execute bad command: "+t,(function(){var n=c().doCommand(t,e);d.isUndefined(n,"unexpected result: "+n)}))})),l.Ay.each([["txt",[]],["cho",["Choice","Multiple Choice","Multiple Choice Lookup Table"]],["choice ",["...after","...before","...first in","...in","Multiple Choice Lookup Table"]],["choice i",["...in","...first in"]],["Date and Time ",["...after","...before","...first in","...in"]]],(function(n){var o=n[0],r=n[1];it("should get completions for: "+o,(function(){var n=l.Ay.map(r,(function(e){return e.startsWith("...")?{name:e.slice(3),icon:void 0,full:/^.+ /.exec(o)[0]+e.slice(3)}:{name:e,icon:t[e.toLowerCase()].icon,full:e}})),a=c().getCompletions(o,e);d.deepEqual(a,n)}))})),l.Ay.each([["txt",void 0],["Choice ",["Choice",void 0,void 0]],["Choice in ",["Choice","in",void 0]],["choice in /data/blue",["choice","in","/data/blue"]],["text first in #form/group",["text","first in","#form/group"]],["#form/blue",["#form/blue"]]],(function(t){var n=t[0],o=t[1];it("should tokenize: "+n,(function(){var t=c().tokenize(n,e);d.deepEqual(t&&t.tokens,o)}))})),l.Ay.each(["text","choice"],(function(t){it("should have '"+t+"' in it's question map",(function(){d.hasAnyKeys(c().getQuestionMap(e),[t])}))})),it("should not have 'itemset' in it's question map",(function(){d.doesNotHaveAnyKeys(c().getQuestionMap(e),["itemset"])})),it("select after add bug",(function(){o.A.paste([["id","type","labelItext:en-default"],["/text","Text","text"]]);var t=c().doCommand("Text after",e),n=t&&t.value;d.equal(t&&t.name,"add question"),u()("[name=itext-en-label]").val("text2").change(),d.equal(n.p.nodeID,void 0),t=c().doCommand("#form/text",e),d.equal(t&&t.name,"select question"),d.equal(n.p.nodeID,"text2"),t=c().doCommand("#form/text2",e),d.equal(t&&t.name,"select question")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>_});var o=n(8449),r=n(8324),a=n.n(r),i=n(6848),u=n.n(i),l=n(3794),s=n.n(l),c=n(4523),d=n(561),f=n.n(d),p=n(1437),m=n.n(p),g=n(3809),h=n.n(g),v=n(705),x=n.n(v),y=n(7229),A=n.n(y),b=(n(1460),n(8803),a().assert),q=["Form Builder clip","version 1"];function w(e,t,n){if((n=c.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=A().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var r,a,i,l,s=(r=e,a=t,i=u().xml(r),l=u().xml(a),u().isEquivalent(i,l,{element_order:!0}));n.not&&(s=!s),s||C(e=T(e),t=T(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function C(e,t,n){if(e!==t){var o=s().createPatch("",e,t,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),b(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(o))}}function T(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function I(e){return M("getCurrentMugInput",e)}function S(e){var t=f()("#vellum").vellum("get"),n=c.Ay.isString(e)?f()("[name="+e+"]"):e;return x().util.getWidget(n,t)}function M(){var e=Array.prototype.slice.call(arguments),t=f()("#vellum");return t.vellum.apply(t,e)}function j(){var e=[],t=c.Ay.map(arguments,(function(t){var n=c.Ay.isString(t)?k(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return M("jstree","deselect_all",!0),M("jstree","select_node",t),f()(".collapse-toggle.collapsed").click(),e}function k(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=M("getMugByPath",e);if(!t){var n=e.split("/"),o=M("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var r=M("getData").core.form.getChildren(o),a=n[n.length-1];if(1===r.length&&"itemset"===a&&"itemset"===r[0].options.tagName)return r[0];for(var i=0;i<r.length;i++)if(r[i].p.nodeID===a)return r[i]}}return t}b.equal=b.strictEqual,b.notEqual=b.notStrictEqual;const _={options:o.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=f().extend(!0,{},o.A.options,e),n=f().fn.animate;f().fn.animate=function(e,t,o,r){n.apply(this,[e,0,o,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=c.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&c.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var a=f()("#vellum"),i=a.vellum("get");i&&(i.destroy(),f()("body > div.modal, body > div.modal-backdrop").remove()),a.empty().vellum(t)},call:M,loadXML:function(e,t,n,o,r=!0){var a=[],i=M("getData");return o||window.history.replaceState(null,null," "),i.core.parseWarnings=[],M("loadXML",e,t||{},{reset:r}),n?c.Ay.isRegExp(n)&&(a=c.Ay.filter(i.core.parseWarnings,(function(e){return!n.test(e)}))):a=i.core.parseWarnings,b(!a.length,"unexpected parse warnings:\n- "+a.join("\n- ")),delete i.core.parseWarnings,i.core.form},saveAndReload:function(e){M("loadXFormOrError",M("createXML"),e)},getMug:k,getInput:I,getWidget:S,getMediaUploader:function(e){var t,n={},o=S(e);if(!o)throw new Error("media uploader widget not found");if(c.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:o.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:C,assertInputCount:function(e,t,n){c.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=I(e)):n=n?" for "+n:"",b.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:w,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,w(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";C(function e(t,n){var o,r,a,i=[];for("#"===t.id?n=-1:i.push(Array(2*n+1).join(" ")+t.text),o=0,r=t.children.length;o<r;o++)a=M("jstree","get_node",t.children[o]),i.push(e(a,n+1));return i.join("\n")}(M("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";C(function e(t,n){var o,r,a,i=[];for(t.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+t.value.p.nodeID),o=0,r=t.children.length;o<r;o++)a=t.children[o],i.push(e(a,n+1));return i.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=c.Ay.extend({},n),this.prevId&&j(this.prevId);var o=M("addQuestion",e);return t||o.p.nodeID||(t=M("nodeIDFromLabel",o)),t&&(b(c.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),c.Ay.each(n,(function(e,t){c.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?o.p[t].set(e):o.p[t]=e})),c.Ay.each(M("getSections",o),(function(e){M("collapseSection",e.slug,!1)})),o},paste:function(e,t,n){c.Ay.isString(e)||(e=h().tabDelimit([q].concat(e))),n&&window.console.log(e),b.deepEqual(m().paste(e),t||[])},clickQuestion:j,selectAll:function(){M("jstree","select_all")},deleteQuestion:function(){var e=c.Ay.map(arguments,(function(e){var t=k(e);return b(t,"mug not found: "+e),t}));M("getData").core.form.removeMugsFromForm(e),c.Ay.each(arguments,(function(e){b(!k(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=M("getData").core.saveButton;if(!c.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),b.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){M("jstree","open_node",e.ufid),M("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){M("jstree","close_node",e.ufid),M("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(c.Ay.isString(e)){var o=e;e=k(o),b(e,"mug not found: "+o)}return e.messages.each((function(e,o){o!==n&&(t.push(o+":"),n=o),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(c.Ay.isString(t)){var o=t;t=function(e){return e.text===o}}return function n(o){var r,a,i;if(t(o))return o;for(r=0,a=o.children.length;r<a;r++)if(i=n(e.get_node(o.children[r])))return i;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(c.Ay.isString(e)){var t=e;e=k(t),b(e,"mug not found: "+t)}return 0===f()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return f()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:A().parseXML}}}]);