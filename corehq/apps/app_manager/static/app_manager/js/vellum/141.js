"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[141],{4141:(e,t,n)=>{n.r(t);var o=n(1134),r=n(8324),a=n.n(r),i=n(561),u=n.n(i),l=n(4523),s=n(3586),c=a().assert;describe("The commander plugin",(function(){var e,t;before((function(n){o.A.init({javaRosa:{langs:["en"]},features:{rich_text:!1},core:{onReady:function(){e=this,t=s.A.getQuestionMap(e),n()}}})})),beforeEach((function(){o.A.loadXML()})),l.Ay.each([{cmd:"text",type:"Text"},{cmd:"text before",type:"Text",index:3},{cmd:"text after",type:"Text",index:3,select:"group"},{cmd:"text before #form/group",type:"Text",index:0},{cmd:"Text after #form/group",type:"Text",index:3},{cmd:"Text in #form/group",type:"Text",index:3,indent:"  "},{cmd:"Text before #form/group/select",type:"Text",index:1,indent:"  "},{cmd:"Text after #form/group/select",type:"Text",index:3,indent:"  "},{cmd:"choice",type:"Choice",index:3,indent:"    ",select:"group/select"},{cmd:"Choice in #form/group/select",type:"Choice",index:3,indent:"    "},{cmd:"Choice first in #form/group/select",type:"Choice",index:2,indent:"    "}],(function(t){it("should add a "+t.type+" question with '"+t.cmd+"'",(function(){o.A.paste([["id","type","labelItext:en-default"],["/group","Group","group"],["/group/select","Select","select"],["/group/select/item","Choice","item"],["/text","Text","text"]]),t.select&&o.A.clickQuestion(t.select);var n=s.A.doCommand(t.cmd,e);c.isOk(n,"question not added"),u()("[name=property-nodeID]").val("new").change(),e.ensureCurrentMugIsSaved();var r=["group","  select","    item","text"];t.hasOwnProperty("index")?r.splice(t.index,0,(t.indent||"")+"new"):r.push("new"),o.A.assertJSTreeState.apply(null,r),c.equal(n.name,"add question"),c.equal(n.value.__className,t.type)}))})),l.Ay.each([{cmd:"text",type:"Text"},{cmd:"text before",type:"Text"},{cmd:"text after",type:"Text"},{cmd:"text in",type:"Text"},{cmd:"text first in",type:"Text"}],(function(t){it("should add a "+t.type+" question with '"+t.cmd+"' and empty tree",(function(){var n=s.A.doCommand(t.cmd,e);c.isOk(n,"question not added"),u()("[name=property-nodeID]").val("new").change(),e.ensureCurrentMugIsSaved(),o.A.assertJSTreeState("new"),c.equal(n.name,"add question"),c.equal(n.value.__className,t.type)}))})),l.Ay.each(["#form/group","#form/group/select","#form/text"],(function(t){it("should select "+t,(function(){o.A.paste([["id","type","labelItext:en-default"],["/group","Group","group"],["/group/select","Select","select"],["/group/select/item","Choice","item"],["/text","Text","text"]]);var n=s.A.doCommand(t,e);c.isOk(n,"question not selected"),c.equal(n.name,"select question");var r=e.getCurrentlySelectedMug();c.equal(r.hashtagPath,t)}))})),l.Ay.each(["choice","choice in #form/group"],(function(t){it("should not execute bad command: "+t,(function(){var n=s.A.doCommand(t,e);c.isUndefined(n,"unexpected result: "+n)}))})),l.Ay.each([["txt",[]],["cho",["Choice","Multiple Choice","Multiple Choice Lookup Table"]],["choice ",["...after","...before","...first in","...in","Multiple Choice Lookup Table"]],["choice i",["...in","...first in"]],["Date and Time ",["...after","...before","...first in","...in"]]],(function(n){var o=n[0],r=n[1];it("should get completions for: "+o,(function(){var n=l.Ay.map(r,(function(e){return e.startsWith("...")?{name:e.slice(3),icon:void 0,full:/^.+ /.exec(o)[0]+e.slice(3)}:{name:e,icon:t[e.toLowerCase()].icon,full:e}})),a=s.A.getCompletions(o,e);c.deepEqual(a,n)}))})),l.Ay.each([["txt",void 0],["Choice ",["Choice",void 0,void 0]],["Choice in ",["Choice","in",void 0]],["choice in /data/blue",["choice","in","/data/blue"]],["text first in #form/group",["text","first in","#form/group"]],["#form/blue",["#form/blue"]]],(function(t){var n=t[0],o=t[1];it("should tokenize: "+n,(function(){var t=s.A.tokenize(n,e);c.deepEqual(t&&t.tokens,o)}))})),l.Ay.each(["text","choice"],(function(t){it("should have '"+t+"' in it's question map",(function(){c.hasAnyKeys(s.A.getQuestionMap(e),[t])}))})),it("should not have 'itemset' in it's question map",(function(){c.doesNotHaveAnyKeys(s.A.getQuestionMap(e),["itemset"])})),it("select after add bug",(function(){o.A.paste([["id","type","labelItext:en-default"],["/text","Text","text"]]);var t=s.A.doCommand("Text after",e),n=t&&t.value;c.equal(t&&t.name,"add question"),u()("[name=itext-en-label]").val("text2").change(),c.equal(n.p.nodeID,void 0),t=s.A.doCommand("#form/text",e),c.equal(t&&t.name,"select question"),c.equal(n.p.nodeID,"text2"),t=s.A.doCommand("#form/text2",e),c.equal(t&&t.name,"select question")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>I});var o=n(8449),r=n(8324),a=n.n(r),i=n(6848),u=n.n(i),l=n(3794),s=n(4523),c=n(561),d=n.n(c),f=n(1437),p=n(3809),m=n(705),g=n(7229),h=(n(1460),n(9747),a().assert),v=["Form Builder clip","version 1"];function x(e,t,n){if((n=s.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=g.A.parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var r,a,i,l,c=(r=e,a=t,i=u().xml(r),l=u().xml(a),u().isEquivalent(i,l,{element_order:!0}));n.not&&(c=!c),c||y(e=A(e),t=A(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function y(e,t,n){if(e!==t){var o=(0,l.createPatch)("",e,t,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),h(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(o))}}function A(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function b(e){return w("getCurrentMugInput",e)}function q(e){var t=d()("#vellum").vellum("get"),n=s.Ay.isString(e)?d()("[name="+e+"]"):e;return m.A.util.getWidget(n,t)}function w(){var e=Array.prototype.slice.call(arguments),t=d()("#vellum");return t.vellum.apply(t,e)}function C(){var e=[],t=s.Ay.map(arguments,(function(t){var n=s.Ay.isString(t)?T(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return w("jstree","deselect_all",!0),w("jstree","select_node",t),d()(".collapse-toggle.collapsed").click(),e}function T(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=w("getMugByPath",e);if(!t){var n=e.split("/"),o=w("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var r=w("getData").core.form.getChildren(o),a=n[n.length-1];if(1===r.length&&"itemset"===a&&"itemset"===r[0].options.tagName)return r[0];for(var i=0;i<r.length;i++)if(r[i].p.nodeID===a)return r[i]}}return t}h.equal=h.strictEqual,h.notEqual=h.notStrictEqual;const I={options:o.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=d().extend(!0,{},o.A.options,e),n=d().fn.animate;d().fn.animate=function(e,t,o,r){n.apply(this,[e,0,o,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=s.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&s.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var a=d()("#vellum"),i=a.vellum("get");i&&(i.destroy(),d()("body > div.modal, body > div.modal-backdrop").remove()),a.empty().vellum(t)},call:w,loadXML:function(e,t,n,o,r=!0){var a=[],i=w("getData");return o||window.history.replaceState(null,null," "),i.core.parseWarnings=[],w("loadXML",e,t||{},{reset:r}),n?s.Ay.isRegExp(n)&&(a=s.Ay.filter(i.core.parseWarnings,(function(e){return!n.test(e)}))):a=i.core.parseWarnings,h(!a.length,"unexpected parse warnings:\n- "+a.join("\n- ")),delete i.core.parseWarnings,i.core.form},saveAndReload:function(e){w("loadXFormOrError",w("createXML"),e)},getMug:T,getInput:b,getWidget:q,getMediaUploader:function(e){var t,n={},o=q(e);if(!o)throw new Error("media uploader widget not found");if(s.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:o.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:y,assertInputCount:function(e,t,n){s.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=b(e)):n=n?" for "+n:"",h.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:x,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,x(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";y(function e(t,n){var o,r,a,i=[];for("#"===t.id?n=-1:i.push(Array(2*n+1).join(" ")+t.text),o=0,r=t.children.length;o<r;o++)a=w("jstree","get_node",t.children[o]),i.push(e(a,n+1));return i.join("\n")}(w("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";y(function e(t,n){var o,r,a,i=[];for(t.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+t.value.p.nodeID),o=0,r=t.children.length;o<r;o++)a=t.children[o],i.push(e(a,n+1));return i.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=s.Ay.extend({},n),this.prevId&&C(this.prevId);var o=w("addQuestion",e);return t||o.p.nodeID||(t=w("nodeIDFromLabel",o)),t&&(h(s.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),s.Ay.each(n,(function(e,t){s.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?o.p[t].set(e):o.p[t]=e})),s.Ay.each(w("getSections",o),(function(e){w("collapseSection",e.slug,!1)})),o},paste:function(e,t,n){s.Ay.isString(e)||(e=p.A.tabDelimit([v].concat(e))),n&&window.console.log(e),h.deepEqual(f.A.paste(e),t||[])},clickQuestion:C,selectAll:function(){w("jstree","select_all")},deleteQuestion:function(){var e=s.Ay.map(arguments,(function(e){var t=T(e);return h(t,"mug not found: "+e),t}));w("getData").core.form.removeMugsFromForm(e),s.Ay.each(arguments,(function(e){h(!T(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=w("getData").core.saveButton;if(!s.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),h.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){w("jstree","open_node",e.ufid),w("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){w("jstree","close_node",e.ufid),w("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(s.Ay.isString(e)){var o=e;e=T(o),h(e,"mug not found: "+o)}return e.messages.each((function(e,o){o!==n&&(t.push(o+":"),n=o),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(s.Ay.isString(t)){var o=t;t=function(e){return e.text===o}}return function n(o){var r,a,i;if(t(o))return o;for(r=0,a=o.children.length;r<a;r++)if(i=n(e.get_node(o.children[r])))return i;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(s.Ay.isString(e)){var t=e;e=T(t),h(e,"mug not found: "+t)}return 0===d()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return d()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:g.A.parseXML}}}]);