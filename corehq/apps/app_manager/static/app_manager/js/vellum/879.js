"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[879],{1879:(t,e,n)=>{var a=n(1134),s=n(8324),r=n.n(s),o=n(561),i=n.n(o),d=n(4523);const l='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<stock_amount />\n\t\t\t\t\t<balance xmlns="http://commcarehq.org/ledger/v1" entity-id="" date="" section-id="stock" type="bal-0">\n\t\t\t\t\t\t<entry id="" quantity="" />\n\t\t\t\t\t</balance>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="ledger" src="jr://instance/ledgerdb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<instance id="products" src="jr://fixture/commtrack:products" />\n\t\t\t<bind vellum:nodeset="#form/stock_amount" nodeset="/data/stock_amount" type="xsd:int" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']" vellum:relevant="#form/stock_amount != 0" relevant="/data/stock_amount != 0" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']/entry/@id" calculate="instance(\'commcaresession\')/session/data/product_id" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']/entry/@quantity" vellum:calculate="#form/stock_amount" calculate="/data/stock_amount" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']/@entity-id" calculate="instance(\'commcaresession\')/session/data/case_id" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']/@date" calculate="now()" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/stock_amount" ref="/data/stock_amount"/>\n\t</h:body>\n</h:html>\n',c='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<stock_amount />\n\t\t\t\t\t<balance xmlns="http://commcarehq.org/ledger/v1" entity-id="" date="" section-id="stock" type="bal-0">\n\t\t\t\t\t\t<entry id="" quantity="" />\n\t\t\t\t\t</balance>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="ledger" src="jr://instance/ledgerdb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<instance id="products" src="jr://fixture/commtrack:products" />\n\t\t\t<bind vellum:nodeset="#form/stock_amount" nodeset="/data/stock_amount" type="xsd:int" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']" vellum:relevant="#form/stock_amount != 0" relevant="/data/stock_amount != 0" />\n\t\t\t<bind nodeset="/data/balance[@type=\'bal-0\']/entry/@quantity" vellum:calculate="#form/stock_amount" calculate="/data/stock_amount" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/balance[@type=\'bal-0\']/entry/@id" value="instance(\'commcaresession\')/session/data/product_id" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/balance[@type=\'bal-0\']/@entity-id" value="instance(\'commcaresession\')/session/data/case_id" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/balance[@type=\'bal-0\']/@date" value="now()" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/stock_amount" ref="/data/stock_amount"/>\n\t</h:body>\n</h:html>\n',u='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<amount_received />\n\t\t\t\t\t<transfer xmlns="http://commcarehq.org/ledger/v1" src="" dest="" date="" section-id="stock" type="trans-1">\n\t\t\t\t\t\t<entry id="" quantity="" />\n\t\t\t\t\t</transfer>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="ledger" src="jr://instance/ledgerdb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<instance id="casedb" src="jr://instance/casedb" />\n\t\t\t<instance id="products" src="jr://fixture/commtrack:products" />\n\t\t\t<bind vellum:nodeset="#form/amount_received" nodeset="/data/amount_received" type="xsd:int" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']" relevant="true()" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/entry/@id" calculate="instance(\'commcaresession\')/session/data/product_id" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/entry/@quantity" vellum:calculate="#form/amount_received" calculate="/data/amount_received" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/@src" calculate="instance(\'commcaresession\')/session/data/case_id" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/@dest" calculate="instance(\'casedb\')/casedb/case[@case_id=instance(\'commcaresession\')/session/data/case_id]/index/parent" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/@date" calculate="now()" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/amount_received" ref="/data/amount_received"/>\n\t</h:body>\n</h:html>\n',m='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<amount_received />\n\t\t\t\t\t<transfer xmlns="http://commcarehq.org/ledger/v1" src="" dest="" date="" section-id="stock" type="trans-1">\n\t\t\t\t\t\t<entry id="" quantity="" />\n\t\t\t\t\t</transfer>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="ledger" src="jr://instance/ledgerdb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<instance id="casedb" src="jr://instance/casedb" />\n\t\t\t<instance id="products" src="jr://fixture/commtrack:products" />\n\t\t\t<bind vellum:nodeset="#form/amount_received" nodeset="/data/amount_received" type="xsd:int" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']" relevant="true()" />\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans-1\']/entry/@quantity" vellum:calculate="#form/amount_received" calculate="/data/amount_received" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/transfer[@type=\'trans-1\']/entry/@id" value="instance(\'commcaresession\')/session/data/product_id" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/transfer[@type=\'trans-1\']/@src" value="instance(\'commcaresession\')/session/data/case_id" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/transfer[@type=\'trans-1\']/@dest" value="instance(\'casedb\')/casedb/case[@case_id=instance(\'commcaresession\')/session/data/case_id]/index/parent" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/transfer[@type=\'trans-1\']/@date" value="now()" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/amount_received" ref="/data/amount_received"/>\n\t</h:body>\n</h:html>\n';var f=r().assert,p=a.A.call;describe("The CommTrack module",(function(){before((function(t){a.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){t()}}})})),it("should load a transfer block",(function(){a.A.loadXML(u);var t=a.A.getMug("transfer[@type='trans-1']");f.equal(t.p.sectionId,"stock"),f.equal(t.p.quantity,"/data/amount_received"),f.equal(t.p.entryId,"instance('commcaresession')/session/data/product_id"),f.equal(t.p.src,"instance('commcaresession')/session/data/case_id"),f.equal(t.p.dest,"instance('casedb')/casedb/case[@case_id=instance('commcaresession')/session/data/case_id]/index/parent"),f.equal(t.p.date,"now()"),f.equal(t.p.relevantAttr,"true()")})),it("should create a transfer block",(function(){a.A.loadXML(""),a.A.addQuestion("Int","amount_received");var t=a.A.addQuestion("Transfer","trans-1");t.p.sectionId="stock",t.p.quantity="/data/amount_received",t.p.entryId="instance('commcaresession')/session/data/product_id",t.p.src="instance('commcaresession')/session/data/case_id",t.p.dest="instance('casedb')/casedb/case[@case_id=instance('commcaresession')/session/data/case_id]/index/parent",t.p.relevantAttr="true()",t.form.addInstanceIfNotExists({id:"products",src:"jr://fixture/commtrack:products"}),t.form.addInstanceIfNotExists({id:"ledger",src:"jr://instance/ledgerdb"}),a.A.assertXmlEqual(p("createXML"),u,{normalize_xmlns:!0})})),it("should load a balance block",(function(){a.A.loadXML(l);var t=a.A.getMug("balance[@type='bal-0']");f.equal(t.p.sectionId,"stock"),f.equal(t.p.quantity,"/data/stock_amount"),f.equal(t.p.entityId,"instance('commcaresession')/session/data/case_id"),f.equal(t.p.entryId,"instance('commcaresession')/session/data/product_id"),f.equal(t.p.relevantAttr,"/data/stock_amount != 0")})),it("should create a balance block",(function(){a.A.loadXML(""),a.A.addQuestion("Int","stock_amount");var t=a.A.addQuestion("Balance","bal-0");t.p.sectionId="stock",t.p.quantity="/data/stock_amount",t.p.entityId="instance('commcaresession')/session/data/case_id",t.p.entryId="instance('commcaresession')/session/data/product_id",t.p.relevantAttr="/data/stock_amount != 0",t.form.addInstanceIfNotExists({id:"products",src:"jr://fixture/commtrack:products"}),t.form.addInstanceIfNotExists({id:"ledger",src:"jr://instance/ledgerdb"}),a.A.assertXmlEqual(p("createXML"),l,{normalize_xmlns:!0})})),it("transfer question should not be valid when src and dest are both empty",(function(){a.A.loadXML();var t=a.A.addQuestion("Transfer","t1");f.strictEqual(t.p.src,""),f.strictEqual(t.p.dest,""),t.validate(),f(!a.A.isTreeNodeValid(t),"Transfer question with empty src and dest should be invalid"),f(t.messages.get("src").length,"src should have messages"),f(t.messages.get("dest").length,"dest should have messages")})),it("new transfer question should not have validation errors",(function(){a.A.loadXML();var t=a.A.addQuestion("Transfer","t1");f.strictEqual(t.p.src,""),f.strictEqual(t.p.dest,""),f.deepEqual(a.A.getMessages(t),"")})),it("should show error icon in tree on load invalid transfer question",(function(){a.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/A5FFD0C5-2B9A-490D-9B6C-6503CDE0EF0F" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<transfer date="" xmlns="http://commcarehq.org/ledger/v1" type="trans" section-id="" vellum:role="Transfer">\n\t\t\t\t\t\t<entry id="" quantity="" />\n\t\t\t\t\t</transfer>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/ledgerdb" id="ledger"></instance>\n\t\t\t<bind nodeset="/data/transfer[@type=\'trans\']/entry/@quantity" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/transfer[@type=\'trans\']/@date" value="/data/meta/timeEnd" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body />\n</h:html>\n');var t=a.A.getMug("transfer[@type='trans']");f(!a.A.isTreeNodeValid(t),"tree node should not be valid")})),it("should create two transfer blocks with the same parent node",(function(){a.A.loadXML(),a.A.addQuestion("Transfer","t1").p.src="value",a.A.addQuestion("Transfer","t2").p.src="value";var t=a.A.call("createXML"),e=a.A.parseXML(t);f.equal(e.find("transfer").length,2,t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t1\\']/@src']").length,1,t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t2\\']/@src']").length,1,t)})),describe("transfer question",(function(){var t;before((function(){a.A.loadXML(),t=a.A.addQuestion("Transfer","t1")})),it("with missing src and dest should not be valid",(function(){t.p.src="",t.p.dest="",t.validate(),f.notDeepEqual(t.getErrors(),[],"Transfer with missing src should not be valid")})),it("with missing src should not be valid",(function(){t.p.src="",t.p.dest="something",t.validate(),f.notDeepEqual(t.getErrors(),[],"Transfer with missing src should not be valid")})),it("with missing dest should not be valid",(function(){t.p.src="something",t.p.dest="",t.validate(),f.notDeepEqual(t.getErrors(),[],"Transfer with missing dest should not be valid")})),it("with both src and dest should be valid",(function(){t.p.src="something",t.p.dest="something",t.validate(),f.deepEqual(t.getErrors(),[])}))})),it("dispense question should omit dest",(function(){a.A.loadXML(),a.A.addQuestion("Dispense","t1").p.src="something";var t=a.A.call("createXML"),e=a.A.parseXML(t);f.strictEqual(e.find("transfer[type='t1']").attr("src"),"","unexpected transfer src attribute\n"+t),f.isUndefined(e.find("transfer[type='t1']").attr("dest"),"unexpected transfer dest attribute\n"+t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t1\\']/@src']").length,1,"unexpected @src bind:\n"+t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t1\\']/@dest']").length,0,"unexpected @dest bind:\n"+t)})),it("receive question should omit src",(function(){a.A.loadXML(),a.A.addQuestion("Receive","t1").p.dest="something";var t=a.A.call("createXML"),e=a.A.parseXML(t);f.isUndefined(e.find("transfer[type='t1']").attr("src"),"unexpected transfer src attribute\n"+t),f.strictEqual(e.find("transfer[type='t1']").attr("dest"),"","unexpected transfer dest attribute\n"+t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t1\\']/@src']").length,0,"unexpected @src bind:\n"+t),f.equal(e.find("bind[nodeset='/data/transfer[@type=\\'t1\\']/@dest']").length,1,"unexpected @dest bind:\n"+t)})),it("transfer block with src and dest should load as Transfer question",(function(){a.A.loadXML(u);var t=a.A.getMug("transfer[@type='trans-1']");f.equal(t.__className,"Transfer")})),it("transfer block with dest only should load as Receive question",(function(){a.A.loadXML(u.replace(' src=""',"").replace(/<bind [^>]*@src[^>]*\/>/,""));var t=a.A.getMug("transfer[@type='trans-1']");f.equal(t.__className,"Receive")})),it("transfer block with src only should load as Dispense question",(function(){a.A.loadXML(u.replace(' dest=""',"").replace(/<bind [^>]*@dest[^>]*\/>/,""));var t=a.A.getMug("transfer[@type='trans-1']");f.equal(t.__className,"Dispense")})),it("should enable save button when a transfer's source or destination changes",(function(t){a.A.loadXML(u),a.A.saveButtonEnabled(!1),a.A.clickQuestion("transfer[@type='trans-1']");var e=a.A.getWidget("property-dest"),n=e.input.data("editorWrapper");e.input.promise.then((function(){n.on("change",(function(){f(a.A.saveButtonEnabled(),"save button is disabled"),t()})),e.input[0].dispatchEvent(new Event("input",{bubbles:!0,cancelable:!1}))}))})),it("transfer quantity should update on reference rename",(function(){a.A.loadXML(u);var t=a.A.getMug("amount_received"),e=a.A.getMug("transfer[@type='trans-1']");t.p.nodeID="amount_received_x",f.equal(e.p.quantity,t.hashtagPath)})),it("transfer quantity should update multiple refs on reference rename",(function(){a.A.loadXML(u);var t=a.A.getMug("amount_received"),e=a.A.getMug("transfer[@type='trans-1']");f.equal(e.p.quantity,t.absolutePath),e.p.quantity=[t.absolutePath,t.absolutePath].join(" + "),t.p.nodeID="amount_rx",f.equal(e.p.quantity,[t.hashtagPath,t.hashtagPath].join(" + "))})),d.Ay.each(["Balance","Transfer","Dispense","Receive"],(function(t){it("should add ledger instance on add "+t+" question",(function(){a.A.loadXML(""),a.A.addQuestion(t,"question");var e=a.A.call("createXML"),n=a.A.parseXML(e);f.equal(n.find("instance[src='jr://instance/ledgerdb']").length,1,"wrong ledger instance count\n"+e)})),it("should remove ledger instance on delete "+t+" question",(function(){a.A.loadXML("");var e=a.A.addQuestion(t,"question");a.A.deleteQuestion(e.absolutePath);var n=a.A.call("createXML"),s=a.A.parseXML(n);f.equal(s.find("instance[src='jr://instance/ledgerdb']").length,0,"ledger instance should be removed\n"+n)}))})),d.Ay.each(["Balance","Transfer"],(function(t){it("should change "+t+" setvalues to binds on load+save",(function(){var e="Transfer"===t;a.A.loadXML(e?m:c),a.A.assertXmlEqual(p("createXML"),e?u:l,{normalize_xmlns:!0})})),it("should remove ledger instance on delete "+t+" loaded from XML",(function(){var e="Transfer"===t;a.A.loadXML(e?u:l);var n=a.A.getMug(e?"transfer[@type='trans-1']":"balance[@type='bal-0']");a.A.deleteQuestion(n.absolutePath);var s=a.A.call("createXML"),r=a.A.parseXML(s);f.equal(r.find("instance[src='jr://instance/ledgerdb']").length,0,"ledger instance should be removed\n"+s)})),it("should drop bind and setvalue nodes on delete "+t+" question",(function(){var e="Transfer"===t;a.A.loadXML(e?m:c);var n=a.A.getMug(e?"transfer[@type='trans-1']":"balance[@type='bal-0']");a.A.deleteQuestion(n.absolutePath);var s=a.A.call("createXML"),r=a.A.parseXML(s);f.equal(r.find("bind").filter((function(){return/^\/data\/(balance|transfer)\[/.test(i()(this).attr("nodeset"))})).length,0,"bind nodes should be removed\n"+s),f.equal(r.find("setvalue").length,0,"setvalue nodes should be removed\n"+s)}))})),it("should not remove ledger instance on delete second Transfer question",(function(){a.A.loadXML(""),a.A.addQuestion("Transfer","trans");var t=a.A.addQuestion("Transfer","question");a.A.deleteQuestion(t.absolutePath);var e=a.A.call("createXML"),n=a.A.parseXML(e);f.equal(n.find("instance[src='jr://instance/ledgerdb']").length,1,"ledger instance should be removed\n"+e)})),it("should show 'Case' property for Balance",(function(){a.A.loadXML(""),a.A.addQuestion("Balance","bal"),f.equal(i()("[name=property-entityId]").length,1)})),describe("should properly encode",(function(){var t={Transfer:u,Dispense:u.replace(' dest=""',"").replace(/<bind [^>]*@dest[^>]*\/>/,""),Receive:u.replace(' src=""',"").replace(/<bind [^>]*@src[^>]*\/>/,"")};d.Ay.each([{from:"Transfer",to:"Dispense"},{from:"Transfer",to:"Receive"},{from:"Dispense",to:"Transfer"},{from:"Dispense",to:"Receive"},{from:"Receive",to:"Transfer"},{from:"Receive",to:"Dispense"}],(function(e){it(e.from+" changed to "+e.to,(function(){var n=a.A.loadXML(t[e.from]),s=a.A.getMug("transfer[@type='trans-1']"),r="Transfer"===e.to||"Dispense"===e.to,o="Transfer"===e.to||"Receive"===e.to;if(f.equal(s.__className,e.from),p("changeMugType",s,e.to),r&&(s.p.src="instance('commcaresession')/session/data/case_id"),o){s.p.dest="instance('casedb')/casedb/case[@case_id=instance('commcaresession')/session/data/case_id]/index/parent";var i=n.instanceMetadata,d=i.length-1;"casedb"===i[d].attributes.id&&(i[d]=i.splice(d-1,1,i[d])[0])}var l=a.A.call("createXML");a.A.assertXmlEqual(l,t[e.to],{normalize_xmlns:!0}),a.A.loadXML(l),s=a.A.getMug("transfer[@type='trans-1']"),f.equal(s.__className,e.to)}))}))}))}))},1134:(t,e,n)=>{n.d(e,{A:()=>j});var a=n(8449),s=n(8324),r=n.n(s),o=n(6848),i=n.n(o),d=n(3794),l=n(4523),c=n(561),u=n.n(c),m=n(1437),f=n(3809),p=n(705),h=n(7229),v=(n(1460),n(9747),r().assert),g=["Form Builder clip","version 1"];function b(t,e,n){if((n=l.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=h.A.parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var s,r,o,d,c=(s=t,r=e,o=i().xml(s),d=i().xml(r),i().isEquivalent(o,d,{element_order:!0}));n.not&&(c=!c),c||y(t=x(t),e=x(e),"XML "+(n.not?"should not be equivalent":"mismatch"))}function y(t,e,n){if(t!==e){var a=(0,d.createPatch)("",t,e,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),v(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(a))}}function x(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function A(t){return w("getCurrentMugInput",t)}function q(t){var e=u()("#vellum").vellum("get"),n=l.Ay.isString(t)?u()("[name="+t+"]"):t;return p.A.util.getWidget(n,e)}function w(){var t=Array.prototype.slice.call(arguments),e=u()("#vellum");return e.vellum.apply(e,t)}function _(){var t=[],e=l.Ay.map(arguments,(function(e){var n=l.Ay.isString(e)?M(e):e;if(!n||!n.ufid)throw new Error("mug not found: "+e);return t.push(n),n.ufid}));return w("jstree","deselect_all",!0),w("jstree","select_node",e),u()(".collapse-toggle.collapsed").click(),t}function M(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=w("getMugByPath",t);if(!e){var n=t.split("/"),a=w("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var s=w("getData").core.form.getChildren(a),r=n[n.length-1];if(1===s.length&&"itemset"===r&&"itemset"===s[0].options.tagName)return s[0];for(var o=0;o<s.length;o++)if(s[o].p.nodeID===r)return s[o]}}return e}v.equal=v.strictEqual,v.notEqual=v.notStrictEqual;const j={options:a.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=u().extend(!0,{},a.A.options,t),n=u().fn.animate;u().fn.animate=function(t,e,a,s){n.apply(this,[t,0,a,s])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=l.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&l.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var s=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,s(t)};var r=u()("#vellum"),o=r.vellum("get");o&&(o.destroy(),u()("body > div.modal, body > div.modal-backdrop").remove()),r.empty().vellum(e)},call:w,loadXML:function(t,e,n,a,s=!0){var r=[],o=w("getData");return a||window.history.replaceState(null,null," "),o.core.parseWarnings=[],w("loadXML",t,e||{},{reset:s}),n?l.Ay.isRegExp(n)&&(r=l.Ay.filter(o.core.parseWarnings,(function(t){return!n.test(t)}))):r=o.core.parseWarnings,v(!r.length,"unexpected parse warnings:\n- "+r.join("\n- ")),delete o.core.parseWarnings,o.core.form},saveAndReload:function(t){w("loadXFormOrError",w("createXML"),t)},getMug:M,getInput:A,getWidget:q,getMediaUploader:function(t){var e,n={},a=q(t);if(!a)throw new Error("media uploader widget not found");if(l.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(e=t.closest(n)).length})),!e)throw new Error("media uploader element not found");return n.upload=function(t){var n={ref:{path:a.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",n)},n},assertEqual:y,assertInputCount:function(t,e,n){l.Ay.isString(t)?(n=" for "+(n?n+" ":"")+t,t=A(t)):n=n?" for "+n:"",v.equal(t.length,e,"wrong number of inputs"+n)},assertXmlEqual:b,assertXmlNotEqual:function(t,e,n){(n=n||{}).not=!0,b(t,e,n)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";y(function t(e,n){var a,s,r,o=[];for("#"===e.id?n=-1:o.push(Array(2*n+1).join(" ")+e.text),a=0,s=e.children.length;a<s;a++)r=w("jstree","get_node",e.children[a]),o.push(t(r,n+1));return o.join("\n")}(w("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";y(function t(e,n){var a,s,r,o=[];for(e.isRootNode?n=-1:o.push(Array(2*n+1).join(" ")+e.value.p.nodeID),a=0,s=e.children.length;a<s;a++)r=e.children[a],o.push(t(r,n+1));return o.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,n){n=l.Ay.extend({},n),this.prevId&&_(this.prevId);var a=w("addQuestion",t);return e||a.p.nodeID||(e=w("nodeIDFromLabel",a)),e&&(v(l.Ay.isUndefined(n.nodeID),"unexpected attribute for "+t+"["+e+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=e,"Choice"!==t||n.hasOwnProperty("labelItext")||(n.labelItext=e)),l.Ay.each(n,(function(t,e){l.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?a.p[e].set(t):a.p[e]=t})),l.Ay.each(w("getSections",a),(function(t){w("collapseSection",t.slug,!1)})),a},paste:function(t,e,n){l.Ay.isString(t)||(t=f.A.tabDelimit([g].concat(t))),n&&window.console.log(t),v.deepEqual(m.A.paste(t),e||[])},clickQuestion:_,selectAll:function(){w("jstree","select_all")},deleteQuestion:function(){var t=l.Ay.map(arguments,(function(t){var e=M(t);return v(e,"mug not found: "+t),e}));w("getData").core.form.removeMugsFromForm(t),l.Ay.each(arguments,(function(t){v(!M(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=w("getData").core.saveButton;if(!l.Ay.isUndefined(t)){var n=t?"save":"saved";e.setStateWhenReady(n),v.equal(e.state,n,"sanity check failed")}return"save"===e.state},expandGroup:function(t){w("jstree","open_node",t.ufid),w("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){w("jstree","close_node",t.ufid),w("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],n=null;if(l.Ay.isString(t)){var a=t;t=M(a),v(t,"mug not found: "+a)}return t.messages.each((function(t,a){a!==n&&(e.push(a+":"),n=a),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,n){if(l.Ay.isString(e)){var a=e;e=function(t){return t.text===a}}return function n(a){var s,r,o;if(e(a))return a;for(s=0,r=a.children.length;s<r;s++)if(o=n(t.get_node(a.children[s])))return o;return null}(n||t.get_node("#"))},isTreeNodeValid:function(t){if(l.Ay.isString(t)){var e=t;t=M(e),v(t,"mug not found: "+e)}return 0===u()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return u()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:h.A.parseXML}}}]);