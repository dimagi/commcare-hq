"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[395],{395:(t,e,n)=>{n.r(e);var a=n(1134),r=n(8324),s=n.n(r),o=n(561),i=n.n(o),l=n(4523),u=n(2295),c=n(3220),d=s().assert,m=a.A.call,f=a.A.clickQuestion,p=l.Ay.union(a.A.options.options.plugins||[],["itemset"]);describe("The Advanced Itemset plugin",(function(){function t(t){a.A.init({plugins:p,javaRosa:{langs:["en"]},core:{onReady:function(){t()}},features:{advanced_itemsets:!0}})}before(t),it("adds a new instance node to the form when necessary",(function(){a.A.loadXML(u),a.A.getMug("question1/itemset").p.itemsetData={instance:{id:"somefixture",src:"jr://somefixture"},nodeset:"instance('somefixture')/some/items",labelRef:"label",valueRef:"value"};var t=m("createXML"),e=a.A.parseXML(t);d(e.find("instance[id=somefixture]").length,"somefixture instance not found:\n"+t)})),it("renames instance on add itemset with matching instance",(function(){a.A.loadXML(u),a.A.addQuestion("SelectDynamic","select2");var t=a.A.getMug("select2/itemset");t.p.itemsetData={instance:{id:"cases",src:"jr://instance/casedb"},nodeset:"instance('cases')/cases/case[@case_id > 2]",labelRef:"label",valueRef:"value"};var e=t.p.itemsetData;d.equal(e.instance.id,"casedb"),d.equal(e.instance.src,"jr://instance/casedb"),d.equal(e.nodeset,"instance('casedb')/cases/case[@case_id > 2]");var n=m("createXML"),r=a.A.parseXML(n);d(r.find("instance[id=casedb]").length,"casedb instance not found:\n"+n),d(0===r.find("instance[id=cases]").length,"cases instance should have been renamed/merged:\n"+n)})),describe("parsing and serializing",(function(){before(t),it("preserves XML with itemsets in <select>s",(function(){d(-1!==u.indexOf("select1")),a.A.loadXML(u),a.A.assertXmlEqual(m("createXML"),u)})),it("preserves XML with itemsets in <select1>s",(function(){var t=u.replace(/select1/g,"select");a.A.loadXML(t),a.A.assertXmlEqual(m("createXML"),t)}))})),describe("UI",(function(){before(t),it("preserves inner filters if you never change the data source",(function(){a.A.loadXML(c),f("question2/itemset"),i()("[name=property-labelRef]").val("dummy").change(),a.A.assertXmlEqual(c.replace("case_name","dummy"),m("createXML"))})),it("includes filter when in advanced mode",(function(){a.A.loadXML(u),f("question1/itemset");var t=a.A.getMug("question1/itemset");t.p.filter="'blah' = /data/question2",i()("button:contains(...)").click(),d(i()("[name=query]").val().indexOf(t.p.filter)>1)})),it("changes filter when in advanced mode",(function(){a.A.loadXML(u),f("question1/itemset");var t=a.A.getMug("question1/itemset");t.p.filter="'blah' = /data/question2",i()("button:contains(...)").click();var e=i()("[name=query]").val();i()("[name=query]").val(e.replace(/question2/,"no_question")).change(),i()(".fd-data-source-save-button").click(),d.strictEqual(t.p.filter,"'blah' = /data/no_question")}))}))}))},1134:(t,e,n)=>{n.d(e,{A:()=>D});var a=n(8449),r=n(8324),s=n.n(r),o=n(6848),i=n.n(o),l=n(3794),u=n.n(l),c=n(4523),d=n(561),m=n.n(d),f=n(1437),p=n.n(f),g=n(3809),h=n.n(g),v=n(705),x=n.n(v),b=n(7229),y=n.n(b),q=(n(1460),n(8803),s().assert),A=["Form Builder clip","version 1"];function w(t,e,n){if((n=c.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=y().parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var r,s,o,l,u=(r=t,s=e,o=i().xml(r),l=i().xml(s),i().isEquivalent(o,l,{element_order:!0}));n.not&&(u=!u),u||j(t=M(t),e=M(e),"XML "+(n.not?"should not be equivalent":"mismatch"))}function j(t,e,n){if(t!==e){var a=u().createPatch("",t,e,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),q(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(a))}}function M(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function _(t){return L("getCurrentMugInput",t)}function X(t){var e=m()("#vellum").vellum("get"),n=c.Ay.isString(t)?m()("[name="+t+"]"):t;return x().util.getWidget(n,e)}function L(){var t=Array.prototype.slice.call(arguments),e=m()("#vellum");return e.vellum.apply(e,t)}function E(){var t=[],e=c.Ay.map(arguments,(function(e){var n=c.Ay.isString(e)?S(e):e;if(!n||!n.ufid)throw new Error("mug not found: "+e);return t.push(n),n.ufid}));return L("jstree","deselect_all",!0),L("jstree","select_node",e),m()(".collapse-toggle.collapsed").click(),t}function S(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=L("getMugByPath",t);if(!e){var n=t.split("/"),a=L("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var r=L("getData").core.form.getChildren(a),s=n[n.length-1];if(1===r.length&&"itemset"===s&&"itemset"===r[0].options.tagName)return r[0];for(var o=0;o<r.length;o++)if(r[o].p.nodeID===s)return r[o]}}return e}q.equal=q.strictEqual,q.notEqual=q.notStrictEqual;const D={options:a.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=m().extend(!0,{},a.A.options,t),n=m().fn.animate;m().fn.animate=function(t,e,a,r){n.apply(this,[t,0,a,r])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=c.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&c.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var r=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,r(t)};var s=m()("#vellum"),o=s.vellum("get");o&&(o.destroy(),m()("body > div.modal, body > div.modal-backdrop").remove()),s.empty().vellum(e)},call:L,loadXML:function(t,e,n,a,r=!0){var s=[],o=L("getData");return a||window.history.replaceState(null,null," "),o.core.parseWarnings=[],L("loadXML",t,e||{},{reset:r}),n?c.Ay.isRegExp(n)&&(s=c.Ay.filter(o.core.parseWarnings,(function(t){return!n.test(t)}))):s=o.core.parseWarnings,q(!s.length,"unexpected parse warnings:\n- "+s.join("\n- ")),delete o.core.parseWarnings,o.core.form},saveAndReload:function(t){L("loadXFormOrError",L("createXML"),t)},getMug:S,getInput:_,getWidget:X,getMediaUploader:function(t){var e,n={},a=X(t);if(!a)throw new Error("media uploader widget not found");if(c.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(e=t.closest(n)).length})),!e)throw new Error("media uploader element not found");return n.upload=function(t){var n={ref:{path:a.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",n)},n},assertEqual:j,assertInputCount:function(t,e,n){c.Ay.isString(t)?(n=" for "+(n?n+" ":"")+t,t=_(t)):n=n?" for "+n:"",q.equal(t.length,e,"wrong number of inputs"+n)},assertXmlEqual:w,assertXmlNotEqual:function(t,e,n){(n=n||{}).not=!0,w(t,e,n)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";j(function t(e,n){var a,r,s,o=[];for("#"===e.id?n=-1:o.push(Array(2*n+1).join(" ")+e.text),a=0,r=e.children.length;a<r;a++)s=L("jstree","get_node",e.children[a]),o.push(t(s,n+1));return o.join("\n")}(L("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";j(function t(e,n){var a,r,s,o=[];for(e.isRootNode?n=-1:o.push(Array(2*n+1).join(" ")+e.value.p.nodeID),a=0,r=e.children.length;a<r;a++)s=e.children[a],o.push(t(s,n+1));return o.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,n){n=c.Ay.extend({},n),this.prevId&&E(this.prevId);var a=L("addQuestion",t);return e||a.p.nodeID||(e=L("nodeIDFromLabel",a)),e&&(q(c.Ay.isUndefined(n.nodeID),"unexpected attribute for "+t+"["+e+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=e,"Choice"!==t||n.hasOwnProperty("labelItext")||(n.labelItext=e)),c.Ay.each(n,(function(t,e){c.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?a.p[e].set(t):a.p[e]=t})),c.Ay.each(L("getSections",a),(function(t){L("collapseSection",t.slug,!1)})),a},paste:function(t,e,n){c.Ay.isString(t)||(t=h().tabDelimit([A].concat(t))),n&&window.console.log(t),q.deepEqual(p().paste(t),e||[])},clickQuestion:E,selectAll:function(){L("jstree","select_all")},deleteQuestion:function(){var t=c.Ay.map(arguments,(function(t){var e=S(t);return q(e,"mug not found: "+t),e}));L("getData").core.form.removeMugsFromForm(t),c.Ay.each(arguments,(function(t){q(!S(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=L("getData").core.saveButton;if(!c.Ay.isUndefined(t)){var n=t?"save":"saved";e.setStateWhenReady(n),q.equal(e.state,n,"sanity check failed")}return"save"===e.state},expandGroup:function(t){L("jstree","open_node",t.ufid),L("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){L("jstree","close_node",t.ufid),L("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],n=null;if(c.Ay.isString(t)){var a=t;t=S(a),q(t,"mug not found: "+a)}return t.messages.each((function(t,a){a!==n&&(e.push(a+":"),n=a),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,n){if(c.Ay.isString(e)){var a=e;e=function(t){return t.text===a}}return function n(a){var r,s,o;if(e(a))return a;for(r=0,s=a.children.length;r<s;r++)if(o=n(t.get_node(a.children[r])))return o;return null}(n||t.get_node("#"))},isTreeNodeValid:function(t){if(c.Ay.isString(t)){var e=t;t=S(e),q(t,"mug not found: "+e)}return 0===m()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return m()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:y().parseXML}},3220:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/4BE1309B-ABCF-4184-8175-9E381F3E0DD7" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<question2 />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://fixture/some-fixture" id="somefixture" />\n\t\t\t<bind vellum:nodeset="#form/question2" nodeset="/data/question2" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="question2-label">\n\t\t\t\t\t\t<value>question2</value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<select1 vellum:ref="#form/question2" ref="/data/question2">\n\t\t\t<label ref="jr:itext(\'question2-label\')" />\n\t\t\t<itemset nodeset="instance(\'somefixture\')/foos/foo[@foo_type=\'woo\'][1=2]/bar[@bar_type=\'eggs\']">\n\t\t\t\t<label ref="case_name" />\n\t\t\t\t<value ref="@case_id" />\n\t\t\t</itemset>\n\t\t</select1>\n\t</h:body>\n\t<case_mappings />\n</h:html>\n'},2295:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/4BE1309B-ABCF-4184-8175-9E381F3E0DD7" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<question1 />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<bind vellum:nodeset="#form/question1" nodeset="/data/question1" constraint="1 = 1" jr:constraintMsg="jr:itext(\'question1-constraintMsg\')" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="question1-label">\n\t\t\t\t\t\t<value>question1</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="question1-constraintMsg">\n\t\t\t\t\t\t<value>constraint</value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<select1 vellum:ref="#form/question1" ref="/data/question1">\n\t\t\t<label ref="jr:itext(\'question1-label\')" />\n\t\t\t<alert ref="jr:itext(\'question1-constraintMsg\')" />\n\t\t\t<itemset nodeset="instance(\'casedb\')/casedb/case[@case_type=\'mother\']">\n\t\t\t\t<label ref="case_name" />\n\t\t\t\t<value ref="@case_id" />\n\t\t\t</itemset>\n\t\t</select1>\n\t</h:body>\n\t<case_mappings />\n</h:html>\n'}}]);