"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[358],{358:(e,t,n)=>{n.r(t);var o=n(8324),r=n.n(o),i=n(1134),c=n(561),s=n.n(c),a=r().assert;describe("The undo manager",(function(){before((function(e){i.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!1}})})),beforeEach((function(){i.A.loadXML("")})),it("should show an alert when deleting questions",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click(),a(s()(".fd-undo-delete").length)})),it("should undelete one question properly",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),a(!0,"Woo! text restored")})),it("should undelete two questions properly",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text","text2"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete a nested question properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group/text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group"),s()(".fd-button-remove").click(),i.A.assertJSTreeState();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a nested group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Group","group2"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  group2","    text2"),i.A.clickQuestion("group/group2"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("group");try{i.A.clickQuestion("group2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/group2/text2"),i.A.assertJSTreeState("group","  group2","    text2")})),it("should undelete a question with question after it",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete the first question",(function(){i.A.addQuestion("Text","text"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),a(!s()(".fd-default-panel").is(":visible"),"New Form dialog showing"),i.A.assertJSTreeState("text")})),it("should undelete a multiple choice question with correct number of children",(function(){i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should undelete multiple questions when selected out of order",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.addQuestion("Text","text3"),i.A.clickQuestion("text3","text2"),i.A.assertJSTreeState("text","text2","text3"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("text"),s()(".fd-undo").click(),i.A.assertJSTreeState("text","text2","text3")})),it("should reset the undo manager after a delete",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.clickQuestion("select"),s()(".fd-button-remove").click(),i.A.assertJSTreeState(),s()(".fd-undo").click(),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should reset the undo manager after adding a question",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.addQuestion("Text","text"),a.strictEqual(s()(".fd-undo-delete").length,0)})),it("should undelete a multiple choice question when selected with others",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("text","select"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("text","select","  choice1","  choice2")})),it("should adjust the tree's height to accommodate the undo alert message",(function(){var e=function(){return s()(".fd-tree .fd-scrollable").outerHeight()};i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.clickQuestion("text");var t=e();s()(".fd-button-remove").click();var n=e();a(n!==t,"Height changed with addition of alert."),s()(".fd-undo").click(),a(e()===t,"Height restored after undoing deletion."),s()(".fd-button-remove").click(),a(e()===n,"Height changed with addition of alert."),s()(".fd-undo-delete .close").click(),a(e()===t,"Height restored after closing alert.")})),it("should fix broken references on undelete referenced question",(function(){i.A.addQuestion("Text","red");var e=i.A.addQuestion("Text","blue",{relevantAttr:"#form/red = '1'"});i.A.deleteQuestion("red"),a(!i.A.isTreeNodeValid(e),"blue should have reference error"),e.form.undo(),a(i.A.isTreeNodeValid(e),"blue should be valid")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>_});var o=n(8449),r=n(8324),i=n.n(r),c=n(6848),s=n.n(c),a=n(3794),u=n(4523),l=n(561),d=n.n(l),f=n(1437),h=n.n(f),p=n(3809),x=n.n(p),A=n(705),g=n.n(A),m=n(7229),v=n.n(m),k=(n(1460),n(8803),i().assert),S=["Form Builder clip","version 1"];function Q(e,t,n){if((n=u.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=v().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var r,i,c,a,l=(r=e,i=t,c=s().xml(r),a=s().xml(i),s().isEquivalent(c,a,{element_order:!0}));n.not&&(l=!l),l||y(e=b(e),t=b(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function y(e,t,n){if(e!==t){var o=(0,a.createPatch)("",e,t,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),k(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(o))}}function b(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function T(e){return J("getCurrentMugInput",e)}function w(e){var t=d()("#vellum").vellum("get"),n=u.Ay.isString(e)?d()("[name="+e+"]"):e;return g().util.getWidget(n,t)}function J(){var e=Array.prototype.slice.call(arguments),t=d()("#vellum");return t.vellum.apply(t,e)}function q(){var e=[],t=u.Ay.map(arguments,(function(t){var n=u.Ay.isString(t)?j(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return J("jstree","deselect_all",!0),J("jstree","select_node",t),d()(".collapse-toggle.collapsed").click(),e}function j(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=J("getMugByPath",e);if(!t){var n=e.split("/"),o=J("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var r=J("getData").core.form.getChildren(o),i=n[n.length-1];if(1===r.length&&"itemset"===i&&"itemset"===r[0].options.tagName)return r[0];for(var c=0;c<r.length;c++)if(r[c].p.nodeID===i)return r[c]}}return t}k.equal=k.strictEqual,k.notEqual=k.notStrictEqual;const _={options:o.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=d().extend(!0,{},o.A.options,e),n=d().fn.animate;d().fn.animate=function(e,t,o,r){n.apply(this,[e,0,o,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=u.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&u.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var i=d()("#vellum"),c=i.vellum("get");c&&(c.destroy(),d()("body > div.modal, body > div.modal-backdrop").remove()),i.empty().vellum(t)},call:J,loadXML:function(e,t,n,o,r=!0){var i=[],c=J("getData");return o||window.history.replaceState(null,null," "),c.core.parseWarnings=[],J("loadXML",e,t||{},{reset:r}),n?u.Ay.isRegExp(n)&&(i=u.Ay.filter(c.core.parseWarnings,(function(e){return!n.test(e)}))):i=c.core.parseWarnings,k(!i.length,"unexpected parse warnings:\n- "+i.join("\n- ")),delete c.core.parseWarnings,c.core.form},saveAndReload:function(e){J("loadXFormOrError",J("createXML"),e)},getMug:j,getInput:T,getWidget:w,getMediaUploader:function(e){var t,n={},o=w(e);if(!o)throw new Error("media uploader widget not found");if(u.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:o.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:y,assertInputCount:function(e,t,n){u.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=T(e)):n=n?" for "+n:"",k.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:Q,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,Q(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";y(function e(t,n){var o,r,i,c=[];for("#"===t.id?n=-1:c.push(Array(2*n+1).join(" ")+t.text),o=0,r=t.children.length;o<r;o++)i=J("jstree","get_node",t.children[o]),c.push(e(i,n+1));return c.join("\n")}(J("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";y(function e(t,n){var o,r,i,c=[];for(t.isRootNode?n=-1:c.push(Array(2*n+1).join(" ")+t.value.p.nodeID),o=0,r=t.children.length;o<r;o++)i=t.children[o],c.push(e(i,n+1));return c.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=u.Ay.extend({},n),this.prevId&&q(this.prevId);var o=J("addQuestion",e);return t||o.p.nodeID||(t=J("nodeIDFromLabel",o)),t&&(k(u.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),u.Ay.each(n,(function(e,t){u.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?o.p[t].set(e):o.p[t]=e})),u.Ay.each(J("getSections",o),(function(e){J("collapseSection",e.slug,!1)})),o},paste:function(e,t,n){u.Ay.isString(e)||(e=x().tabDelimit([S].concat(e))),n&&window.console.log(e),k.deepEqual(h().paste(e),t||[])},clickQuestion:q,selectAll:function(){J("jstree","select_all")},deleteQuestion:function(){var e=u.Ay.map(arguments,(function(e){var t=j(e);return k(t,"mug not found: "+e),t}));J("getData").core.form.removeMugsFromForm(e),u.Ay.each(arguments,(function(e){k(!j(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=J("getData").core.saveButton;if(!u.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),k.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){J("jstree","open_node",e.ufid),J("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){J("jstree","close_node",e.ufid),J("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(u.Ay.isString(e)){var o=e;e=j(o),k(e,"mug not found: "+o)}return e.messages.each((function(e,o){o!==n&&(t.push(o+":"),n=o),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(u.Ay.isString(t)){var o=t;t=function(e){return e.text===o}}return function n(o){var r,i,c;if(t(o))return o;for(r=0,i=o.children.length;r<i;r++)if(c=n(e.get_node(o.children[r])))return c;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(u.Ay.isString(e)){var t=e;e=j(t),k(e,"mug not found: "+t)}return 0===d()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return d()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:v().parseXML}}}]);