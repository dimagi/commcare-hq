"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[358],{358:(e,t,n)=>{n.r(t);var o=n(8324),r=n.n(o),i=n(1134),c=n(561),s=n.n(c),a=r().assert;describe("The undo manager",(function(){before((function(e){i.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!1}})})),beforeEach((function(){i.A.loadXML("")})),it("should show an alert when deleting questions",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click(),a(s()(".fd-undo-delete").length)})),it("should undelete one question properly",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),a(!0,"Woo! text restored")})),it("should undelete two questions properly",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text","text2"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete a nested question properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group/text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group"),s()(".fd-button-remove").click(),i.A.assertJSTreeState();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a nested group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Group","group2"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  group2","    text2"),i.A.clickQuestion("group/group2"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("group");try{i.A.clickQuestion("group2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/group2/text2"),i.A.assertJSTreeState("group","  group2","    text2")})),it("should undelete a question with question after it",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete the first question",(function(){i.A.addQuestion("Text","text"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),a(!s()(".fd-default-panel").is(":visible"),"New Form dialog showing"),i.A.assertJSTreeState("text")})),it("should undelete a multiple choice question with correct number of children",(function(){i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should undelete multiple questions when selected out of order",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.addQuestion("Text","text3"),i.A.clickQuestion("text3","text2"),i.A.assertJSTreeState("text","text2","text3"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("text"),s()(".fd-undo").click(),i.A.assertJSTreeState("text","text2","text3")})),it("should reset the undo manager after a delete",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.clickQuestion("select"),s()(".fd-button-remove").click(),i.A.assertJSTreeState(),s()(".fd-undo").click(),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should reset the undo manager after adding a question",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.addQuestion("Text","text"),a.strictEqual(s()(".fd-undo-delete").length,0)})),it("should undelete a multiple choice question when selected with others",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("text","select"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("text","select","  choice1","  choice2")})),it("should adjust the tree's height to accommodate the undo alert message",(function(){var e=function(){return s()(".fd-tree .fd-scrollable").outerHeight()};i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.clickQuestion("text");var t=e();s()(".fd-button-remove").click();var n=e();a(n!==t,"Height changed with addition of alert."),s()(".fd-undo").click(),a(e()===t,"Height restored after undoing deletion."),s()(".fd-button-remove").click(),a(e()===n,"Height changed with addition of alert."),s()(".fd-undo-delete .close").click(),a(e()===t,"Height restored after closing alert.")})),it("should fix broken references on undelete referenced question",(function(){i.A.addQuestion("Text","red");var e=i.A.addQuestion("Text","blue",{relevantAttr:"#form/red = '1'"});i.A.deleteQuestion("red"),a(!i.A.isTreeNodeValid(e),"blue should have reference error"),e.form.undo(),a(i.A.isTreeNodeValid(e),"blue should be valid")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>w});var o=n(8449),r=n(8324),i=n.n(r),c=n(6848),s=n.n(c),a=n(3794),u=n(4523),l=n(561),d=n.n(l),f=n(1437),h=n(3809),p=n(705),A=n(7229),x=(n(1460),n(9747),i().assert),g=["Form Builder clip","version 1"];function m(e,t,n){if((n=u.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=A.A.parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var r,i,c,a,l=(r=e,i=t,c=s().xml(r),a=s().xml(i),s().isEquivalent(c,a,{element_order:!0}));n.not&&(l=!l),l||v(e=k(e),t=k(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function v(e,t,n){if(e!==t){var o=(0,a.createPatch)("",e,t,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),x(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(o))}}function k(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function S(e){return y("getCurrentMugInput",e)}function Q(e){var t=d()("#vellum").vellum("get"),n=u.Ay.isString(e)?d()("[name="+e+"]"):e;return p.A.util.getWidget(n,t)}function y(){var e=Array.prototype.slice.call(arguments),t=d()("#vellum");return t.vellum.apply(t,e)}function b(){var e=[],t=u.Ay.map(arguments,(function(t){var n=u.Ay.isString(t)?T(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return y("jstree","deselect_all",!0),y("jstree","select_node",t),d()(".collapse-toggle.collapsed").click(),e}function T(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=y("getMugByPath",e);if(!t){var n=e.split("/"),o=y("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var r=y("getData").core.form.getChildren(o),i=n[n.length-1];if(1===r.length&&"itemset"===i&&"itemset"===r[0].options.tagName)return r[0];for(var c=0;c<r.length;c++)if(r[c].p.nodeID===i)return r[c]}}return t}x.equal=x.strictEqual,x.notEqual=x.notStrictEqual;const w={options:o.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=d().extend(!0,{},o.A.options,e),n=d().fn.animate;d().fn.animate=function(e,t,o,r){n.apply(this,[e,0,o,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=u.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&u.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var i=d()("#vellum"),c=i.vellum("get");c&&(c.destroy(),d()("body > div.modal, body > div.modal-backdrop").remove()),i.empty().vellum(t)},call:y,loadXML:function(e,t,n,o,r=!0){var i=[],c=y("getData");return o||window.history.replaceState(null,null," "),c.core.parseWarnings=[],y("loadXML",e,t||{},{reset:r}),n?u.Ay.isRegExp(n)&&(i=u.Ay.filter(c.core.parseWarnings,(function(e){return!n.test(e)}))):i=c.core.parseWarnings,x(!i.length,"unexpected parse warnings:\n- "+i.join("\n- ")),delete c.core.parseWarnings,c.core.form},saveAndReload:function(e){y("loadXFormOrError",y("createXML"),e)},getMug:T,getInput:S,getWidget:Q,getMediaUploader:function(e){var t,n={},o=Q(e);if(!o)throw new Error("media uploader widget not found");if(u.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:o.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:v,assertInputCount:function(e,t,n){u.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=S(e)):n=n?" for "+n:"",x.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:m,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,m(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";v(function e(t,n){var o,r,i,c=[];for("#"===t.id?n=-1:c.push(Array(2*n+1).join(" ")+t.text),o=0,r=t.children.length;o<r;o++)i=y("jstree","get_node",t.children[o]),c.push(e(i,n+1));return c.join("\n")}(y("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";v(function e(t,n){var o,r,i,c=[];for(t.isRootNode?n=-1:c.push(Array(2*n+1).join(" ")+t.value.p.nodeID),o=0,r=t.children.length;o<r;o++)i=t.children[o],c.push(e(i,n+1));return c.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=u.Ay.extend({},n),this.prevId&&b(this.prevId);var o=y("addQuestion",e);return t||o.p.nodeID||(t=y("nodeIDFromLabel",o)),t&&(x(u.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),u.Ay.each(n,(function(e,t){u.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?o.p[t].set(e):o.p[t]=e})),u.Ay.each(y("getSections",o),(function(e){y("collapseSection",e.slug,!1)})),o},paste:function(e,t,n){u.Ay.isString(e)||(e=h.A.tabDelimit([g].concat(e))),n&&window.console.log(e),x.deepEqual(f.A.paste(e),t||[])},clickQuestion:b,selectAll:function(){y("jstree","select_all")},deleteQuestion:function(){var e=u.Ay.map(arguments,(function(e){var t=T(e);return x(t,"mug not found: "+e),t}));y("getData").core.form.removeMugsFromForm(e),u.Ay.each(arguments,(function(e){x(!T(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=y("getData").core.saveButton;if(!u.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),x.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){y("jstree","open_node",e.ufid),y("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){y("jstree","close_node",e.ufid),y("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(u.Ay.isString(e)){var o=e;e=T(o),x(e,"mug not found: "+o)}return e.messages.each((function(e,o){o!==n&&(t.push(o+":"),n=o),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(u.Ay.isString(t)){var o=t;t=function(e){return e.text===o}}return function n(o){var r,i,c;if(t(o))return o;for(r=0,i=o.children.length;r<i;r++)if(c=n(e.get_node(o.children[r])))return c;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(u.Ay.isString(e)){var t=e;e=T(t),x(e,"mug not found: "+t)}return 0===d()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return d()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:A.A.parseXML}}}]);