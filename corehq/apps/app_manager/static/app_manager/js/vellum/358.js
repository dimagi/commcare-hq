"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[358],{358:(e,t,n)=>{n.r(t);var o=n(8324),r=n.n(o),i=n(1134),c=n(561),s=n.n(c),a=r().assert;describe("The undo manager",(function(){before((function(e){i.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!1}})})),beforeEach((function(){i.A.loadXML("")})),it("should show an alert when deleting questions",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click(),a(s()(".fd-undo-delete").length)})),it("should undelete one question properly",(function(){i.A.addQuestion("Text","text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),a(!0,"Woo! text restored")})),it("should undelete two questions properly",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text","text2"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete a nested question properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group/text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  text2"),i.A.clickQuestion("group"),s()(".fd-button-remove").click(),i.A.assertJSTreeState();try{i.A.clickQuestion("text2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/text2"),i.A.assertJSTreeState("group","  text2")})),it("should undelete a nested group properly",(function(){i.A.addQuestion("Group","group"),i.A.addQuestion("Group","group2"),i.A.addQuestion("Text","text2"),i.A.assertJSTreeState("group","  group2","    text2"),i.A.clickQuestion("group/group2"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("group");try{i.A.clickQuestion("group2"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("group/group2/text2"),i.A.assertJSTreeState("group","  group2","    text2")})),it("should undelete a question with question after it",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("text"),i.A.assertJSTreeState("text","text2")})),it("should undelete the first question",(function(){i.A.addQuestion("Text","text"),i.A.clickQuestion("text"),i.A.assertJSTreeState("text"),s()(".fd-button-remove").click();try{i.A.clickQuestion("text"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),a(!s()(".fd-default-panel").is(":visible"),"New Form dialog showing"),i.A.assertJSTreeState("text")})),it("should undelete a multiple choice question with correct number of children",(function(){i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should undelete multiple questions when selected out of order",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Text","text2"),i.A.addQuestion("Text","text3"),i.A.clickQuestion("text3","text2"),i.A.assertJSTreeState("text","text2","text3"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("text"),s()(".fd-undo").click(),i.A.assertJSTreeState("text","text2","text3")})),it("should reset the undo manager after a delete",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.clickQuestion("select"),s()(".fd-button-remove").click(),i.A.assertJSTreeState(),s()(".fd-undo").click(),i.A.assertJSTreeState("select","  choice1","  choice2")})),it("should reset the undo manager after adding a question",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),i.A.clickQuestion("text"),s()(".fd-button-remove").click(),i.A.assertJSTreeState("select","  choice1","  choice2"),i.A.addQuestion("Text","text"),a.strictEqual(s()(".fd-undo-delete").length,0)})),it("should undelete a multiple choice question when selected with others",(function(){i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.addQuestion("Choice","choice1"),i.A.addQuestion("Choice","choice2"),i.A.clickQuestion("text","select"),i.A.assertJSTreeState("text","select","  choice1","  choice2"),s()(".fd-button-remove").click();try{i.A.clickQuestion("select"),a(!1,"this better not work")}catch(e){a(!0,"text doesn't exist")}s()(".fd-undo").click(),i.A.clickQuestion("select"),i.A.assertJSTreeState("text","select","  choice1","  choice2")})),it("should adjust the tree's height to accommodate the undo alert message",(function(){var e=function(){return s()(".fd-tree .fd-scrollable").outerHeight()};i.A.addQuestion("Text","text"),i.A.addQuestion("Select","select"),i.A.clickQuestion("text");var t=e();s()(".fd-button-remove").click();var n=e();a(n!==t,"Height changed with addition of alert."),s()(".fd-undo").click(),a(e()===t,"Height restored after undoing deletion."),s()(".fd-button-remove").click(),a(e()===n,"Height changed with addition of alert."),s()(".fd-undo-delete .close").click(),a(e()===t,"Height restored after closing alert.")})),it("should fix broken references on undelete referenced question",(function(){i.A.addQuestion("Text","red");var e=i.A.addQuestion("Text","blue",{relevantAttr:"#form/red = '1'"});i.A.deleteQuestion("red"),a(!i.A.isTreeNodeValid(e),"blue should have reference error"),e.form.undo(),a(i.A.isTreeNodeValid(e),"blue should be valid")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>E});var o=n(8449),r=n(8324),i=n.n(r),c=n(6848),s=n.n(c),a=n(3794),u=n.n(a),l=n(4523),d=n(561),f=n.n(d),h=n(1437),p=n.n(h),x=n(3809),A=n.n(x),g=n(705),m=n.n(g),v=n(7229),k=n.n(v),S=(n(1460),n(8803),i().assert),Q=["Form Builder clip","version 1"];function y(e,t,n){if((n=l.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=k().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var r,i,c,a,u=(r=e,i=t,c=s().xml(r),a=s().xml(i),s().isEquivalent(c,a,{element_order:!0}));n.not&&(u=!u),u||b(e=T(e),t=T(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function b(e,t,n){if(e!==t){var o=u().createPatch("",e,t,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),S(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(o))}}function T(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function w(e){return q("getCurrentMugInput",e)}function J(e){var t=f()("#vellum").vellum("get"),n=l.Ay.isString(e)?f()("[name="+e+"]"):e;return m().util.getWidget(n,t)}function q(){var e=Array.prototype.slice.call(arguments),t=f()("#vellum");return t.vellum.apply(t,e)}function j(){var e=[],t=l.Ay.map(arguments,(function(t){var n=l.Ay.isString(t)?_(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return q("jstree","deselect_all",!0),q("jstree","select_node",t),f()(".collapse-toggle.collapsed").click(),e}function _(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=q("getMugByPath",e);if(!t){var n=e.split("/"),o=q("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var r=q("getData").core.form.getChildren(o),i=n[n.length-1];if(1===r.length&&"itemset"===i&&"itemset"===r[0].options.tagName)return r[0];for(var c=0;c<r.length;c++)if(r[c].p.nodeID===i)return r[c]}}return t}S.equal=S.strictEqual,S.notEqual=S.notStrictEqual;const E={options:o.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=f().extend(!0,{},o.A.options,e),n=f().fn.animate;f().fn.animate=function(e,t,o,r){n.apply(this,[e,0,o,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=l.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&l.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var i=f()("#vellum"),c=i.vellum("get");c&&(c.destroy(),f()("body > div.modal, body > div.modal-backdrop").remove()),i.empty().vellum(t)},call:q,loadXML:function(e,t,n,o,r=!0){var i=[],c=q("getData");return o||window.history.replaceState(null,null," "),c.core.parseWarnings=[],q("loadXML",e,t||{},{reset:r}),n?l.Ay.isRegExp(n)&&(i=l.Ay.filter(c.core.parseWarnings,(function(e){return!n.test(e)}))):i=c.core.parseWarnings,S(!i.length,"unexpected parse warnings:\n- "+i.join("\n- ")),delete c.core.parseWarnings,c.core.form},saveAndReload:function(e){q("loadXFormOrError",q("createXML"),e)},getMug:_,getInput:w,getWidget:J,getMediaUploader:function(e){var t,n={},o=J(e);if(!o)throw new Error("media uploader widget not found");if(l.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:o.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:b,assertInputCount:function(e,t,n){l.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=w(e)):n=n?" for "+n:"",S.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:y,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,y(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";b(function e(t,n){var o,r,i,c=[];for("#"===t.id?n=-1:c.push(Array(2*n+1).join(" ")+t.text),o=0,r=t.children.length;o<r;o++)i=q("jstree","get_node",t.children[o]),c.push(e(i,n+1));return c.join("\n")}(q("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";b(function e(t,n){var o,r,i,c=[];for(t.isRootNode?n=-1:c.push(Array(2*n+1).join(" ")+t.value.p.nodeID),o=0,r=t.children.length;o<r;o++)i=t.children[o],c.push(e(i,n+1));return c.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=l.Ay.extend({},n),this.prevId&&j(this.prevId);var o=q("addQuestion",e);return t||o.p.nodeID||(t=q("nodeIDFromLabel",o)),t&&(S(l.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),l.Ay.each(n,(function(e,t){l.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?o.p[t].set(e):o.p[t]=e})),l.Ay.each(q("getSections",o),(function(e){q("collapseSection",e.slug,!1)})),o},paste:function(e,t,n){l.Ay.isString(e)||(e=A().tabDelimit([Q].concat(e))),n&&window.console.log(e),S.deepEqual(p().paste(e),t||[])},clickQuestion:j,selectAll:function(){q("jstree","select_all")},deleteQuestion:function(){var e=l.Ay.map(arguments,(function(e){var t=_(e);return S(t,"mug not found: "+e),t}));q("getData").core.form.removeMugsFromForm(e),l.Ay.each(arguments,(function(e){S(!_(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=q("getData").core.saveButton;if(!l.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),S.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){q("jstree","open_node",e.ufid),q("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){q("jstree","close_node",e.ufid),q("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(l.Ay.isString(e)){var o=e;e=_(o),S(e,"mug not found: "+o)}return e.messages.each((function(e,o){o!==n&&(t.push(o+":"),n=o),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(l.Ay.isString(t)){var o=t;t=function(e){return e.text===o}}return function n(o){var r,i,c;if(t(o))return o;for(r=0,i=o.children.length;r<i;r++)if(c=n(e.get_node(o.children[r])))return c;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(l.Ay.isString(e)){var t=e;e=_(t),S(e,"mug not found: "+t)}return 0===f()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return f()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:k().parseXML}}}]);