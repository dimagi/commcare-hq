"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[195],{3576:(e,t,n)=>{n.r(t);var r=n(8324),a=n.n(r),o=n(561),i=n.n(o),l=n(1134),u=n(4485),s=n.n(u),c=a().assert;describe("The expression editor",(function(){var e;before((function(t){l.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e=this.data.core.form,t()}}})})),it("should trigger change event on join type changed",(function(){l.A.loadXML("");var e=i()("<div>"),t=function(e){var t={mug:e,xpathType:"bool",value:'#form/text = "1" and #form/text = "yes"',changed:!1,change:function(){t.changed=!0}};return t}(l.A.addQuestion("Text","text"));s().showXPathEditor(e,t),e.find(".top-level-join-select").val("or").change(),c.equal(t.changed,!0,"expected changed flag to be set")})),describe("xpath validator",(function(){it("should not validate '#invalid/xpath ' prefix",(function(){var t=s().validateXPath(e,"#invalid/xpath if(`#form/text`");c.isNotOk(t[0],JSON.stringify(t)),c.include(t[1].message,"if(#form/text"),c.notInclude(t[1].message,"#invalid/xpath")}))}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>X});var r=n(8449),a=n(8324),o=n.n(a),i=n(6848),l=n.n(i),u=n(3794),s=n.n(u),c=n(4523),d=n(561),f=n.n(d),p=n(1437),g=n.n(p),v=n(3809),h=n.n(v),m=n(705),y=n.n(m),x=n(7229),A=n.n(x),b=(n(1460),n(8803),o().assert),j=["Form Builder clip","version 1"];function w(e,t,n){if((n=c.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var r=A().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+r+'"')}var a,o,i,u,s=(a=e,o=t,i=l().xml(a),u=l().xml(o),l().isEquivalent(i,u,{element_order:!0}));n.not&&(s=!s),s||I(e=S(e),t=S(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function I(e,t,n){if(e!==t){var r=s().createPatch("",e,t,"actual","expected");r=r.replace(/^Index:/,n||"Not equal:"),b(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(r))}}function S(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function _(e){return M("getCurrentMugInput",e)}function E(e){var t=f()("#vellum").vellum("get"),n=c.Ay.isString(e)?f()("[name="+e+"]"):e;return y().util.getWidget(n,t)}function M(){var e=Array.prototype.slice.call(arguments),t=f()("#vellum");return t.vellum.apply(t,e)}function k(){var e=[],t=c.Ay.map(arguments,(function(t){var n=c.Ay.isString(t)?q(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return M("jstree","deselect_all",!0),M("jstree","select_node",t),f()(".collapse-toggle.collapsed").click(),e}function q(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=M("getMugByPath",e);if(!t){var n=e.split("/"),r=M("getMugByPath",n.slice(0,-1).join("/"));if(r&&r.__className.indexOf("Select")>-1){var a=M("getData").core.form.getChildren(r),o=n[n.length-1];if(1===a.length&&"itemset"===o&&"itemset"===a[0].options.tagName)return a[0];for(var i=0;i<a.length;i++)if(a[i].p.nodeID===o)return a[i]}}return t}b.equal=b.strictEqual,b.notEqual=b.notStrictEqual;const X={options:r.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=f().extend(!0,{},r.A.options,e),n=f().fn.animate;f().fn.animate=function(e,t,r,a){n.apply(this,[e,0,r,a])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=c.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&c.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var a=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,a(e)};var o=f()("#vellum"),i=o.vellum("get");i&&(i.destroy(),f()("body > div.modal, body > div.modal-backdrop").remove()),o.empty().vellum(t)},call:M,loadXML:function(e,t,n,r,a=!0){var o=[],i=M("getData");return r||window.history.replaceState(null,null," "),i.core.parseWarnings=[],M("loadXML",e,t||{},{reset:a}),n?c.Ay.isRegExp(n)&&(o=c.Ay.filter(i.core.parseWarnings,(function(e){return!n.test(e)}))):o=i.core.parseWarnings,b(!o.length,"unexpected parse warnings:\n- "+o.join("\n- ")),delete i.core.parseWarnings,i.core.form},saveAndReload:function(e){M("loadXFormOrError",M("createXML"),e)},getMug:q,getInput:_,getWidget:E,getMediaUploader:function(e){var t,n={},r=E(e);if(!r)throw new Error("media uploader widget not found");if(c.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:r.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:I,assertInputCount:function(e,t,n){c.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=_(e)):n=n?" for "+n:"",b.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:w,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,w(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";I(function e(t,n){var r,a,o,i=[];for("#"===t.id?n=-1:i.push(Array(2*n+1).join(" ")+t.text),r=0,a=t.children.length;r<a;r++)o=M("jstree","get_node",t.children[r]),i.push(e(o,n+1));return i.join("\n")}(M("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";I(function e(t,n){var r,a,o,i=[];for(t.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+t.value.p.nodeID),r=0,a=t.children.length;r<a;r++)o=t.children[r],i.push(e(o,n+1));return i.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=c.Ay.extend({},n),this.prevId&&k(this.prevId);var r=M("addQuestion",e);return t||r.p.nodeID||(t=M("nodeIDFromLabel",r)),t&&(b(c.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),r.p.labelItext&&r.p.labelItext.set(r.getLabelValue()),r.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),c.Ay.each(n,(function(e,t){c.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?r.p[t].set(e):r.p[t]=e})),c.Ay.each(M("getSections",r),(function(e){M("collapseSection",e.slug,!1)})),r},paste:function(e,t,n){c.Ay.isString(e)||(e=h().tabDelimit([j].concat(e))),n&&window.console.log(e),b.deepEqual(g().paste(e),t||[])},clickQuestion:k,selectAll:function(){M("jstree","select_all")},deleteQuestion:function(){var e=c.Ay.map(arguments,(function(e){var t=q(e);return b(t,"mug not found: "+e),t}));M("getData").core.form.removeMugsFromForm(e),c.Ay.each(arguments,(function(e){b(!q(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=M("getData").core.saveButton;if(!c.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),b.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){M("jstree","open_node",e.ufid),M("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){M("jstree","close_node",e.ufid),M("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(c.Ay.isString(e)){var r=e;e=q(r),b(e,"mug not found: "+r)}return e.messages.each((function(e,r){r!==n&&(t.push(r+":"),n=r),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(c.Ay.isString(t)){var r=t;t=function(e){return e.text===r}}return function n(r){var a,o,i;if(t(r))return r;for(a=0,o=r.children.length;a<o;a++)if(i=n(e.get_node(r.children[a])))return i;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(c.Ay.isString(e)){var t=e;e=q(t),b(e,"mug not found: "+t)}return 0===f()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return f()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:A().parseXML}}}]);