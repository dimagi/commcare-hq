"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[773],{2773:(e,t,n)=>{var r=n(1134),o=n(8324),a=n.n(o),i=n(4523),l=a().assert;describe("Mugs",(function(){before((function(e){r.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!1}})})),it("should coalesce change events inside _withMessages",(function(){r.A.loadXML("");var e,t=r.A.addQuestion("Text"),n=1,o=0;function a(){t.addMessage(null,{key:"test-message",level:t.ERROR,message:"testing "+n++})}t.on("messages-changed",(function(){o+=1})),l.equal(o,0),e=t._withMessages((function(){a(),a(),l.equal(o,0)})),l(e,"not changed!"),l.equal(o,1),a(),a(),l.equal(o,3)})),it("at the top level should not be named meta",(function(){var e=[["id","type"],["meta","Group"],["meta/meta","Text"],["group","Group"],["group/meta","Group"]];r.A.loadXML(""),r.A.paste(e),i.Ay.each(e.slice(1),(function(e){var t=r.A.getMug(e[0]),n=t.messages.get("nodeID");/\bmeta$/.test(t.p.nodeID)?l.deepEqual(n,["'meta' is not a valid Question ID."]):l.deepEqual(n,[])}))})),it("should have a function to tell if referenced by other mugs",(function(){r.A.loadXML(""),r.A.paste([["id","type","relevantAttr"],["red","Text",""],["blue","Text","#form/red = '1'"]]);var e=r.A.getMug("red"),t=r.A.getMug("blue");l.isNotOk(t.isReferencedByOtherMugs(),"blue should not be referenced"),l.isOk(e.isReferencedByOtherMugs(),"red should be referenced"),l.isNotOk(e.isReferencedByOtherMugs([t]),"red with except=[blue] should not be referenced")})),it("should not default choice label to node ID",(function(){r.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/05EB6EEF-AC1D-416C-A949-1BABAD81B57A" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<select />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<bind vellum:nodeset="#form/select" nodeset="/data/select" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<select1 vellum:ref="#form/select" ref="/data/select">\n\t\t\t<item>\n\t\t\t\t<label ref="jr:itext(\'select-blank-label\')" />\n\t\t\t\t<value>blank</value>\n\t\t\t</item>\n\t\t</select1>\n\t</h:body>\n</h:html>');var e=r.A.getMug("select/blank");l.equal(e.p.labelItext.get(),"","blank label itext")})),it("should load required attribute on label with non-minimal appearance",(function(){r.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/86855C2C-46CB-4268-B445-0F8CBD35E3DA" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<label />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<bind vellum:nodeset="#form/label" nodeset="/data/label" required="test()" requiredCondition="test()" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="label-label">\n\t\t\t\t\t\t<value>Label</value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<trigger vellum:ref="#form/label" ref="/data/label">\n\t\t\t<label ref="jr:itext(\'label-label\')" />\n\t\t</trigger>\n\t</h:body>\n</h:html>\n');var e=r.A.getMug("label");l.isTrue(e.p.requiredAttr),l.equal(e.p.requiredCondition,"test()"),l.isTrue(e.isVisible("requiredAttr"),"required checkbox should be visible"),l.isTrue(e.isVisible("requiredCondition"),"required condition should be visible")})),it("should remove required attribute when changing Text to Label",(function(){var e=r.A.loadXML(""),t=r.A.addQuestion("Text","text");t.p.requiredAttr=!0,t.p.requiredCondition="something()",e.changeMugType(t,"Trigger"),l.isUndefined(t.p.requiredAttr),l.isUndefined(t.p.requiredCondition),l.isFalse(t.isVisible("requiredAttr"),"required checkbox should not be visible"),l.isFalse(t.isVisible("requiredCondition"),"required condition should not be visible")}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>D});var r=n(8449),o=n(8324),a=n.n(o),i=n(6848),l=n.n(i),s=n(3794),u=n.n(s),d=n(4523),c=n(561),f=n.n(c),m=n(1437),g=n.n(m),h=n(3809),p=n.n(h),v=n(705),x=n.n(v),b=n(7229),A=n.n(b),y=(n(1460),n(8803),a().assert),w=["Form Builder clip","version 1"];function q(e,t,n){if((n=d.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var r=A().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+r+'"')}var o,a,i,s,u=(o=e,a=t,i=l().xml(o),s=l().xml(a),l().isEquivalent(i,s,{element_order:!0}));n.not&&(u=!u),u||j(e=M(e),t=M(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function j(e,t,n){if(e!==t){var r=u().createPatch("",e,t,"actual","expected");r=r.replace(/^Index:/,n||"Not equal:"),y(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(r))}}function M(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function k(e){return I("getCurrentMugInput",e)}function E(e){var t=f()("#vellum").vellum("get"),n=d.Ay.isString(e)?f()("[name="+e+"]"):e;return x().util.getWidget(n,t)}function I(){var e=Array.prototype.slice.call(arguments),t=f()("#vellum");return t.vellum.apply(t,e)}function _(){var e=[],t=d.Ay.map(arguments,(function(t){var n=d.Ay.isString(t)?C(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return I("jstree","deselect_all",!0),I("jstree","select_node",t),f()(".collapse-toggle.collapsed").click(),e}function C(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=I("getMugByPath",e);if(!t){var n=e.split("/"),r=I("getMugByPath",n.slice(0,-1).join("/"));if(r&&r.__className.indexOf("Select")>-1){var o=I("getData").core.form.getChildren(r),a=n[n.length-1];if(1===o.length&&"itemset"===a&&"itemset"===o[0].options.tagName)return o[0];for(var i=0;i<o.length;i++)if(o[i].p.nodeID===a)return o[i]}}return t}y.equal=y.strictEqual,y.notEqual=y.notStrictEqual;const D={options:r.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=f().extend(!0,{},r.A.options,e),n=f().fn.animate;f().fn.animate=function(e,t,r,o){n.apply(this,[e,0,r,o])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=d.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&d.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var o=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,o(e)};var a=f()("#vellum"),i=a.vellum("get");i&&(i.destroy(),f()("body > div.modal, body > div.modal-backdrop").remove()),a.empty().vellum(t)},call:I,loadXML:function(e,t,n,r){var o=[],a=I("getData");return r||window.history.replaceState(null,null," "),a.core.parseWarnings=[],I("loadXML",e,t||{}),n?d.Ay.isRegExp(n)&&(o=d.Ay.filter(a.core.parseWarnings,(function(e){return!n.test(e)}))):o=a.core.parseWarnings,y(!o.length,"unexpected parse warnings:\n- "+o.join("\n- ")),delete a.core.parseWarnings,a.core.form},saveAndReload:function(e){I("loadXFormOrError",I("createXML"),e)},getMug:C,getInput:k,getWidget:E,getMediaUploader:function(e){var t,n={},r=E(e);if(!r)throw new Error("media uploader widget not found");if(d.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:r.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:j,assertInputCount:function(e,t,n){d.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=k(e)):n=n?" for "+n:"",y.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:q,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,q(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";j(function e(t,n){var r,o,a,i=[];for("#"===t.id?n=-1:i.push(Array(2*n+1).join(" ")+t.text),r=0,o=t.children.length;r<o;r++)a=I("jstree","get_node",t.children[r]),i.push(e(a,n+1));return i.join("\n")}(I("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";j(function e(t,n){var r,o,a,i=[];for(t.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+t.value.p.nodeID),r=0,o=t.children.length;r<o;r++)a=t.children[r],i.push(e(a,n+1));return i.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=d.Ay.extend({},n),this.prevId&&_(this.prevId);var r=I("addQuestion",e);return t||r.p.nodeID||(t=I("nodeIDFromLabel",r)),t&&(y(d.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),r.p.labelItext&&r.p.labelItext.set(r.getLabelValue()),r.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),d.Ay.each(n,(function(e,t){d.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?r.p[t].set(e):r.p[t]=e})),d.Ay.each(I("getSections",r),(function(e){I("collapseSection",e.slug,!1)})),r},paste:function(e,t,n){d.Ay.isString(e)||(e=p().tabDelimit([w].concat(e))),n&&window.console.log(e),y.deepEqual(g().paste(e),t||[])},clickQuestion:_,selectAll:function(){I("jstree","select_all")},deleteQuestion:function(){var e=d.Ay.map(arguments,(function(e){var t=C(e);return y(t,"mug not found: "+e),t}));I("getData").core.form.removeMugsFromForm(e),d.Ay.each(arguments,(function(e){y(!C(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=I("getData").core.saveButton;if(!d.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),y.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){I("jstree","open_node",e.ufid),I("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){I("jstree","close_node",e.ufid),I("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(d.Ay.isString(e)){var r=e;e=C(r),y(e,"mug not found: "+r)}return e.messages.each((function(e,r){r!==n&&(t.push(r+":"),n=r),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(d.Ay.isString(t)){var r=t;t=function(e){return e.text===r}}return function n(r){var o,a,i;if(t(r))return r;for(o=0,a=r.children.length;o<a;o++)if(i=n(e.get_node(r.children[o])))return i;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(d.Ay.isString(e)){var t=e;e=C(t),y(e,"mug not found: "+t)}return 0===f()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return f()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:A().parseXML}}}]);