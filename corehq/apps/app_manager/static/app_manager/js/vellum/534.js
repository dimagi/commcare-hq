"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[534],{1134:(e,t,n)=>{n.d(t,{A:()=>I});var a=n(8449),o=n(8324),i=n.n(o),r=n(6848),l=n.n(r),s=n(3794),d=n.n(s),u=n(4523),c=n(561),f=n.n(c),h=n(1437),p=n.n(h),v=n(3809),g=n.n(v),x=n(705),m=n.n(x),A=n(7229),b=n.n(A),y=(n(1460),n(8803),i().assert),w=["Form Builder clip","version 1"];function q(e,t,n){if((n=u.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=b().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var o,i,r,s,d=(o=e,i=t,r=l().xml(o),s=l().xml(i),l().isEquivalent(r,s,{element_order:!0}));n.not&&(d=!d),d||X(e=k(e),t=k(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function X(e,t,n){if(e!==t){var a=d().createPatch("",e,t,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),y(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(a))}}function k(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function E(e){return P("getCurrentMugInput",e)}function j(e){var t=f()("#vellum").vellum("get"),n=u.Ay.isString(e)?f()("[name="+e+"]"):e;return m().util.getWidget(n,t)}function P(){var e=Array.prototype.slice.call(arguments),t=f()("#vellum");return t.vellum.apply(t,e)}function M(){var e=[],t=u.Ay.map(arguments,(function(t){var n=u.Ay.isString(t)?Q(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return P("jstree","deselect_all",!0),P("jstree","select_node",t),f()(".collapse-toggle.collapsed").click(),e}function Q(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=P("getMugByPath",e);if(!t){var n=e.split("/"),a=P("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var o=P("getData").core.form.getChildren(a),i=n[n.length-1];if(1===o.length&&"itemset"===i&&"itemset"===o[0].options.tagName)return o[0];for(var r=0;r<o.length;r++)if(o[r].p.nodeID===i)return o[r]}}return t}y.equal=y.strictEqual,y.notEqual=y.notStrictEqual;const I={options:a.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=f().extend(!0,{},a.A.options,e),n=f().fn.animate;f().fn.animate=function(e,t,a,o){n.apply(this,[e,0,a,o])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=u.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&u.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var o=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,o(e)};var i=f()("#vellum"),r=i.vellum("get");r&&(r.destroy(),f()("body > div.modal, body > div.modal-backdrop").remove()),i.empty().vellum(t)},call:P,loadXML:function(e,t,n,a,o=!0){var i=[],r=P("getData");return a||window.history.replaceState(null,null," "),r.core.parseWarnings=[],P("loadXML",e,t||{},{reset:o}),n?u.Ay.isRegExp(n)&&(i=u.Ay.filter(r.core.parseWarnings,(function(e){return!n.test(e)}))):i=r.core.parseWarnings,y(!i.length,"unexpected parse warnings:\n- "+i.join("\n- ")),delete r.core.parseWarnings,r.core.form},saveAndReload:function(e){P("loadXFormOrError",P("createXML"),e)},getMug:Q,getInput:E,getWidget:j,getMediaUploader:function(e){var t,n={},a=j(e);if(!a)throw new Error("media uploader widget not found");if(u.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:a.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:X,assertInputCount:function(e,t,n){u.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=E(e)):n=n?" for "+n:"",y.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:q,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,q(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";X(function e(t,n){var a,o,i,r=[];for("#"===t.id?n=-1:r.push(Array(2*n+1).join(" ")+t.text),a=0,o=t.children.length;a<o;a++)i=P("jstree","get_node",t.children[a]),r.push(e(i,n+1));return r.join("\n")}(P("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";X(function e(t,n){var a,o,i,r=[];for(t.isRootNode?n=-1:r.push(Array(2*n+1).join(" ")+t.value.p.nodeID),a=0,o=t.children.length;a<o;a++)i=t.children[a],r.push(e(i,n+1));return r.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=u.Ay.extend({},n),this.prevId&&M(this.prevId);var a=P("addQuestion",e);return t||a.p.nodeID||(t=P("nodeIDFromLabel",a)),t&&(y(u.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),u.Ay.each(n,(function(e,t){u.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?a.p[t].set(e):a.p[t]=e})),u.Ay.each(P("getSections",a),(function(e){P("collapseSection",e.slug,!1)})),a},paste:function(e,t,n){u.Ay.isString(e)||(e=g().tabDelimit([w].concat(e))),n&&window.console.log(e),y.deepEqual(p().paste(e),t||[])},clickQuestion:M,selectAll:function(){P("jstree","select_all")},deleteQuestion:function(){var e=u.Ay.map(arguments,(function(e){var t=Q(e);return y(t,"mug not found: "+e),t}));P("getData").core.form.removeMugsFromForm(e),u.Ay.each(arguments,(function(e){y(!Q(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=P("getData").core.saveButton;if(!u.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),y.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){P("jstree","open_node",e.ufid),P("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){P("jstree","close_node",e.ufid),P("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(u.Ay.isString(e)){var a=e;e=Q(a),y(e,"mug not found: "+a)}return e.messages.each((function(e,a){a!==n&&(t.push(a+":"),n=a),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(u.Ay.isString(t)){var a=t;t=function(e){return e.text===a}}return function n(a){var o,i,r;if(t(a))return a;for(o=0,i=a.children.length;o<i;o++)if(r=n(e.get_node(a.children[o])))return r;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(u.Ay.isString(e)){var t=e;e=Q(t),y(e,"mug not found: "+t)}return 0===f()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return f()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:b().parseXML}},3534:(e,t,n)=>{n.r(t);var a=n(8324),o=n.n(a),i=n(561),r=n.n(i),l=n(4523),s=n(1134),d=n(4485),u=n.n(d),c=n(4078),f=n.n(c),h=n(4459),p=n.n(h),v=n(8094),g=n.n(v),x=o().assert,m=u().showXPathEditor,A={};g().eventuality(A),u().showXPathEditor=function(){m.apply(null,arguments),A.fire("showXPathEditor")},describe("The widgets module with rich text disabled",(function(){before((function(e){s.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){x(this.isPluginEnabled("modeliteration"),"modeliteration plugin should be enabled"),e()}},features:{rich_text:!1}})})),it("xPath widget should allow drag/drop",(function(){var e=f().baseSpecs.databind;s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text"),x.equal(e.defaultValue.xpathType,"generic"),x(r()("[name=property-defaultValue]").hasClass("jstree-drop"),"defaultValue does not have jstree-drop class"),x.equal(e.relevantAttr.xpathType,"bool"),x(r()("[name=property-relevantAttr]").hasClass("jstree-drop"),"relevantAttr does not have jstree-drop class")})),it("xPath widget should show newlines in advanced mode",(function(e){s.A.loadXML("");var t='"line 1 \n line 2"';s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:t}),s.A.clickQuestion("/data/hidden");var n=r()("[name=property-calculateAttr]");x.equal(n.val(),'"line 1 &#10; line 2"'),n.closest(".form-group").find(".fd-edit-button").click(),A.on("showXPathEditor",(function(){var n=r()(".xpath-advanced").find("textarea").val();r()(".fd-xpath-cancel-button").click(),x.equal(n,t,"textarea content should have newline"),e()}),null,"showXPathEditor")})),it("xPath widget should escape newlines on save advanced mode",(function(e){s.A.loadXML("");var t='"line 1 \n line 2"',n=s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:""});s.A.clickQuestion("/data/hidden"),r()("[name=property-calculateAttr]").closest(".form-group").find(".fd-edit-button").click(),A.on("showXPathEditor",(function(){r()(".xpath-advanced").find("textarea").val(t).change(),r()(".fd-xpath-save-button").click();var a=r()("[name=property-calculateAttr]");x.equal(a.val(),'"line 1 &#10; line 2"',"input value not escaped"),x.equal(n.p.calculateAttr,t,"wrong mug value"),e()}),null,"showXPathEditor")})),it("xPath widget should show /data/ when in advanced editor without rich_text",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text");var t="#form/text",n=s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:t});x.equal(n.p.calculateAttr,t),s.A.clickQuestion("/data/hidden"),r()("[name=property-calculateAttr]").closest(".form-group").find(".fd-edit-button").click(),A.on("showXPathEditor",(function(){var a=r()(".xpath-advanced").find("textarea");x.equal(a.val(),"/data/text","input value showing #form"),x.equal(n.p.calculateAttr,t,"value not in vellum internal form"),e()}),null,"showXPathEditor")})),it("xPath widget should genuinely hide editor whenever it's exited",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text1"),s.A.addQuestion("Text","text2");var t=r()(".fd-content-right"),n=t.find(".fd-question-properties"),a=t.find(".fd-xpath-editor");n.find(".fd-edit-button:first").click(),A.on("showXPathEditor",(function(){x(a.is(":visible"),"Editor shown when clicked"),x(!n.is(":visible"),"Properties hidden when entering editor"),s.A.clickQuestion("/data/text1"),x(n.is(":visible"),"Properties shown as requested"),x(!a.is(":visible"),"Editor hidden when properties shown"),e()}),null,"showXPathEditor")})),it("xPath widget should change save button when dropdown is changed",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text"),r()(".fd-content-right").find(".fd-question-properties").find(".fd-edit-button:first").click(),A.on("showXPathEditor",(function(){x(!r()(".fd-xpath-save-button").hasClass("btn-success")),r()(".op-select").change(),x(r()(".fd-xpath-save-button").hasClass("btn-success")),e()}),null,"showXPathEditor")}))})),describe("The rich text widget",(function(){before((function(e){s.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!0}})})),describe("should preserve",(function(){var e=[["id","type","labelItext:en-default"],["/newlines","Text","list\n\n* item\n* item\n"],["/spaces","Text","a  b   c    d"]];before((function(){s.A.loadXML(""),s.A.paste(e)})),l.Ay.each(e.slice(1),(function(e){var t=e[0].slice(1);it(t,(function(n){s.A.clickQuestion(t),s.A.getWidget("itext-en-label").getValue((function(t){s.A.assertEqual(t,e[2]),n()}))}))}))})),it("should return just-set value on get value",(function(){s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text");var e=s.A.getWidget("itext-en-label"),t='<output value="#form/text" />';e.setValue(t),x.equal(e.getValue(),t)})),it("should create reference to hidden value in display condition",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"],["/text","Text","test"]]),s.A.clickQuestion("text");var t=s.A.getMug("text"),n=s.A.getWidget("property-relevantAttr"),a=r()(".fd-question-tree").jstree(!0);x.equal(n.input.length,1),n.input.promise.then((function(){s.A.findNode(a,"hidden").data.handleDrop(n.input),n.handleChange(),x.equal(t.p.relevantAttr,"#form/hidden"),e()}))})),it("should change save button on drag/drop into advanced xpath editor",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"],["/text","Text","test"]]),s.A.clickQuestion("text"),r()(".fd-content-right .fd-question-properties [name=property-defaultValue]").closest(".form-group").find(".fd-edit-button").click(),A.on("showXPathEditor",(function(){var t=r()(".fd-xpath-editor-text"),n=p().editor(t),a=r()(".fd-question-tree").jstree(!0),o=r()(".fd-xpath-save-button");x(!o.hasClass("btn-success"),"save button should not be green"),n.on("change",(function(){x(o.hasClass("btn-success"),"save button not green"),e()})),s.A.findNode(a,"hidden").data.handleDrop(t)}),null,"showXPathEditor")})),it("simple xpath editor should change save button on remove expression",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"]]),r()(".fd-content-right .fd-question-properties [name=property-relevantAttr]").closest(".form-group").find(".fd-edit-button").click(),A.on("showXPathEditor",(function(){var t=r()(".fd-xpath-save-button");x.equal(t.length,1,"save button"),x(!t.hasClass("btn-success"),"save button should not be active");var n=r()(".fd-add-exp");x.equal(n.length,1,"add button"),x.equal(r()(".xpath-expression-group").length,1,"before add"),n.click(),x.equal(r()(".xpath-expression-group").length,2,"after add row"),x(!t.hasClass("btn-success"),"should not activate save button on add expression");var a=r()(".xpath-delete-expression").last();x.equal(a.length,1,"remove button"),a.click(),x.equal(r()(".xpath-expression-group").length,1,"after remove row"),x(t.hasClass("btn-success"),"did not activate save button after remove expression"),e()}),null,"showXPathEditor")}))}))}}]);