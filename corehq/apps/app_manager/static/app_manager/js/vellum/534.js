"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[534],{1134:(e,t,n)=>{n.d(t,{A:()=>E});var a=n(8449),o=n(8324),i=n.n(o),r=n(6848),l=n.n(r),s=n(3794),d=n(4523),u=n(561),c=n.n(u),f=n(1437),h=n(3809),p=n(705),v=n(7229),g=(n(1460),n(9747),i().assert),x=["Form Builder clip","version 1"];function m(e,t,n){if((n=d.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=v.A.parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var o,i,r,s,u=(o=e,i=t,r=l().xml(o),s=l().xml(i),l().isEquivalent(r,s,{element_order:!0}));n.not&&(u=!u),u||A(e=b(e),t=b(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function A(e,t,n){if(e!==t){var a=(0,s.createPatch)("",e,t,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),g(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(a))}}function b(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function y(e){return q("getCurrentMugInput",e)}function w(e){var t=c()("#vellum").vellum("get"),n=d.Ay.isString(e)?c()("[name="+e+"]"):e;return p.A.util.getWidget(n,t)}function q(){var e=Array.prototype.slice.call(arguments),t=c()("#vellum");return t.vellum.apply(t,e)}function X(){var e=[],t=d.Ay.map(arguments,(function(t){var n=d.Ay.isString(t)?k(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return q("jstree","deselect_all",!0),q("jstree","select_node",t),c()(".collapse-toggle.collapsed").click(),e}function k(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=q("getMugByPath",e);if(!t){var n=e.split("/"),a=q("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var o=q("getData").core.form.getChildren(a),i=n[n.length-1];if(1===o.length&&"itemset"===i&&"itemset"===o[0].options.tagName)return o[0];for(var r=0;r<o.length;r++)if(o[r].p.nodeID===i)return o[r]}}return t}g.equal=g.strictEqual,g.notEqual=g.notStrictEqual;const E={options:a.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=c().extend(!0,{},a.A.options,e),n=c().fn.animate;c().fn.animate=function(e,t,a,o){n.apply(this,[e,0,a,o])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=d.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&d.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var o=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,o(e)};var i=c()("#vellum"),r=i.vellum("get");r&&(r.destroy(),c()("body > div.modal, body > div.modal-backdrop").remove()),i.empty().vellum(t)},call:q,loadXML:function(e,t,n,a,o=!0){var i=[],r=q("getData");return a||window.history.replaceState(null,null," "),r.core.parseWarnings=[],q("loadXML",e,t||{},{reset:o}),n?d.Ay.isRegExp(n)&&(i=d.Ay.filter(r.core.parseWarnings,(function(e){return!n.test(e)}))):i=r.core.parseWarnings,g(!i.length,"unexpected parse warnings:\n- "+i.join("\n- ")),delete r.core.parseWarnings,r.core.form},saveAndReload:function(e){q("loadXFormOrError",q("createXML"),e)},getMug:k,getInput:y,getWidget:w,getMediaUploader:function(e){var t,n={},a=w(e);if(!a)throw new Error("media uploader widget not found");if(d.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:a.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:A,assertInputCount:function(e,t,n){d.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=y(e)):n=n?" for "+n:"",g.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:m,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,m(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";A(function e(t,n){var a,o,i,r=[];for("#"===t.id?n=-1:r.push(Array(2*n+1).join(" ")+t.text),a=0,o=t.children.length;a<o;a++)i=q("jstree","get_node",t.children[a]),r.push(e(i,n+1));return r.join("\n")}(q("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";A(function e(t,n){var a,o,i,r=[];for(t.isRootNode?n=-1:r.push(Array(2*n+1).join(" ")+t.value.p.nodeID),a=0,o=t.children.length;a<o;a++)i=t.children[a],r.push(e(i,n+1));return r.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=d.Ay.extend({},n),this.prevId&&X(this.prevId);var a=q("addQuestion",e);return t||a.p.nodeID||(t=q("nodeIDFromLabel",a)),t&&(g(d.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),d.Ay.each(n,(function(e,t){d.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?a.p[t].set(e):a.p[t]=e})),d.Ay.each(q("getSections",a),(function(e){q("collapseSection",e.slug,!1)})),a},paste:function(e,t,n){d.Ay.isString(e)||(e=h.A.tabDelimit([x].concat(e))),n&&window.console.log(e),g.deepEqual(f.A.paste(e),t||[])},clickQuestion:X,selectAll:function(){q("jstree","select_all")},deleteQuestion:function(){var e=d.Ay.map(arguments,(function(e){var t=k(e);return g(t,"mug not found: "+e),t}));q("getData").core.form.removeMugsFromForm(e),d.Ay.each(arguments,(function(e){g(!k(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=q("getData").core.saveButton;if(!d.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),g.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){q("jstree","open_node",e.ufid),q("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){q("jstree","close_node",e.ufid),q("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(d.Ay.isString(e)){var a=e;e=k(a),g(e,"mug not found: "+a)}return e.messages.each((function(e,a){a!==n&&(t.push(a+":"),n=a),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(d.Ay.isString(t)){var a=t;t=function(e){return e.text===a}}return function n(a){var o,i,r;if(t(a))return a;for(o=0,i=a.children.length;o<i;o++)if(r=n(e.get_node(a.children[o])))return r;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(d.Ay.isString(e)){var t=e;e=k(t),g(e,"mug not found: "+t)}return 0===c()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return c()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:v.A.parseXML}},3534:(e,t,n)=>{n.r(t);var a=n(8324),o=n.n(a),i=n(561),r=n.n(i),l=n(4523),s=n(1134),d=n(5319),u=n(4078),c=n(4459),f=n(9659),h=o().assert,p=d.default.showXPathEditor,v={};f.A.eventuality(v),d.default.showXPathEditor=function(){p.apply(null,arguments),v.fire("showXPathEditor")},describe("The widgets module with rich text disabled",(function(){before((function(e){s.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){h(this.isPluginEnabled("modeliteration"),"modeliteration plugin should be enabled"),e()}},features:{rich_text:!1}})})),it("xPath widget should allow drag/drop",(function(){var e=u.A.baseSpecs.databind;s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text"),h.equal(e.defaultValue.xpathType,"generic"),h(r()("[name=property-defaultValue]").hasClass("jstree-drop"),"defaultValue does not have jstree-drop class"),h.equal(e.relevantAttr.xpathType,"bool"),h(r()("[name=property-relevantAttr]").hasClass("jstree-drop"),"relevantAttr does not have jstree-drop class")})),it("xPath widget should show newlines in advanced mode",(function(e){s.A.loadXML("");var t='"line 1 \n line 2"';s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:t}),s.A.clickQuestion("/data/hidden");var n=r()("[name=property-calculateAttr]");h.equal(n.val(),'"line 1 &#10; line 2"'),n.closest(".form-group").find(".fd-edit-button").click(),v.on("showXPathEditor",(function(){var n=r()(".xpath-advanced").find("textarea").val();r()(".fd-xpath-cancel-button").click(),h.equal(n,t,"textarea content should have newline"),e()}),null,"showXPathEditor")})),it("xPath widget should escape newlines on save advanced mode",(function(e){s.A.loadXML("");var t='"line 1 \n line 2"',n=s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:""});s.A.clickQuestion("/data/hidden"),r()("[name=property-calculateAttr]").closest(".form-group").find(".fd-edit-button").click(),v.on("showXPathEditor",(function(){r()(".xpath-advanced").find("textarea").val(t).change(),r()(".fd-xpath-save-button").click();var a=r()("[name=property-calculateAttr]");h.equal(a.val(),'"line 1 &#10; line 2"',"input value not escaped"),h.equal(n.p.calculateAttr,t,"wrong mug value"),e()}),null,"showXPathEditor")})),it("xPath widget should show /data/ when in advanced editor without rich_text",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text");var t="#form/text",n=s.A.addQuestion("DataBindOnly","hidden",{calculateAttr:t});h.equal(n.p.calculateAttr,t),s.A.clickQuestion("/data/hidden"),r()("[name=property-calculateAttr]").closest(".form-group").find(".fd-edit-button").click(),v.on("showXPathEditor",(function(){var a=r()(".xpath-advanced").find("textarea");h.equal(a.val(),"/data/text","input value showing #form"),h.equal(n.p.calculateAttr,t,"value not in vellum internal form"),e()}),null,"showXPathEditor")})),it("xPath widget should genuinely hide editor whenever it's exited",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text1"),s.A.addQuestion("Text","text2");var t=r()(".fd-content-right"),n=t.find(".fd-question-properties"),a=t.find(".fd-xpath-editor");n.find(".fd-edit-button:first").click(),v.on("showXPathEditor",(function(){h(a.is(":visible"),"Editor shown when clicked"),h(!n.is(":visible"),"Properties hidden when entering editor"),s.A.clickQuestion("/data/text1"),h(n.is(":visible"),"Properties shown as requested"),h(!a.is(":visible"),"Editor hidden when properties shown"),e()}),null,"showXPathEditor")})),it("xPath widget should change save button when dropdown is changed",(function(e){s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text"),r()(".fd-content-right").find(".fd-question-properties").find(".fd-edit-button:first").click(),v.on("showXPathEditor",(function(){h(!r()(".fd-xpath-save-button").hasClass("btn-success")),r()(".op-select").change(),h(r()(".fd-xpath-save-button").hasClass("btn-success")),e()}),null,"showXPathEditor")}))})),describe("The rich text widget",(function(){before((function(e){s.A.init({javaRosa:{langs:["en"]},core:{onReady:function(){e()}},features:{rich_text:!0}})})),describe("should preserve",(function(){var e=[["id","type","labelItext:en-default"],["/newlines","Text","list\n\n* item\n* item\n"],["/spaces","Text","a  b   c    d"]];before((function(){s.A.loadXML(""),s.A.paste(e)})),l.Ay.each(e.slice(1),(function(e){var t=e[0].slice(1);it(t,(function(n){s.A.clickQuestion(t),s.A.getWidget("itext-en-label").getValue((function(t){s.A.assertEqual(t,e[2]),n()}))}))}))})),it("should return just-set value on get value",(function(){s.A.loadXML(""),s.A.addQuestion("Text","text"),s.A.clickQuestion("text");var e=s.A.getWidget("itext-en-label"),t='<output value="#form/text" />';e.setValue(t),h.equal(e.getValue(),t)})),it("should create reference to hidden value in display condition",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"],["/text","Text","test"]]),s.A.clickQuestion("text");var t=s.A.getMug("text"),n=s.A.getWidget("property-relevantAttr"),a=r()(".fd-question-tree").jstree(!0);h.equal(n.input.length,1),n.input.promise.then((function(){s.A.findNode(a,"hidden").data.handleDrop(n.input),n.handleChange(),h.equal(t.p.relevantAttr,"#form/hidden"),e()}))})),it("should change save button on drag/drop into advanced xpath editor",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"],["/text","Text","test"]]),s.A.clickQuestion("text"),r()(".fd-content-right .fd-question-properties [name=property-defaultValue]").closest(".form-group").find(".fd-edit-button").click(),v.on("showXPathEditor",(function(){var t=r()(".fd-xpath-editor-text"),n=c.A.editor(t),a=r()(".fd-question-tree").jstree(!0),o=r()(".fd-xpath-save-button");h(!o.hasClass("btn-success"),"save button should not be green"),n.on("change",(function(){h(o.hasClass("btn-success"),"save button not green"),e()})),s.A.findNode(a,"hidden").data.handleDrop(t)}),null,"showXPathEditor")})),it("simple xpath editor should change save button on remove expression",(function(e){s.A.loadXML(""),s.A.paste([["id","type","labelItext:en-default"],["/hidden","DataBindOnly","null"]]),r()(".fd-content-right .fd-question-properties [name=property-relevantAttr]").closest(".form-group").find(".fd-edit-button").click(),v.on("showXPathEditor",(function(){var t=r()(".fd-xpath-save-button");h.equal(t.length,1,"save button"),h(!t.hasClass("btn-success"),"save button should not be active");var n=r()(".fd-add-exp");h.equal(n.length,1,"add button"),h.equal(r()(".xpath-expression-group").length,1,"before add"),n.click(),h.equal(r()(".xpath-expression-group").length,2,"after add row"),h(!t.hasClass("btn-success"),"should not activate save button on add expression");var a=r()(".xpath-delete-expression").last();h.equal(a.length,1,"remove button"),a.click(),h.equal(r()(".xpath-expression-group").length,1,"after remove row"),h(t.hasClass("btn-success"),"did not activate save button after remove expression"),e()}),null,"showXPathEditor")}))}))}}]);