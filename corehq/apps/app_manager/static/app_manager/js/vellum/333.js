"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[333],{3333:(t,e,a)=>{var n=a(1134),s=a(9659),o=a(8324),r=a.n(o),i=a(561),c=a.n(i),l=a(4523),d=a(5304);const u='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n';var m=a(3092);const h='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/dob&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n',p='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob = #case/unknown" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/unknown" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/dob&quot;:null, &quot;#case/unknown&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n';var f=a(5737),g=r().assert,x=n.A.call,v=l.Ay.union(n.A.options.options.plugins||[],["databrowser"]),b=[{id:"commcaresession",uri:"jr://instance/session",path:"/session/data",name:"Session",structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/cases/case",name:"Cases",structure:{name:{}},subsets:[{id:"parent",name:"parent (mother)",key:"@case_type",structure:{edd:{}}},{id:"case",name:"child",key:"@case_type",structure:{dob:{},invalid:{}},related:{parent:{hashtag:"#case/parent",subset:"parent",subset_key:"@case_type",key:"@case_id"}}}]}];describe("The data browser",(function(){var t,e="#case/dob";function a(t,e){var a=l.Ay.find(t.instanceMetadata,(function(t){return t.attributes.src===e}));return a?a.attributes.id:null}describe("when loaded before the form",(function(){before((function(e){n.A.init({plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(b)},invalidCaseProperties:["invalid"],onReady:function(){d.A.initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add ref on drag/drop",(function(s){n.A.loadXML("");var o=n.A.addQuestion("DataBindOnly","mug"),r=c()("[name=property-calculateAttr]"),i=b[0].uri,l=b[1].uri,d=n.A.getWidget("property-calculateAttr"),m=d.input.data("editorWrapper");d.input.promise.then((function(){m.on("change",(function(){g.equal(o.p.calculateAttr,e),g.equal(a(o.form,i),"commcaresession"),g.equal(a(o.form,l),"casedb"),n.A.assertXmlEqual(x("createXML"),u,{normalize_xmlns:!0}),s()})),g.equal(a(o.form,i),null),g.equal(a(o.form,l),null),g.equal(r.length,1),n.A.findNode(t,"dob").data.handleDrop(r)}))})),it("should add parent ref on drag/drop",(function(e){n.A.loadXML("");var s=n.A.addQuestion("DataBindOnly","mug"),o=c()("[name=property-calculateAttr]"),r=b[0].uri,i=b[1].uri,l=n.A.getWidget("property-calculateAttr"),d=l.input.data("editorWrapper");l.input.promise.then((function(){d.on("change",(function(){g.equal(s.p.calculateAttr,"#case/parent/edd"),g.equal(a(s.form,r),"commcaresession"),g.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(x("createXML"),m,{normalize_xmlns:!0}),e()})),g.equal(a(s.form,r),null),g.equal(a(s.form,i),null),g.equal(o.length,1),n.A.findNode(t,"edd").data.handleDrop(o)}))})),it("should hashtagify refs when written",(function(){n.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind nodeset="/data/mug" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n'),n.A.assertXmlEqual(x("createXML"),u)})),it("is not overwritten by the forms preloaded tags",(function(){n.A.loadXML(h);var t=x("getData").core.form;g(t.isValidHashtag(e)),g.notStrictEqual(t.hashtagMap[e],null)})),it("should write externally referenced hashtags to form",(function(){n.A.loadXML(h),n.A.assertXmlEqual(x("createXML"),h,{normalize_xmlns:!0})})),it("should not write unknown referenced hashtags to form",(function(){n.A.loadXML(p);var t=c()(x("createXML")).find("h\\:head, head").children("vellum\\:hashtags, hashtags"),e=JSON.parse(c().trim(t.text()));g.deepEqual(e,{"#case/dob":null})})),it("should add the casedb instance when referencing a case in a label",(function(e){n.A.loadXML("");var s=n.A.addQuestion("Text","mug"),o=c()("[name=itext-en-label]"),r=b[0].uri,i=b[1].uri,d=n.A.getWidget("itext-en-label"),u=d.input.data("editorWrapper");d.input.promise.then((function(){u.on("change",l.Ay.debounce((function(){g.equal(s.p.labelItext.get(),'<output value="#case/dob" />'),g.equal(a(s.form,r),"commcaresession"),g.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(x("createXML"),'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" type="xsd:string" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/mug" ref="/data/mug">\n\t\t\t<label ref="jr:itext(\'mug-label\')" />\n\t\t</input>\n\t</h:body>\n</h:html>\n',{normalize_xmlns:!0}),e()}),20)),g.equal(a(s.form,r),null),g.equal(a(s.form,i),null),g.equal(o.length,1),n.A.findNode(t,"dob").data.handleDrop(o)}))})),it("should drag/drop xpath (not hashtag) when rich text is off",(function(){n.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum" vellum:ignore="richText">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/C8476EEA-C514-44FE-BF1D-F287BC8BD28C" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<dob />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/dob" nodeset="/data/dob" calculate="" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body />\n</h:html>');var e=n.A.getMug("dob"),a=c()("[name=property-calculateAttr]");g.equal(e.p.calculateAttr,""),n.A.findNode(t,"dob").data.handleDrop(a),g.equal(a.val(),"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob"),g.equal(e.p.calculateAttr,"#case/dob")})),describe("with two languages",(function(){beforeEach((function(e){n.A.init({plugins:v,javaRosa:{langs:["en","hin"]},core:{dataSourcesEndpoint:function(t){t(b)},onReady:function(){d.A.initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add the casedb instance when referencing a case in a label of non default language",(function(e){n.A.loadXML("");var s=n.A.addQuestion("Text","mug");n.A.clickQuestion("mug");var o=c()("[name=itext-hin-label]"),r=b[0].uri,i=b[1].uri,d=n.A.getWidget("itext-hin-label"),u=d.input.data("editorWrapper");d.input.promise.then((function(){u.on("change",l.Ay.debounce((function(){g.equal(s.p.labelItext.get(),""),g.equal(s.p.labelItext.get(null,"hin"),'<output value="#case/dob" />'),g.equal(a(s.form,r),"commcaresession"),g.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(x("createXML"),'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" type="xsd:string" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t\t<translation lang="hin">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/mug" ref="/data/mug">\n\t\t\t<label ref="jr:itext(\'mug-label\')" />\n\t\t</input>\n\t</h:body>\n</h:html>\n',{normalize_xmlns:!0}),e()}),20)),g.equal(a(s.form,r),null),g.equal(a(s.form,i),null),g.equal(o.length,1),n.A.findNode(t,"dob").data.handleDrop(o)}))}))})),describe("when rich_text is off",(function(){before((function(e){n.A.init({plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(b)},onReady:function(){d.A.initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}},features:{rich_text:!1}})})),it("should add ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("DataBindOnly","mug"),s=c()("[name=property-calculateAttr]"),o=b[0].uri,r=b[1].uri;g.equal(a(e.form,o),null),g.equal(a(e.form,r),null),g.equal(s.length,1),n.A.findNode(t,"dob").data.handleDrop(s),g.equal(e.p.calculateAttr,"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob"),g.equal(a(e.form,o),"commcaresession"),g.equal(a(e.form,r),"casedb")})),it("should add parent ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("DataBindOnly","mug"),s=c()("[name=property-calculateAttr]"),o=b[0].uri,r=b[1].uri;g.equal(a(e.form,o),null),g.equal(a(e.form,r),null),g.equal(s.length,1),n.A.findNode(t,"edd").data.handleDrop(s),g.equal(e.p.calculateAttr,"instance('casedb')/cases/case[@case_id = instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/index/parent]/edd"),g.equal(a(e.form,o),"commcaresession"),g.equal(a(e.form,r),"casedb")}))})),it("shouldn't show invalid properties",(function(){g.isNull(n.A.findNode(t,"invalid"),"invalid shouldn't be in case tree")}))})),describe("when loaded after the form",(function(){var t,a,o,r={};s.A.eventuality(r),before((function(e){n.A.init({plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){r.on("loadCaseData",(function(){t(b)}))},form:m,onReady:function(){t=this,o=n.A.addQuestion("DataBindOnly","blue"),(a=n.A.getWidget("property-calculateAttr")).input.promise.then(e)}}})})),it("should error for unknown properties",(function(s){a.setValue(e),a.handleChange(),g(!n.A.isTreeNodeValid(o),"expected validation error"),g.deepEqual(n.A.getMessages(o),"calculateAttr:\n  - Unknown question: #case/dob"),r.fire("loadCaseData"),function(e){d.A.initDataBrowser(t),e()}((function(){g(n.A.isTreeNodeValid(o),o.getErrors().join("\n")),s()}))}))})),describe("when loaded after the form with loaded xml",(function(){var t,a,o={};s.A.eventuality(o),beforeEach((function(e){n.A.init({plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){o.on("loadCaseData",(function(){t(b)}))},form:h,onReady:function(){t=this,(a=n.A.getWidget("property-calculateAttr")).input.promise.then(e)}}})})),it("should not error for known properties",(function(){g.strictEqual(a.getValue(),e),g.lengthOf(a.getControl().find(".label-datanode-unknown"),0),o.fire("loadCaseData"),g.strictEqual(a.getValue(),e),g.lengthOf(a.getControl().find(".label-datanode-unknown"),0)})),it("overwrites the forms preloaded tags",(function(){var t=x("getData").core.form,a="instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob";g(t.isValidHashtag(e),"invalid before test"),g.equal(t.hashtagMap[e],a),t.hashtagMap[e]=null,o.fire("loadCaseData"),g(t.isValidHashtag(e),"not valid after loadCaseData"),g.equal(t.hashtagMap[e],a)})),it("should not write unknown referenced hashtags to form",(function(){n.A.loadXML(p),o.fire("loadCaseData");var t=c()(x("createXML")).find("h\\:head, head").children("vellum\\:hashtags, hashtags"),e=JSON.parse(c().trim(t.text()));g.deepEqual(e,{"#case/dob":null})})),it("the parser and form should point to same hashtag dictionary",(function(e){var a=x("getData").core.form,s=a.hashtagMap,r=a.xpath;o.fire("loadCaseData"),function(e){d.A.initDataBrowser(t),e()}((function(){var t=x("getData").core.form,a=t.hashtagMap,o=t.xpath;g.notStrictEqual(a,s),g.strictEqual(o,r),n.A.addQuestion("Text","text");var i=r.parse("#form/text").toXPath();g.strictEqual(i,"/data/text"),e()}))})),it("should not cause null xpath",(function(){n.A.loadXML(f),o.fire("loadCaseData"),n.A.loadXML(f),n.A.assertXmlEqual(n.A.call("createXML"),f)}))})),describe("without rich text",(function(){before((function(e){n.A.init({features:{rich_text:!1},plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(b)},invalidCaseProperties:["invalid"],onReady:function(){d.A.initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("Text","mug"),s=c()("[name=itext-en-label]"),o=b[0].uri,r=b[1].uri;g.equal(a(e.form,o),null),g.equal(a(e.form,r),null),g.equal(s.length,1),n.A.findNode(t,"dob").data.handleDrop(s),g.equal(e.p.labelItext.get(),"<output value=\"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob\" />"),g.equal(a(e.form,o),"commcaresession"),g.equal(a(e.form,r),"casedb")}))})),describe("with user properties",(function(){var e=[{id:"commcaresession",uri:"jr://instance/session",path:"/session",name:"Session",structure:{data:{merge:!0,structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},context:{merge:!0,structure:{userid:{reference:{hashtag:"#user",source:"casedb",subset:"commcare-user",subset_key:"@case_type",subset_filter:!0,key:"hq_user_id"}}}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/casedb/case",name:"Cases",structure:{name:{}},subsets:[{id:"case",name:"child",key:"@case_type",structure:{dob:{},invalid:{}}},{id:"commcare-user",name:"user",key:"@case_type",structure:{code_name:{},user_role:{}}}]}];before((function(a){n.A.init({plugins:v,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(e)},invalidCaseProperties:["invalid"],onReady:function(){d.A.initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),a()}}})})),it("should drag/drop case property",(function(e){n.A.loadXML("");var a=n.A.addQuestion("DataBindOnly","mug"),s=c()("[name=property-calculateAttr]"),o=n.A.getWidget("property-calculateAttr"),r=o.input.data("editorWrapper");o.input.promise.then((function(){r.on("change",(function(){g.equal(a.p.calculateAttr,"#case/dob"),e()})),g(!a.p.calculateAttr,"unexpected: "+a.p.calculateAttr),n.A.findNode(t,"dob").data.handleDrop(s)}))})),it("should drag/drop case index",(function(e){n.A.loadXML("");var a=n.A.addQuestion("DataBindOnly","mug"),s=c()("[name=property-calculateAttr]"),o=n.A.getWidget("property-calculateAttr"),r=o.input.data("editorWrapper");o.input.promise.then((function(){r.on("change",(function(){g.equal(a.p.calculateAttr,"instance('commcaresession')/session/data/case_id"),e()})),g(!a.p.calculateAttr,"unexpected: "+a.p.calculateAttr),n.A.findNode(t,"child").data.handleDrop(s)}))})),it("should drag/drop user property",(function(e){var a=n.A.loadXML(""),s=n.A.addQuestion("DataBindOnly","mug"),o=c()("[name=property-calculateAttr]"),r=n.A.getWidget("property-calculateAttr"),i=r.input.data("editorWrapper");r.input.promise.then((function(){i.on("change",(function(){g.equal(s.p.calculateAttr,"#user/code_name"),g.equal(a.normalizeXPath("#user/code_name"),"instance('casedb')/casedb/case[@case_type = 'commcare-user'][hq_user_id = instance('commcaresession')/session/context/userid]/code_name"),e()})),g(!s.p.calculateAttr,"unexpected: "+s.p.calculateAttr),n.A.findNode(t,"code_name").data.handleDrop(o)}))}))}))}))},1134:(t,e,a)=>{a.d(e,{A:()=>D});var n=a(8449),s=a(8324),o=a.n(s),r=a(6848),i=a.n(r),c=a(3794),l=a(4523),d=a(561),u=a.n(d),m=a(1437),h=a(3809),p=a(705),f=a(7229),g=(a(1460),a(9747),o().assert),x=["Form Builder clip","version 1"];function v(t,e,a){if((a=l.Ay.defaults(a||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var n=f.A.parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+n+'"')}var s,o,r,c,d=(s=t,o=e,r=i().xml(s),c=i().xml(o),i().isEquivalent(r,c,{element_order:!0}));a.not&&(d=!d),d||b(t=q(t),e=q(e),"XML "+(a.not?"should not be equivalent":"mismatch"))}function b(t,e,a){if(t!==e){var n=(0,c.createPatch)("",t,e,"actual","expected");n=n.replace(/^Index:/,a||"Not equal:"),g(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(n))}}function q(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function w(t){return y("getCurrentMugInput",t)}function A(t){var e=u()("#vellum").vellum("get"),a=l.Ay.isString(t)?u()("[name="+t+"]"):t;return p.A.util.getWidget(a,e)}function y(){var t=Array.prototype.slice.call(arguments),e=u()("#vellum");return e.vellum.apply(e,t)}function _(){var t=[],e=l.Ay.map(arguments,(function(e){var a=l.Ay.isString(e)?j(e):e;if(!a||!a.ufid)throw new Error("mug not found: "+e);return t.push(a),a.ufid}));return y("jstree","deselect_all",!0),y("jstree","select_node",e),u()(".collapse-toggle.collapsed").click(),t}function j(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=y("getMugByPath",t);if(!e){var a=t.split("/"),n=y("getMugByPath",a.slice(0,-1).join("/"));if(n&&n.__className.indexOf("Select")>-1){var s=y("getData").core.form.getChildren(n),o=a[a.length-1];if(1===s.length&&"itemset"===o&&"itemset"===s[0].options.tagName)return s[0];for(var r=0;r<s.length;r++)if(s[r].p.nodeID===o)return s[r]}}return e}g.equal=g.strictEqual,g.notEqual=g.notStrictEqual;const D={options:n.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=u().extend(!0,{},n.A.options,t),a=u().fn.animate;u().fn.animate=function(t,e,n,s){a.apply(this,[t,0,n,s])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=l.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&l.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var s=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,s(t)};var o=u()("#vellum"),r=o.vellum("get");r&&(r.destroy(),u()("body > div.modal, body > div.modal-backdrop").remove()),o.empty().vellum(e)},call:y,loadXML:function(t,e,a,n,s=!0){var o=[],r=y("getData");return n||window.history.replaceState(null,null," "),r.core.parseWarnings=[],y("loadXML",t,e||{},{reset:s}),a?l.Ay.isRegExp(a)&&(o=l.Ay.filter(r.core.parseWarnings,(function(t){return!a.test(t)}))):o=r.core.parseWarnings,g(!o.length,"unexpected parse warnings:\n- "+o.join("\n- ")),delete r.core.parseWarnings,r.core.form},saveAndReload:function(t){y("loadXFormOrError",y("createXML"),t)},getMug:j,getInput:w,getWidget:A,getMediaUploader:function(t){var e,a={},n=A(t);if(!n)throw new Error("media uploader widget not found");if(l.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(a){return(e=t.closest(a)).length})),!e)throw new Error("media uploader element not found");return a.upload=function(t){var a={ref:{path:n.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",a)},a},assertEqual:b,assertInputCount:function(t,e,a){l.Ay.isString(t)?(a=" for "+(a?a+" ":"")+t,t=w(t)):a=a?" for "+a:"",g.equal(t.length,e,"wrong number of inputs"+a)},assertXmlEqual:v,assertXmlNotEqual:function(t,e,a){(a=a||{}).not=!0,v(t,e,a)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";b(function t(e,a){var n,s,o,r=[];for("#"===e.id?a=-1:r.push(Array(2*a+1).join(" ")+e.text),n=0,s=e.children.length;n<s;n++)o=y("jstree","get_node",e.children[n]),r.push(t(o,a+1));return r.join("\n")}(y("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";b(function t(e,a){var n,s,o,r=[];for(e.isRootNode?a=-1:r.push(Array(2*a+1).join(" ")+e.value.p.nodeID),n=0,s=e.children.length;n<s;n++)o=e.children[n],r.push(t(o,a+1));return r.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,a){a=l.Ay.extend({},a),this.prevId&&_(this.prevId);var n=y("addQuestion",t);return e||n.p.nodeID||(e=y("nodeIDFromLabel",n)),e&&(g(l.Ay.isUndefined(a.nodeID),"unexpected attribute for "+t+"["+e+"]"),n.p.labelItext&&n.p.labelItext.set(n.getLabelValue()),n.p.nodeID=e,"Choice"!==t||a.hasOwnProperty("labelItext")||(a.labelItext=e)),l.Ay.each(a,(function(t,e){l.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?n.p[e].set(t):n.p[e]=t})),l.Ay.each(y("getSections",n),(function(t){y("collapseSection",t.slug,!1)})),n},paste:function(t,e,a){l.Ay.isString(t)||(t=h.A.tabDelimit([x].concat(t))),a&&window.console.log(t),g.deepEqual(m.A.paste(t),e||[])},clickQuestion:_,selectAll:function(){y("jstree","select_all")},deleteQuestion:function(){var t=l.Ay.map(arguments,(function(t){var e=j(t);return g(e,"mug not found: "+t),e}));y("getData").core.form.removeMugsFromForm(t),l.Ay.each(arguments,(function(t){g(!j(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=y("getData").core.saveButton;if(!l.Ay.isUndefined(t)){var a=t?"save":"saved";e.setStateWhenReady(a),g.equal(e.state,a,"sanity check failed")}return"save"===e.state},expandGroup:function(t){y("jstree","open_node",t.ufid),y("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){y("jstree","close_node",t.ufid),y("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],a=null;if(l.Ay.isString(t)){var n=t;t=j(n),g(t,"mug not found: "+n)}return t.messages.each((function(t,n){n!==a&&(e.push(n+":"),a=n),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,a){if(l.Ay.isString(e)){var n=e;e=function(t){return t.text===n}}return function a(n){var s,o,r;if(e(n))return n;for(s=0,o=n.children.length;s<o;s++)if(r=a(t.get_node(n.children[s])))return r;return null}(a||t.get_node("#"))},isTreeNodeValid:function(t){if(l.Ay.isString(t)){var e=t;t=j(e),g(t,"mug not found: "+e)}return 0===u()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return u()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:f.A.parseXML}},3092:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/parent/edd" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/edd" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/parent/edd&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n'},5737:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/C8476EEA-C514-44FE-BF1D-F287BC8BD28C" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<dob />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/dob" nodeset="/data/dob" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body />\n</h:html>'}}]);