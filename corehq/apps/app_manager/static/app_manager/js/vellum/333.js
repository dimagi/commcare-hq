"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[333],{3333:(t,e,a)=>{var n=a(1134),s=a(8094),o=a.n(s),r=a(8324),i=a.n(r),c=a(561),l=a.n(c),d=a(4523),u=a(5304),m=a.n(u);const h='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n';var p=a(3092);const f='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/dob&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n',g='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/dob = #case/unknown" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/unknown" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/dob&quot;:null, &quot;#case/unknown&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n';var x=a(5737),v=i().assert,b=n.A.call,q=d.Ay.union(n.A.options.options.plugins||[],["databrowser"]),w=[{id:"commcaresession",uri:"jr://instance/session",path:"/session/data",name:"Session",structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/cases/case",name:"Cases",structure:{name:{}},subsets:[{id:"parent",name:"parent (mother)",key:"@case_type",structure:{edd:{}}},{id:"case",name:"child",key:"@case_type",structure:{dob:{},invalid:{}},related:{parent:{hashtag:"#case/parent",subset:"parent",subset_key:"@case_type",key:"@case_id"}}}]}];describe("The data browser",(function(){var t,e="#case/dob";function a(t,e){var a=d.Ay.find(t.instanceMetadata,(function(t){return t.attributes.src===e}));return a?a.attributes.id:null}describe("when loaded before the form",(function(){before((function(e){n.A.init({plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(w)},invalidCaseProperties:["invalid"],onReady:function(){m().initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add ref on drag/drop",(function(s){n.A.loadXML("");var o=n.A.addQuestion("DataBindOnly","mug"),r=l()("[name=property-calculateAttr]"),i=w[0].uri,c=w[1].uri,d=n.A.getWidget("property-calculateAttr"),u=d.input.data("editorWrapper");d.input.promise.then((function(){u.on("change",(function(){v.equal(o.p.calculateAttr,e),v.equal(a(o.form,i),"commcaresession"),v.equal(a(o.form,c),"casedb"),n.A.assertXmlEqual(b("createXML"),h,{normalize_xmlns:!0}),s()})),v.equal(a(o.form,i),null),v.equal(a(o.form,c),null),v.equal(r.length,1),n.A.findNode(t,"dob").data.handleDrop(r)}))})),it("should add parent ref on drag/drop",(function(e){n.A.loadXML("");var s=n.A.addQuestion("DataBindOnly","mug"),o=l()("[name=property-calculateAttr]"),r=w[0].uri,i=w[1].uri,c=n.A.getWidget("property-calculateAttr"),d=c.input.data("editorWrapper");c.input.promise.then((function(){d.on("change",(function(){v.equal(s.p.calculateAttr,"#case/parent/edd"),v.equal(a(s.form,r),"commcaresession"),v.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(b("createXML"),p,{normalize_xmlns:!0}),e()})),v.equal(a(s.form,r),null),v.equal(a(s.form,i),null),v.equal(o.length,1),n.A.findNode(t,"edd").data.handleDrop(o)}))})),it("should hashtagify refs when written",(function(){n.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind nodeset="/data/mug" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n'),n.A.assertXmlEqual(b("createXML"),h)})),it("is not overwritten by the forms preloaded tags",(function(){n.A.loadXML(f);var t=b("getData").core.form;v(t.isValidHashtag(e)),v.notStrictEqual(t.hashtagMap[e],null)})),it("should write externally referenced hashtags to form",(function(){n.A.loadXML(f),n.A.assertXmlEqual(b("createXML"),f,{normalize_xmlns:!0})})),it("should not write unknown referenced hashtags to form",(function(){n.A.loadXML(g);var t=l()(b("createXML")).find("h\\:head, head").children("vellum\\:hashtags, hashtags"),e=JSON.parse(l().trim(t.text()));v.deepEqual(e,{"#case/dob":null})})),it("should add the casedb instance when referencing a case in a label",(function(e){n.A.loadXML("");var s=n.A.addQuestion("Text","mug"),o=l()("[name=itext-en-label]"),r=w[0].uri,i=w[1].uri,c=n.A.getWidget("itext-en-label"),u=c.input.data("editorWrapper");c.input.promise.then((function(){u.on("change",d.Ay.debounce((function(){v.equal(s.p.labelItext.get(),'<output value="#case/dob" />'),v.equal(a(s.form,r),"commcaresession"),v.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(b("createXML"),'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" type="xsd:string" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/mug" ref="/data/mug">\n\t\t\t<label ref="jr:itext(\'mug-label\')" />\n\t\t</input>\n\t</h:body>\n</h:html>\n',{normalize_xmlns:!0}),e()}),20)),v.equal(a(s.form,r),null),v.equal(a(s.form,i),null),v.equal(o.length,1),n.A.findNode(t,"dob").data.handleDrop(o)}))})),it("should drag/drop xpath (not hashtag) when rich text is off",(function(){n.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum" vellum:ignore="richText">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/C8476EEA-C514-44FE-BF1D-F287BC8BD28C" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<dob />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/dob" nodeset="/data/dob" calculate="" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body />\n</h:html>');var e=n.A.getMug("dob"),a=l()("[name=property-calculateAttr]");v.equal(e.p.calculateAttr,""),n.A.findNode(t,"dob").data.handleDrop(a),v.equal(a.val(),"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob"),v.equal(e.p.calculateAttr,"#case/dob")})),describe("with two languages",(function(){beforeEach((function(e){n.A.init({plugins:q,javaRosa:{langs:["en","hin"]},core:{dataSourcesEndpoint:function(t){t(w)},onReady:function(){m().initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add the casedb instance when referencing a case in a label of non default language",(function(e){n.A.loadXML("");var s=n.A.addQuestion("Text","mug");n.A.clickQuestion("mug");var o=l()("[name=itext-hin-label]"),r=w[0].uri,i=w[1].uri,c=n.A.getWidget("itext-hin-label"),u=c.input.data("editorWrapper");c.input.promise.then((function(){u.on("change",d.Ay.debounce((function(){v.equal(s.p.labelItext.get(),""),v.equal(s.p.labelItext.get(null,"hin"),'<output value="#case/dob" />'),v.equal(a(s.form,r),"commcaresession"),v.equal(a(s.form,i),"casedb"),n.A.assertXmlEqual(b("createXML"),'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" type="xsd:string" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t\t<translation lang="hin">\n\t\t\t\t\t<text id="mug-label">\n\t\t\t\t\t\t<value><output value="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" vellum:value="#case/dob" /></value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/mug" ref="/data/mug">\n\t\t\t<label ref="jr:itext(\'mug-label\')" />\n\t\t</input>\n\t</h:body>\n</h:html>\n',{normalize_xmlns:!0}),e()}),20)),v.equal(a(s.form,r),null),v.equal(a(s.form,i),null),v.equal(o.length,1),n.A.findNode(t,"dob").data.handleDrop(o)}))}))})),describe("when rich_text is off",(function(){before((function(e){n.A.init({plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(w)},onReady:function(){m().initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}},features:{rich_text:!1}})})),it("should add ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("DataBindOnly","mug"),s=l()("[name=property-calculateAttr]"),o=w[0].uri,r=w[1].uri;v.equal(a(e.form,o),null),v.equal(a(e.form,r),null),v.equal(s.length,1),n.A.findNode(t,"dob").data.handleDrop(s),v.equal(e.p.calculateAttr,"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob"),v.equal(a(e.form,o),"commcaresession"),v.equal(a(e.form,r),"casedb")})),it("should add parent ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("DataBindOnly","mug"),s=l()("[name=property-calculateAttr]"),o=w[0].uri,r=w[1].uri;v.equal(a(e.form,o),null),v.equal(a(e.form,r),null),v.equal(s.length,1),n.A.findNode(t,"edd").data.handleDrop(s),v.equal(e.p.calculateAttr,"instance('casedb')/cases/case[@case_id = instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/index/parent]/edd"),v.equal(a(e.form,o),"commcaresession"),v.equal(a(e.form,r),"casedb")}))})),it("shouldn't show invalid properties",(function(){v.isNull(n.A.findNode(t,"invalid"),"invalid shouldn't be in case tree")}))})),describe("when loaded after the form",(function(){var t,a,s,r={};o().eventuality(r),before((function(e){n.A.init({plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){r.on("loadCaseData",(function(){t(w)}))},form:p,onReady:function(){t=this,s=n.A.addQuestion("DataBindOnly","blue"),(a=n.A.getWidget("property-calculateAttr")).input.promise.then(e)}}})})),it("should error for unknown properties",(function(o){a.setValue(e),a.handleChange(),v(!n.A.isTreeNodeValid(s),"expected validation error"),v.deepEqual(n.A.getMessages(s),"calculateAttr:\n  - Unknown question: #case/dob"),r.fire("loadCaseData"),function(e){m().initDataBrowser(t),e()}((function(){v(n.A.isTreeNodeValid(s),s.getErrors().join("\n")),o()}))}))})),describe("when loaded after the form with loaded xml",(function(){var t,a,s={};o().eventuality(s),beforeEach((function(e){n.A.init({plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){s.on("loadCaseData",(function(){t(w)}))},form:f,onReady:function(){t=this,(a=n.A.getWidget("property-calculateAttr")).input.promise.then(e)}}})})),it("should not error for known properties",(function(){v.strictEqual(a.getValue(),e),v.lengthOf(a.getControl().find(".label-datanode-unknown"),0),s.fire("loadCaseData"),v.strictEqual(a.getValue(),e),v.lengthOf(a.getControl().find(".label-datanode-unknown"),0)})),it("overwrites the forms preloaded tags",(function(){var t=b("getData").core.form,a="instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob";v(t.isValidHashtag(e),"invalid before test"),v.equal(t.hashtagMap[e],a),t.hashtagMap[e]=null,s.fire("loadCaseData"),v(t.isValidHashtag(e),"not valid after loadCaseData"),v.equal(t.hashtagMap[e],a)})),it("should not write unknown referenced hashtags to form",(function(){n.A.loadXML(g),s.fire("loadCaseData");var t=l()(b("createXML")).find("h\\:head, head").children("vellum\\:hashtags, hashtags"),e=JSON.parse(l().trim(t.text()));v.deepEqual(e,{"#case/dob":null})})),it("the parser and form should point to same hashtag dictionary",(function(e){var a=b("getData").core.form,o=a.hashtagMap,r=a.xpath;s.fire("loadCaseData"),function(e){m().initDataBrowser(t),e()}((function(){var t=b("getData").core.form,a=t.hashtagMap,s=t.xpath;v.notStrictEqual(a,o),v.strictEqual(s,r),n.A.addQuestion("Text","text");var i=r.parse("#form/text").toXPath();v.strictEqual(i,"/data/text"),e()}))})),it("should not cause null xpath",(function(){n.A.loadXML(x),s.fire("loadCaseData"),n.A.loadXML(x),n.A.assertXmlEqual(n.A.call("createXML"),x)}))})),describe("without rich text",(function(){before((function(e){n.A.init({features:{rich_text:!1},plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(w)},invalidCaseProperties:["invalid"],onReady:function(){m().initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),e()}}})})),it("should add ref on drag/drop",(function(){n.A.loadXML("");var e=n.A.addQuestion("Text","mug"),s=l()("[name=itext-en-label]"),o=w[0].uri,r=w[1].uri;v.equal(a(e.form,o),null),v.equal(a(e.form,r),null),v.equal(s.length,1),n.A.findNode(t,"dob").data.handleDrop(s),v.equal(e.p.labelItext.get(),"<output value=\"instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/dob\" />"),v.equal(a(e.form,o),"commcaresession"),v.equal(a(e.form,r),"casedb")}))})),describe("with user properties",(function(){var e=[{id:"commcaresession",uri:"jr://instance/session",path:"/session",name:"Session",structure:{data:{merge:!0,structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},context:{merge:!0,structure:{userid:{reference:{hashtag:"#user",source:"casedb",subset:"commcare-user",subset_key:"@case_type",subset_filter:!0,key:"hq_user_id"}}}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/casedb/case",name:"Cases",structure:{name:{}},subsets:[{id:"case",name:"child",key:"@case_type",structure:{dob:{},invalid:{}}},{id:"commcare-user",name:"user",key:"@case_type",structure:{code_name:{},user_role:{}}}]}];before((function(a){n.A.init({plugins:q,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(e)},invalidCaseProperties:["invalid"],onReady:function(){m().initDataBrowser(this),t=this.$f.find(".fd-external-sources-tree").jstree(!0),a()}}})})),it("should drag/drop case property",(function(e){n.A.loadXML("");var a=n.A.addQuestion("DataBindOnly","mug"),s=l()("[name=property-calculateAttr]"),o=n.A.getWidget("property-calculateAttr"),r=o.input.data("editorWrapper");o.input.promise.then((function(){r.on("change",(function(){v.equal(a.p.calculateAttr,"#case/dob"),e()})),v(!a.p.calculateAttr,"unexpected: "+a.p.calculateAttr),n.A.findNode(t,"dob").data.handleDrop(s)}))})),it("should drag/drop case index",(function(e){n.A.loadXML("");var a=n.A.addQuestion("DataBindOnly","mug"),s=l()("[name=property-calculateAttr]"),o=n.A.getWidget("property-calculateAttr"),r=o.input.data("editorWrapper");o.input.promise.then((function(){r.on("change",(function(){v.equal(a.p.calculateAttr,"instance('commcaresession')/session/data/case_id"),e()})),v(!a.p.calculateAttr,"unexpected: "+a.p.calculateAttr),n.A.findNode(t,"child").data.handleDrop(s)}))})),it("should drag/drop user property",(function(e){var a=n.A.loadXML(""),s=n.A.addQuestion("DataBindOnly","mug"),o=l()("[name=property-calculateAttr]"),r=n.A.getWidget("property-calculateAttr"),i=r.input.data("editorWrapper");r.input.promise.then((function(){i.on("change",(function(){v.equal(s.p.calculateAttr,"#user/code_name"),v.equal(a.normalizeXPath("#user/code_name"),"instance('casedb')/casedb/case[@case_type = 'commcare-user'][hq_user_id = instance('commcaresession')/session/context/userid]/code_name"),e()})),v(!s.p.calculateAttr,"unexpected: "+s.p.calculateAttr),n.A.findNode(t,"code_name").data.handleDrop(o)}))}))}))}))},1134:(t,e,a)=>{a.d(e,{A:()=>F});var n=a(8449),s=a(8324),o=a.n(s),r=a(6848),i=a.n(r),c=a(3794),l=a.n(c),d=a(4523),u=a(561),m=a.n(u),h=a(1437),p=a.n(h),f=a(3809),g=a.n(f),x=a(705),v=a.n(x),b=a(7229),q=a.n(b),w=(a(1460),a(8803),o().assert),A=["Form Builder clip","version 1"];function y(t,e,a){if((a=d.Ay.defaults(a||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var n=q().parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+n+'"')}var s,o,r,c,l=(s=t,o=e,r=i().xml(s),c=i().xml(o),i().isEquivalent(r,c,{element_order:!0}));a.not&&(l=!l),l||_(t=j(t),e=j(e),"XML "+(a.not?"should not be equivalent":"mismatch"))}function _(t,e,a){if(t!==e){var n=l().createPatch("",t,e,"actual","expected");n=n.replace(/^Index:/,a||"Not equal:"),w(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(n))}}function j(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function D(t){return E("getCurrentMugInput",t)}function C(t){var e=m()("#vellum").vellum("get"),a=d.Ay.isString(t)?m()("[name="+t+"]"):t;return v().util.getWidget(a,e)}function E(){var t=Array.prototype.slice.call(arguments),e=m()("#vellum");return e.vellum.apply(e,t)}function M(){var t=[],e=d.Ay.map(arguments,(function(e){var a=d.Ay.isString(e)?X(e):e;if(!a||!a.ufid)throw new Error("mug not found: "+e);return t.push(a),a.ufid}));return E("jstree","deselect_all",!0),E("jstree","select_node",e),m()(".collapse-toggle.collapsed").click(),t}function X(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=E("getMugByPath",t);if(!e){var a=t.split("/"),n=E("getMugByPath",a.slice(0,-1).join("/"));if(n&&n.__className.indexOf("Select")>-1){var s=E("getData").core.form.getChildren(n),o=a[a.length-1];if(1===s.length&&"itemset"===o&&"itemset"===s[0].options.tagName)return s[0];for(var r=0;r<s.length;r++)if(s[r].p.nodeID===o)return s[r]}}return e}w.equal=w.strictEqual,w.notEqual=w.notStrictEqual;const F={options:n.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=m().extend(!0,{},n.A.options,t),a=m().fn.animate;m().fn.animate=function(t,e,n,s){a.apply(this,[t,0,n,s])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=d.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&d.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var s=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,s(t)};var o=m()("#vellum"),r=o.vellum("get");r&&(r.destroy(),m()("body > div.modal, body > div.modal-backdrop").remove()),o.empty().vellum(e)},call:E,loadXML:function(t,e,a,n){var s=[],o=E("getData");return n||window.history.replaceState(null,null," "),o.core.parseWarnings=[],E("loadXML",t,e||{}),a?d.Ay.isRegExp(a)&&(s=d.Ay.filter(o.core.parseWarnings,(function(t){return!a.test(t)}))):s=o.core.parseWarnings,w(!s.length,"unexpected parse warnings:\n- "+s.join("\n- ")),delete o.core.parseWarnings,o.core.form},saveAndReload:function(t){E("loadXFormOrError",E("createXML"),t)},getMug:X,getInput:D,getWidget:C,getMediaUploader:function(t){var e,a={},n=C(t);if(!n)throw new Error("media uploader widget not found");if(d.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(a){return(e=t.closest(a)).length})),!e)throw new Error("media uploader element not found");return a.upload=function(t){var a={ref:{path:n.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",a)},a},assertEqual:_,assertInputCount:function(t,e,a){d.Ay.isString(t)?(a=" for "+(a?a+" ":"")+t,t=D(t)):a=a?" for "+a:"",w.equal(t.length,e,"wrong number of inputs"+a)},assertXmlEqual:y,assertXmlNotEqual:function(t,e,a){(a=a||{}).not=!0,y(t,e,a)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";_(function t(e,a){var n,s,o,r=[];for("#"===e.id?a=-1:r.push(Array(2*a+1).join(" ")+e.text),n=0,s=e.children.length;n<s;n++)o=E("jstree","get_node",e.children[n]),r.push(t(o,a+1));return r.join("\n")}(E("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";_(function t(e,a){var n,s,o,r=[];for(e.isRootNode?a=-1:r.push(Array(2*a+1).join(" ")+e.value.p.nodeID),n=0,s=e.children.length;n<s;n++)o=e.children[n],r.push(t(o,a+1));return r.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,a){a=d.Ay.extend({},a),this.prevId&&M(this.prevId);var n=E("addQuestion",t);return e||n.p.nodeID||(e=E("nodeIDFromLabel",n)),e&&(w(d.Ay.isUndefined(a.nodeID),"unexpected attribute for "+t+"["+e+"]"),n.p.labelItext&&n.p.labelItext.set(n.getLabelValue()),n.p.nodeID=e,"Choice"!==t||a.hasOwnProperty("labelItext")||(a.labelItext=e)),d.Ay.each(a,(function(t,e){d.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?n.p[e].set(t):n.p[e]=t})),d.Ay.each(E("getSections",n),(function(t){E("collapseSection",t.slug,!1)})),n},paste:function(t,e,a){d.Ay.isString(t)||(t=g().tabDelimit([A].concat(t))),a&&window.console.log(t),w.deepEqual(p().paste(t),e||[])},clickQuestion:M,selectAll:function(){E("jstree","select_all")},deleteQuestion:function(){var t=d.Ay.map(arguments,(function(t){var e=X(t);return w(e,"mug not found: "+t),e}));E("getData").core.form.removeMugsFromForm(t),d.Ay.each(arguments,(function(t){w(!X(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=E("getData").core.saveButton;if(!d.Ay.isUndefined(t)){var a=t?"save":"saved";e.setStateWhenReady(a),w.equal(e.state,a,"sanity check failed")}return"save"===e.state},expandGroup:function(t){E("jstree","open_node",t.ufid),E("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){E("jstree","close_node",t.ufid),E("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],a=null;if(d.Ay.isString(t)){var n=t;t=X(n),w(t,"mug not found: "+n)}return t.messages.each((function(t,n){n!==a&&(e.push(n+":"),a=n),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,a){if(d.Ay.isString(e)){var n=e;e=function(t){return t.text===n}}return function a(n){var s,o,r;if(e(n))return n;for(s=0,o=n.children.length;s<o;s++)if(r=a(t.get_node(n.children[s])))return r;return null}(a||t.get_node("#"))},isTreeNodeValid:function(t){if(d.Ay.isString(t)){var e=t;t=X(e),w(t,"mug not found: "+e)}return 0===m()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return m()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:q().parseXML}},3092:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/DC38FCC5-930C-4385-AE6C-5B15ED1F95B1" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<mug />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance id="commcaresession" src="jr://instance/session" />\n\t\t\t<bind vellum:nodeset="#form/mug" nodeset="/data/mug" vellum:calculate="#case/parent/edd" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/edd" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>\n\t\t\t{&quot;#case/parent/edd&quot;:null}\n\t\t</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body>\n\t</h:body>\n</h:html>\n'},5737:t=>{t.exports='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/C8476EEA-C514-44FE-BF1D-F287BC8BD28C" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<dob />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<instance src="jr://instance/session" id="commcaresession" />\n\t\t\t<bind vellum:nodeset="#form/dob" nodeset="/data/dob" vellum:calculate="#case/dob" calculate="instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/dob" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="" />\n\t\t\t</itext>\n\t\t</model>\n\t\t<vellum:hashtags>{&quot;#case/dob&quot;:null}</vellum:hashtags>\n\t\t<vellum:hashtagTransforms>{&quot;prefixes&quot;:{&quot;#case/parent/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/index/parent]/&quot;,&quot;#case/&quot;:&quot;instance(\'casedb\')/cases/case[@case_id = instance(\'commcaresession\')/session/data/case_id]/&quot;}}</vellum:hashtagTransforms>\n\t</h:head>\n\t<h:body />\n</h:html>'}}]);