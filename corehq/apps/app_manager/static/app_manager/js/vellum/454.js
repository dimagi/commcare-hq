"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[454],{6073:(t,e,n)=>{var o=n(1134),a=n(8324),r=n.n(a),i=n(561),s=n.n(i),l=n(4523),u=r().assert,c=[{id:"commcaresession",uri:"jr://instance/session",path:"/session/data",name:"Session",structure:{case_id:{reference:{hashtag:"#case/child",source:"casedb",subset:"child",subset_key:"@case_type",key:"@case_id"}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/cases/case",name:"Cases",structure:{name:{}},subsets:[{id:"child",key:"@case_type",structure:{dob:{}}}]}];function d(t){var e=o.A.call("getData").core.form.fuse.search(t);return e.length?e[0]:null}function f(){return s()(".atwho-view").filter((function(){return"block"===s()(this).css("display")}))}function h(t){u.strictEqual(f().find("li").length,t)}describe("atwho",(function(){describe("without rich text",(function(){function t(t){var e=o.A.clickQuestion("one")[0],n=s()("[name=property-relevantAttr]");n.focus(),n.val("/data/").keyup(),u.strictEqual(f().length,1);try{t(e)}catch(t){throw t}finally{e.fire("teardown-mug-properties")}u(!f().length)}before((function(t){o.A.init({javaRosa:{langs:["en"]},core:{form:'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="undefined" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<one />\n\t\t\t\t\t<long />\n\t\t\t\t\t<Choice_Question />\n\t\t\t\t\t<question4 ids="" count="" current_index="" vellum:role="Repeat">\n\t\t\t\t\t\t<item id="" index="" jr:template="" />\n\t\t\t\t\t</question4>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb" />\n\t\t\t<bind vellum:nodeset="#form/one" nodeset="/data/one" type="xsd:string" />\n\t\t\t<bind vellum:nodeset="#form/long" nodeset="/data/long" type="xsd:string" />\n\t\t\t<bind vellum:nodeset="#form/Choice_Question" nodeset="/data/Choice_Question" />\n\t\t\t<bind nodeset="/data/question4/@current_index" vellum:calculate="count(#form/question4/item)" calculate="count(/data/question4/item)" />\n\t\t\t<bind vellum:nodeset="#form/question4/item" nodeset="/data/question4/item" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/question4/@ids" value="join(\' \', instance(\'casedb\')/mother/child/@case_id)" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/question4/@count" value="count-selected(/data/question4/@ids)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/question4/item/@index" value="int(/data/question4/@current_index)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/question4/item/@id" value="selected-at(/data/question4/@ids, ../@index)" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="one-label">\n\t\t\t\t\t\t<value>One</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="long-label">\n\t\t\t\t\t\t<value>This is going to be a really long display name that should be truncated</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="Choice_Question-label">\n\t\t\t\t\t\t<value>Choice_Question</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="Choice_Question-choice1-label">\n\t\t\t\t\t\t<value>Don\'t show up</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="question4/item-label">\n\t\t\t\t\t\t<value>question4</value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<input vellum:ref="#form/one" ref="/data/one">\n\t\t\t<label ref="jr:itext(\'one-label\')" />\n\t\t</input>\n\t\t<input vellum:ref="#form/long" ref="/data/long">\n\t\t\t<label ref="jr:itext(\'long-label\')" />\n\t\t</input>\n\t\t<select1 vellum:ref="#form/Choice_Question" ref="/data/Choice_Question">\n\t\t\t<label ref="jr:itext(\'Choice_Question-label\')" />\n\t\t\t<item>\n\t\t\t\t<label ref="jr:itext(\'Choice_Question-choice1-label\')" />\n\t\t\t\t<value>choice1</value>\n\t\t\t</item>\n\t\t</select1>\n\t\t<group>\n\t\t\t<label ref="jr:itext(\'question4/item-label\')" />\n\t\t\t<repeat jr:count="/data/question4/@count" jr:noAddRemove="true()" vellum:nodeset="#form/question4/item" nodeset="/data/question4/item" />\n\t\t</group>\n\t</h:body>\n</h:html>\n',onReady:function(){t()}},features:{rich_text:!1},plugins:["atwho","modeliteration"]})})),it("should truncate the display label",(function(){var t=d("one");u.strictEqual(t.displayLabel,"One"),t=d("long"),u.strictEqual(t.displayLabel,"This is going to be a rea&hellip;")})),it("should not show mugs without absolutePath",(function(){t((function(t){u(!f().find('li:contains("choice1")').length)}))})),it("should have each mug",(function(){t((function(t){h(3)}))})),it("should destroy the atwho container on mug removal",(function(){t((function(t){t.fire("teardown-mug-properties"),u(!f().length)}))})),it("should not show itself in the results",(function(){t((function(t){h(3)}))})),it("should show questions with /data/",(function(){t((function(t){l.Ay.map(f().find("li"),(function(t){var e=s().trim(s()(t).text());u(e.startsWith("/data/"))}))}))}))})),describe("with rich text",(function(){var t;function e(e,n){const a=o.A.getMug("text3"),r=s()("[name=property-defaultValue]");r.text(e);const i=document.createRange(),l=r[0].childNodes[0];i.setStart(l,l.length),i.setEnd(l,l.length);const c=window.getSelection();c.removeAllRanges(),c.addRange(i),t.input.focus(),r.trigger("keyup"),u.strictEqual(f().length,1);try{n(a)}catch(t){throw t}finally{a.fire("teardown-mug-properties")}u(!f().length)}beforeEach((function(e){o.A.init({javaRosa:{langs:["en"]},core:{form:"",dataSourcesEndpoint:function(t){t(c)},onReady:function(){o.A.addQuestion("Text","dash-dash"),o.A.addQuestion("Text","text"),o.A.addQuestion("Text","text2"),o.A.addQuestion("Text","text3"),(t=o.A.getWidget("property-defaultValue")).input.promise.then((function(){e()}))}},plugins:["atwho","modeliteration","databrowser"]})})),it("should show questions with #form",(function(){e("#formâ€‹",(function(t){var e=f().find("li"),n=l.Ay.map(e,(function(t){return s().trim(s()(t).text()).replace(/\n[^]*$/,"")}));u.deepEqual(n,["#form/dash-dash","#form/text","#form/text2"])}))})),it("should show questions after a dash",(function(){e("#dash-dashâ€‹",(function(t){var e=f().find("li"),n=l.Ay.map(e,(function(t){return s().trim(s()(t).text()).replace(/\n[^]*$/,"")}));u.deepEqual(n,["#form/dash-dash"])}))})),it("should show case properties with #case",(function(){e("#caseâ€‹",(function(t){var e=f().find("li"),n=l.Ay.map(e,(function(t){return s().trim(s()(t).text()).replace(/\n[^]*$/,"")}));u.deepEqual(n,["#case/child/dob"])}))})),it("should show case properties and form questions with #",(function(){e("#â€‹",(function(t){var e=f().find("li"),n=l.Ay.map(e,(function(t){return s().trim(s()(t).text()).replace(/\n[^]*$/,"")}));u.deepEqual(n,["#case/child/dob","#form/dash-dash","#form/text","#form/text2"])}))}))}))}))},1134:(t,e,n)=>{n.d(e,{A:()=>C});var o=n(8449),a=n(8324),r=n.n(a),i=n(6848),s=n.n(i),l=n(3794),u=n(4523),c=n(561),d=n.n(c),f=n(1437),h=n.n(f),m=n(3809),p=n.n(m),g=n(705),v=n.n(g),x=n(7229),y=n.n(x),b=(n(1460),n(8803),r().assert),w=["Form Builder clip","version 1"];function A(t,e,n){if((n=u.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var o=y().parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+o+'"')}var a,r,i,l,c=(a=t,r=e,i=s().xml(a),l=s().xml(r),s().isEquivalent(i,l,{element_order:!0}));n.not&&(c=!c),c||q(t=j(t),e=j(e),"XML "+(n.not?"should not be equivalent":"mismatch"))}function q(t,e,n){if(t!==e){var o=(0,l.createPatch)("",t,e,"actual","expected");o=o.replace(/^Index:/,n||"Not equal:"),b(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(o))}}function j(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function _(t){return S("getCurrentMugInput",t)}function E(t){var e=d()("#vellum").vellum("get"),n=u.Ay.isString(t)?d()("[name="+t+"]"):t;return v().util.getWidget(n,e)}function S(){var t=Array.prototype.slice.call(arguments),e=d()("#vellum");return e.vellum.apply(e,t)}function k(){var t=[],e=u.Ay.map(arguments,(function(e){var n=u.Ay.isString(e)?Q(e):e;if(!n||!n.ufid)throw new Error("mug not found: "+e);return t.push(n),n.ufid}));return S("jstree","deselect_all",!0),S("jstree","select_node",e),d()(".collapse-toggle.collapsed").click(),t}function Q(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=S("getMugByPath",t);if(!e){var n=t.split("/"),o=S("getMugByPath",n.slice(0,-1).join("/"));if(o&&o.__className.indexOf("Select")>-1){var a=S("getData").core.form.getChildren(o),r=n[n.length-1];if(1===a.length&&"itemset"===r&&"itemset"===a[0].options.tagName)return a[0];for(var i=0;i<a.length;i++)if(a[i].p.nodeID===r)return a[i]}}return e}b.equal=b.strictEqual,b.notEqual=b.notStrictEqual;const C={options:o.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=d().extend(!0,{},o.A.options,t),n=d().fn.animate;d().fn.animate=function(t,e,o,a){n.apply(this,[t,0,o,a])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=u.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&u.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var a=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,a(t)};var r=d()("#vellum"),i=r.vellum("get");i&&(i.destroy(),d()("body > div.modal, body > div.modal-backdrop").remove()),r.empty().vellum(e)},call:S,loadXML:function(t,e,n,o,a=!0){var r=[],i=S("getData");return o||window.history.replaceState(null,null," "),i.core.parseWarnings=[],S("loadXML",t,e||{},{reset:a}),n?u.Ay.isRegExp(n)&&(r=u.Ay.filter(i.core.parseWarnings,(function(t){return!n.test(t)}))):r=i.core.parseWarnings,b(!r.length,"unexpected parse warnings:\n- "+r.join("\n- ")),delete i.core.parseWarnings,i.core.form},saveAndReload:function(t){S("loadXFormOrError",S("createXML"),t)},getMug:Q,getInput:_,getWidget:E,getMediaUploader:function(t){var e,n={},o=E(t);if(!o)throw new Error("media uploader widget not found");if(u.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(e=t.closest(n)).length})),!e)throw new Error("media uploader element not found");return n.upload=function(t){var n={ref:{path:o.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",n)},n},assertEqual:q,assertInputCount:function(t,e,n){u.Ay.isString(t)?(n=" for "+(n?n+" ":"")+t,t=_(t)):n=n?" for "+n:"",b.equal(t.length,e,"wrong number of inputs"+n)},assertXmlEqual:A,assertXmlNotEqual:function(t,e,n){(n=n||{}).not=!0,A(t,e,n)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";q(function t(e,n){var o,a,r,i=[];for("#"===e.id?n=-1:i.push(Array(2*n+1).join(" ")+e.text),o=0,a=e.children.length;o<a;o++)r=S("jstree","get_node",e.children[o]),i.push(t(r,n+1));return i.join("\n")}(S("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";q(function t(e,n){var o,a,r,i=[];for(e.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+e.value.p.nodeID),o=0,a=e.children.length;o<a;o++)r=e.children[o],i.push(t(r,n+1));return i.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,n){n=u.Ay.extend({},n),this.prevId&&k(this.prevId);var o=S("addQuestion",t);return e||o.p.nodeID||(e=S("nodeIDFromLabel",o)),e&&(b(u.Ay.isUndefined(n.nodeID),"unexpected attribute for "+t+"["+e+"]"),o.p.labelItext&&o.p.labelItext.set(o.getLabelValue()),o.p.nodeID=e,"Choice"!==t||n.hasOwnProperty("labelItext")||(n.labelItext=e)),u.Ay.each(n,(function(t,e){u.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?o.p[e].set(t):o.p[e]=t})),u.Ay.each(S("getSections",o),(function(t){S("collapseSection",t.slug,!1)})),o},paste:function(t,e,n){u.Ay.isString(t)||(t=p().tabDelimit([w].concat(t))),n&&window.console.log(t),b.deepEqual(h().paste(t),e||[])},clickQuestion:k,selectAll:function(){S("jstree","select_all")},deleteQuestion:function(){var t=u.Ay.map(arguments,(function(t){var e=Q(t);return b(e,"mug not found: "+t),e}));S("getData").core.form.removeMugsFromForm(t),u.Ay.each(arguments,(function(t){b(!Q(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=S("getData").core.saveButton;if(!u.Ay.isUndefined(t)){var n=t?"save":"saved";e.setStateWhenReady(n),b.equal(e.state,n,"sanity check failed")}return"save"===e.state},expandGroup:function(t){S("jstree","open_node",t.ufid),S("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){S("jstree","close_node",t.ufid),S("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],n=null;if(u.Ay.isString(t)){var o=t;t=Q(o),b(t,"mug not found: "+o)}return t.messages.each((function(t,o){o!==n&&(e.push(o+":"),n=o),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,n){if(u.Ay.isString(e)){var o=e;e=function(t){return t.text===o}}return function n(o){var a,r,i;if(e(o))return o;for(a=0,r=o.children.length;a<r;a++)if(i=n(t.get_node(o.children[a])))return i;return null}(n||t.get_node("#"))},isTreeNodeValid:function(t){if(u.Ay.isString(t)){var e=t;t=Q(e),b(t,"mug not found: "+e)}return 0===d()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return d()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:y().parseXML}}}]);