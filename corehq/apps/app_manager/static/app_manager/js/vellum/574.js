"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[574],{7574:(t,e,n)=>{var a=n(8324),r=n.n(a),o=n(561),d=n.n(o),i=n(4523),s=n(1134);const u='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/28B1D8B9-1144-4600-968A-349FD99FFCA5" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<child ids="" count="" current_index="" vellum:role="Repeat">\n\t\t\t\t\t\t<item id="" index="" jr:template="" />\n\t\t\t\t\t</child>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="casedb" src="jr://instance/casedb"></instance>\n\t\t\t<bind nodeset="/data/child/@current_index" vellum:calculate="count(#form/child/item)" calculate="count(/data/child/item)" />\n\t\t\t<bind vellum:nodeset="#form/child/item" nodeset="/data/child/item" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/child/@ids" value="join(\' \', instance(\'casedb\')/mother/child/@case_id)" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/child/@count" value="count-selected(/data/child/@ids)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/child/item/@index" value="int(/data/child/@current_index)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/child/item/@id" value="selected-at(/data/child/@ids, ../@index)" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<group>\n\t\t\t<repeat vellum:nodeset="#form/child/item" nodeset="/data/child/item" jr:count="/data/child/@count" jr:noAddRemove="true()" />\n\t\t</group>\n\t</h:body>\n</h:html>\n',l='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/F38617FC-F2C2-4B94-90BC-CF1B77407F85" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<group ids="" count="" current_index="" vellum:role="Repeat">\n\t\t\t\t\t\t<item id="" index="" jr:template="">\n\t\t\t\t\t\t\t<phone />\n\t\t\t\t\t\t\t<hidden />\n\t\t\t\t\t\t</item>\n\t\t\t\t\t</group>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb"></instance>\n\t\t\t<bind nodeset="/data/group/@current_index" vellum:calculate="count(#form/group/item)" calculate="count(/data/group/item)" />\n\t\t\t<bind vellum:nodeset="#form/group/item" nodeset="/data/group/item" />\n\t\t\t<bind vellum:nodeset="#form/group/item/phone" nodeset="/data/group/item/phone" type="xsd:string" />\n\t\t\t<bind vellum:nodeset="#form/group/item/hidden" nodeset="/data/group/item/hidden" vellum:calculate="#form/group/item/phone = \'12345\'" calculate="/data/group/item/phone = \'12345\'" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/group/@ids" value="join(\' \', instance(\'casedb\')/mother/child/@case_id)" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/group/@count" value="count-selected(/data/group/@ids)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/group/item/@index" value="int(/data/group/@current_index)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/group/item/@id" value="selected-at(/data/group/@ids, ../@index)" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<group>\n\t\t\t<repeat jr:count="/data/group/@count" jr:noAddRemove="true()" vellum:nodeset="#form/group/item" nodeset="/data/group/item">\n\t\t\t\t<input vellum:ref="#form/group/item/phone" ref="/data/group/item/phone" appearance="numeric"/>\n\t\t\t</repeat>\n\t\t</group>\n\t</h:body>\n</h:html>\n',c='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/F38617FC-F2C2-4B94-90BC-CF1B77407F85" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<hidden />\n\t\t\t\t\t<group ids="" count="" current_index="" vellum:role="Repeat">\n\t\t\t\t\t\t<item id="" index="" jr:template="">\n\t\t\t\t\t\t\t<phone />\n\t\t\t\t\t\t\t<hidden />\n\t\t\t\t\t\t</item>\n\t\t\t\t\t</group>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance src="jr://instance/casedb" id="casedb"></instance>\n\t\t\t<bind vellum:nodeset="#form/hidden" nodeset="/data/hidden" />\n\t\t\t<bind nodeset="/data/group/@current_index" vellum:calculate="count(#form/group/item)" calculate="count(/data/group/item)" />\n\t\t\t<bind vellum:nodeset="#form/group/item" nodeset="/data/group/item" />\n\t\t\t<bind vellum:nodeset="#form/group/item/phone" nodeset="/data/group/item/phone" type="xsd:string" />\n\t\t\t<bind vellum:nodeset="#form/group/item/hidden" nodeset="/data/group/item/hidden" vellum:calculate="#form/group/item/phone = \'12345\'" calculate="/data/group/item/phone = \'12345\'" />\n\t\t\t<setvalue event="xforms-ready" vellum:ref="#form/hidden" ref="/data/hidden" value="\'blah\'" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/group/@ids" value="join(\' \', instance(\'casedb\')/mother/child/@case_id)" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/group/@count" value="count-selected(/data/group/@ids)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/group/item/@index" value="int(/data/group/@current_index)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/group/item/@id" value="selected-at(/data/group/@ids, ../@index)" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<group>\n\t\t\t<repeat jr:count="/data/group/@count" jr:noAddRemove="true()" vellum:nodeset="#form/group/item" nodeset="/data/group/item">\n\t\t\t\t<input vellum:ref="#form/group/item/phone" ref="/data/group/item/phone" appearance="numeric"/>\n\t\t\t</repeat>\n\t\t</group>\n\t</h:body>\n</h:html>\n',p='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/28B1D8B9-1144-4600-968A-349FD99FFCA5" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<product ids="" count="" current_index="" vellum:role="Repeat">\n\t\t\t\t\t\t<item id="" index="" jr:template=""/>\n\t\t\t\t\t</product>\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<instance id="products" src="jr://fixture/commtrack:products" />\n\t\t\t<bind nodeset="/data/product/@current_index" vellum:calculate="count(#form/product/item)" calculate="count(/data/product/item)" />\n\t\t\t<bind vellum:nodeset="#form/product/item" nodeset="/data/product/item" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/product/@ids" value="join(\' \', instance(\'products\')/products/product/@id)" />\n\t\t\t<setvalue event="xforms-ready" ref="/data/product/@count" value="count-selected(/data/product/@ids)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/product/item/@index" value="int(/data/product/@current_index)" />\n\t\t\t<setvalue event="jr-insert" ref="/data/product/item/@id" value="selected-at(/data/product/@ids, ../@index)" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<group>\n\t\t\t<repeat vellum:nodeset="#form/product/item" nodeset="/data/product/item" jr:count="/data/product/@count" jr:noAddRemove="true()" />\n\t\t</group>\n\t</h:body>\n</h:html>\n',m='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/28B1D8B9-1144-4600-968A-349FD99FFCA5" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<product jr:template="" />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<bind vellum:nodeset="#form/product" nodeset="/data/product" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default=""/>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<group>\n\t\t\t<repeat vellum:nodeset="#form/product" nodeset="/data/product" />\n\t\t</group>\n\t</h:body>\n</h:html>\n';var h=r().assert,f=s.A.call,g=s.A.options.options.plugins||[],v=i.Ay.union(g,["modeliteration"]);describe("The model iteration plugin",(function(){before((function(t){s.A.init({plugins:v,javaRosa:{langs:["en"]},core:{onReady:function(){h(this.isPluginEnabled("modeliteration"),"modeliteration plugin should be enabled"),t()}}})})),it("should load a case list repeat",(function(){s.A.loadXML(u);var t=s.A.getMug("child/item");h.deepEqual(t.p.dataSource,{instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"}),s.A.assertXmlEqual(f("createXML"),u)})),it("should load a case list repeat with questions",(function(){s.A.loadXML(l),s.A.assertJSTreeState("group","  phone","  hidden");var t=s.A.getMug("group/item"),e=s.A.getMug("group/item/phone"),n=s.A.getMug("group/item/hidden");h.deepEqual(t.p.dataSource,{instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"}),h.equal(e.__className,"PhoneNumber"),h.equal(n.p.calculateAttr,"#form/group/item/phone = '12345'"),s.A.assertXmlEqual(f("createXML"),l)})),it("should write setvalues in order of question tree",(function(){s.A.loadXML(c),s.A.assertJSTreeState("hidden","group","  phone","  hidden"),s.A.assertXmlEqual(f("createXML"),c)})),it("should create a case list repeat",(function(){s.A.loadXML(""),s.A.addQuestion("Repeat","child").p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"},s.A.assertXmlEqual(f("createXML"),u,{normalize_xmlns:!0})})),it("should create a case list repeat with questions",(function(){s.A.loadXML(""),s.A.addQuestion("Repeat","group").p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"},s.A.addQuestion("PhoneNumber","phone"),s.A.addQuestion("DataBindOnly","hidden").p.calculateAttr="/data/group/item/phone = '12345'",s.A.assertXmlEqual(f("createXML"),l,{normalize_xmlns:!0})})),it("should load a fixture repeat",(function(){s.A.loadXML(p);var t=s.A.getMug("product/item");h.deepEqual(t.p.dataSource,{instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"}),s.A.assertXmlEqual(f("createXML"),p)})),it("should create a fixture repeat",(function(){s.A.loadXML(""),s.A.addQuestion("Repeat","product").p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"},s.A.assertXmlEqual(f("createXML"),p,{normalize_xmlns:!0})})),it("should convert fixture repeat to regular repeat when data source is removed",(function(){s.A.loadXML(p);var t=s.A.getMug("product/item");t.p.dataSource={},t.p.repeat_count="",s.A.assertXmlEqual(f("createXML"),m)})),it("should create a fixture repeat containing a text input",(function(){s.A.loadXML(""),s.A.addQuestion("Repeat","product").p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"},s.A.addQuestion("Text","text"),s.A.assertJSTreeState("product","  text")})),it("should change a fixture repeat to a case list repeat",(function(){s.A.loadXML(p),s.A.getMug("product/item").p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"},s.A.assertXmlEqual(f("createXML").replace(/product/g,"child"),u)})),it("should not remove instance when ignore/retain is active",(function(){var t='<bind vellum:nodeset="#form/product/item" nodeset="/data/product/item" />',e='<bind vellum:nodeset="#form/product/item" nodeset="/data/product/item" wierd="true()" vellum:ignore="retain" />',n=p.replace(t,t+e);h(n.indexOf(e)>0,e+" not found in XML:\n\n"+n),s.A.loadXML(n);var a=s.A.getMug("product/item");a.p.dataSource={},a.p.repeat_count="",n=f("createXML"),h(1===s.A.parseXML(n).find("instance[id=products]").length,"products instance not found in XML\n\n"+n)})),it("should not write duplicate <setvalue> nodes after rename",(function(){s.A.loadXML("");var t=s.A.addQuestion("Repeat","product");t.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var e=f("createXML"),n=s.A.parseXML(e).find("setvalue").length;t.p.nodeID="group",e=f("createXML"),h.equal(s.A.parseXML(e).find("setvalue").length,n,"wrong number of <setvalue> nodes\n\n"+e)})),it("should drop setvalue nodes on delete model repeat",(function(){s.A.loadXML(p),s.A.deleteQuestion("product/item");var t=f("createXML");h.equal(s.A.parseXML(t).find("setvalue").length,0,"wrong number of <setvalue> nodes\n\n"+t)})),it("should update expressions on set data source",(function(){s.A.loadXML("");var t=s.A.addQuestion("Repeat","product"),e=s.A.addQuestion("Text","blue"),n=s.A.addQuestion("Text","text"),a=e.form.getAbsolutePath.bind(e.form);h.equal(e.hashtagPath,"#form/product/blue"),h.equal(n.hashtagPath,"#form/product/text"),n.p.calculateAttr=e.hashtagPath,e.p.labelItext.set('<output value="'+n.hashtagPath+'"/>'),e.validate("labelItext"),t.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var r=s.A.parseXML(f("createXML"));h.equal(e.hashtagPath,"#form/product/item/blue"),h.equal(n.hashtagPath,"#form/product/item/text");var o=r.find("bind[nodeset='"+a(n)+"']");h.equal(o.attr("calculate"),"/data/product/item/blue",o.attr("nodeset")+" calculate expression mismatch"),h.equal(r.find("output:first").attr("value"),"/data/product/item/text","output value mismatch");var d=i.Ay.flatten(i.Ay.map([e,n],(function(t){return t.getErrors()})));h(!d.length,d.join("\n"))})),it("should update expressions on clear data source",(function(){s.A.loadXML("");var t=s.A.addQuestion("Repeat","product");t.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var e=s.A.addQuestion("Text","blue"),n=s.A.addQuestion("Text","text");n.p.calculateAttr=e.hashtagPath,e.p.labelItext.set('<output value="'+n.hashtagPath+'"/>'),e.validate("labelItext"),h.equal(e.hashtagPath,"#form/product/item/blue"),h.equal(n.hashtagPath,"#form/product/item/text"),t.p.dataSource={},h.equal(e.hashtagPath,"#form/product/blue"),h.equal(n.hashtagPath,"#form/product/text");var a=s.A.parseXML(f("createXML")),r=a.find("bind[nodeset='"+n.absolutePath+"']");h.equal(r.attr("calculate"),"/data/product/blue",r.attr("nodeset")+" calculate expression mismatch"),h.equal(a.find("output:first").attr("value"),"/data/product/text","output value mismatch");var o=i.Ay.flatten(i.Ay.map([e,n],(function(t){return t.getErrors()})));h(!o.length,o.join("\n"))})),it("should show repeat count for regular repeat",(function(){s.A.loadXML(m),s.A.clickQuestion("product"),h.equal(d()("[name=property-repeat_count]").length,1,"repeat count should be visible for regular repeat")})),it("should hide repeat count for model repeat",(function(){s.A.loadXML(p),s.A.clickQuestion("product/item"),h.equal(d()("[name=property-repeat_count]").length,0,"repeat count should not be visible for model repeat")})),it("should change instance name when editing its sole reference",(function(){s.A.loadXML(p);var t=s.A.getMug("product/item");h.equal(t.p.dataSource.instance.id,"products"),t.p.dataSource={instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"},h.deepEqual(t.p.dataSource,{instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"})})),it("should change instance when idsQuery changes",(function(){var t=s.A.loadXML(p),e=s.A.getMug("product/item");t.updateKnownInstances({foo:"jr://foo"}),e.p.dataSource={idsQuery:"instance('foo')/products/product/@id"};var n=f("createXML"),a=s.A.parseXML(n);h(a.find("instance[id=foo]").length,"foo instance not found:\n"+n),h.equal(a.find("instance[id=products]").length,0,"somefixture instance not found:\n"+n)})),it("should sync instance name with existing instance",(function(){s.A.loadXML(p);var t=s.A.getMug("product/item"),e=s.A.addQuestion("Repeat","product2");e.p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"},h.equal(t.p.dataSource.instance.id,"products"),h.equal(e.p.dataSource.instance.id,"products"),t.p.dataSource={instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"},h.deepEqual(t.p.dataSource,{instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"})})),it("should use jr-insert event for nested model iteration setvalues",(function(){s.A.loadXML(p),s.A.addQuestion.bind({prevId:"product/item"})("Repeat","nested").p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"};var t=f("createXML"),e=s.A.parseXML(t),n="setvalue[ref='/data/product/";h.equal(e.find(n+"@ids']").attr("event"),"xforms-ready","wrong setvalue event for outer repeat: "+t),h.equal(e.find(n+"item/nested/@ids']").attr("event"),"jr-insert","wrong setvalue event for nested repeat: "+t)}))}))},1134:(t,e,n)=>{n.d(e,{A:()=>Q});var a=n(8449),r=n(8324),o=n.n(r),d=n(6848),i=n.n(d),s=n(3794),u=n(4523),l=n(561),c=n.n(l),p=n(1437),m=n.n(p),h=n(3809),f=n.n(h),g=n(705),v=n.n(g),x=n(7229),A=n.n(x),b=(n(1460),n(8803),o().assert),w=["Form Builder clip","version 1"];function j(t,e,n){if((n=u.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=A().parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var r,o,d,s,l=(r=t,o=e,d=i().xml(r),s=i().xml(o),i().isEquivalent(d,s,{element_order:!0}));n.not&&(l=!l),l||y(t=M(t),e=M(e),"XML "+(n.not?"should not be equivalent":"mismatch"))}function y(t,e,n){if(t!==e){var a=(0,s.createPatch)("",t,e,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),b(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(a))}}function M(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function X(t){return L("getCurrentMugInput",t)}function q(t){var e=c()("#vellum").vellum("get"),n=u.Ay.isString(t)?c()("[name="+t+"]"):t;return v().util.getWidget(n,e)}function L(){var t=Array.prototype.slice.call(arguments),e=c()("#vellum");return e.vellum.apply(e,t)}function S(){var t=[],e=u.Ay.map(arguments,(function(e){var n=u.Ay.isString(e)?_(e):e;if(!n||!n.ufid)throw new Error("mug not found: "+e);return t.push(n),n.ufid}));return L("jstree","deselect_all",!0),L("jstree","select_node",e),c()(".collapse-toggle.collapsed").click(),t}function _(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=L("getMugByPath",t);if(!e){var n=t.split("/"),a=L("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var r=L("getData").core.form.getChildren(a),o=n[n.length-1];if(1===r.length&&"itemset"===o&&"itemset"===r[0].options.tagName)return r[0];for(var d=0;d<r.length;d++)if(r[d].p.nodeID===o)return r[d]}}return e}b.equal=b.strictEqual,b.notEqual=b.notStrictEqual;const Q={options:a.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=c().extend(!0,{},a.A.options,t),n=c().fn.animate;c().fn.animate=function(t,e,a,r){n.apply(this,[t,0,a,r])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=u.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&u.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var r=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,r(t)};var o=c()("#vellum"),d=o.vellum("get");d&&(d.destroy(),c()("body > div.modal, body > div.modal-backdrop").remove()),o.empty().vellum(e)},call:L,loadXML:function(t,e,n,a,r=!0){var o=[],d=L("getData");return a||window.history.replaceState(null,null," "),d.core.parseWarnings=[],L("loadXML",t,e||{},{reset:r}),n?u.Ay.isRegExp(n)&&(o=u.Ay.filter(d.core.parseWarnings,(function(t){return!n.test(t)}))):o=d.core.parseWarnings,b(!o.length,"unexpected parse warnings:\n- "+o.join("\n- ")),delete d.core.parseWarnings,d.core.form},saveAndReload:function(t){L("loadXFormOrError",L("createXML"),t)},getMug:_,getInput:X,getWidget:q,getMediaUploader:function(t){var e,n={},a=q(t);if(!a)throw new Error("media uploader widget not found");if(u.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(e=t.closest(n)).length})),!e)throw new Error("media uploader element not found");return n.upload=function(t){var n={ref:{path:a.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",n)},n},assertEqual:y,assertInputCount:function(t,e,n){u.Ay.isString(t)?(n=" for "+(n?n+" ":"")+t,t=X(t)):n=n?" for "+n:"",b.equal(t.length,e,"wrong number of inputs"+n)},assertXmlEqual:j,assertXmlNotEqual:function(t,e,n){(n=n||{}).not=!0,j(t,e,n)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";y(function t(e,n){var a,r,o,d=[];for("#"===e.id?n=-1:d.push(Array(2*n+1).join(" ")+e.text),a=0,r=e.children.length;a<r;a++)o=L("jstree","get_node",e.children[a]),d.push(t(o,n+1));return d.join("\n")}(L("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";y(function t(e,n){var a,r,o,d=[];for(e.isRootNode?n=-1:d.push(Array(2*n+1).join(" ")+e.value.p.nodeID),a=0,r=e.children.length;a<r;a++)o=e.children[a],d.push(t(o,n+1));return d.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,n){n=u.Ay.extend({},n),this.prevId&&S(this.prevId);var a=L("addQuestion",t);return e||a.p.nodeID||(e=L("nodeIDFromLabel",a)),e&&(b(u.Ay.isUndefined(n.nodeID),"unexpected attribute for "+t+"["+e+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=e,"Choice"!==t||n.hasOwnProperty("labelItext")||(n.labelItext=e)),u.Ay.each(n,(function(t,e){u.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?a.p[e].set(t):a.p[e]=t})),u.Ay.each(L("getSections",a),(function(t){L("collapseSection",t.slug,!1)})),a},paste:function(t,e,n){u.Ay.isString(t)||(t=f().tabDelimit([w].concat(t))),n&&window.console.log(t),b.deepEqual(m().paste(t),e||[])},clickQuestion:S,selectAll:function(){L("jstree","select_all")},deleteQuestion:function(){var t=u.Ay.map(arguments,(function(t){var e=_(t);return b(e,"mug not found: "+t),e}));L("getData").core.form.removeMugsFromForm(t),u.Ay.each(arguments,(function(t){b(!_(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=L("getData").core.saveButton;if(!u.Ay.isUndefined(t)){var n=t?"save":"saved";e.setStateWhenReady(n),b.equal(e.state,n,"sanity check failed")}return"save"===e.state},expandGroup:function(t){L("jstree","open_node",t.ufid),L("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){L("jstree","close_node",t.ufid),L("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],n=null;if(u.Ay.isString(t)){var a=t;t=_(a),b(t,"mug not found: "+a)}return t.messages.each((function(t,a){a!==n&&(e.push(a+":"),n=a),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,n){if(u.Ay.isString(e)){var a=e;e=function(t){return t.text===a}}return function n(a){var r,o,d;if(e(a))return a;for(r=0,o=a.children.length;r<o;r++)if(d=n(t.get_node(a.children[r])))return d;return null}(n||t.get_node("#"))},isTreeNodeValid:function(t){if(u.Ay.isString(t)){var e=t;t=_(e),b(t,"mug not found: "+e)}return 0===c()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return c()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:A().parseXML}}}]);