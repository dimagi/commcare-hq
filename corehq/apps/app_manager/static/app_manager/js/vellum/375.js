"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[375],{2756:(t,e,n)=>{var a=n(8324),o=n.n(a),r=n(561),i=n.n(r),s=n(4523),u=n(1134),l=n(4459),d=n.n(l),c=n(3876),p=n.n(c);const f='<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n\t<h:head>\n\t\t<h:title>Untitled Form</h:title>\n\t\t<model>\n\t\t\t<instance>\n\t\t\t\t<data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/9CC6B54C-CFF6-429C-83FB-9D56B2B330D9" uiVersion="1" version="1" name="Untitled Form">\n\t\t\t\t\t<verify_current_num_burpees />\n\t\t\t\t\t<new_burpee_data>\n\t\t\t\t\t\t<burpee_date />\n\t\t\t\t\t\t<num_burpees />\n\t\t\t\t\t</new_burpee_data>\n\t\t\t\t\t<prev_num_burpees />\n\t\t\t\t\t<total_num_burpees />\n\t\t\t\t</data>\n\t\t\t</instance>\n\t\t\t<bind vellum:nodeset="#form/verify_current_num_burpees" nodeset="/data/verify_current_num_burpees" />\n\t\t\t<bind vellum:nodeset="#form/new_burpee_data" nodeset="/data/new_burpee_data" />\n\t\t\t<bind vellum:nodeset="#form/new_burpee_data/burpee_date" nodeset="/data/new_burpee_data/burpee_date" type="xsd:date" constraint=". &lt;= today()" jr:constraintMsg="jr:itext(\'burpee_date-constraintMsg\')" />\n\t\t\t<bind vellum:nodeset="#form/new_burpee_data/num_burpees" nodeset="/data/new_burpee_data/num_burpees" type="xsd:int" constraint=". &lt;= 1000" jr:constraintMsg="jr:itext(\'num_burpees-constraintMsg\')" />\n\t\t\t<bind vellum:nodeset="#form/prev_num_burpees" nodeset="/data/prev_num_burpees" />\n\t\t\t<bind vellum:nodeset="#form/total_num_burpees" nodeset="/data/total_num_burpees" vellum:calculate="#form/new_burpee_data/num_burpees + #form/prev_num_burpees" calculate="/data/new_burpee_data/num_burpees + /data/prev_num_burpees" />\n\t\t\t<itext>\n\t\t\t\t<translation lang="en" default="">\n\t\t\t\t\t<text id="verify_current_num_burpees-label">\n\t\t\t\t\t\t<value>Nice work!\nOur records show you have done <output vellum:value="#form/prev_num_burpees" value="/data/prev_num_burpees" /> burpees so far. If this does not sound right, you may need to go back to the home screen and sync your phone to get the latest data before proceeding.</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="new_burpee_data/burpee_date-label">\n\t\t\t\t\t\t<value>What day did you burp?</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="burpee_date-constraintMsg">\n\t\t\t\t\t\t<value>That\'s in the future! Liars will be disqualified from the competition.</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="new_burpee_data/num_burpees-label">\n\t\t\t\t\t\t<value>How many burpees did you do on <output value="format-date(date(/data/new_burpee_data/burpee_date), \'%a, %b %e, %Y\')" vellum:value="format-date(date(#form/new_burpee_data/burpee_date), \'%a, %b %e, %Y\')" /> ?</value>\n\t\t\t\t\t</text>\n\t\t\t\t\t<text id="num_burpees-constraintMsg">\n\t\t\t\t\t\t<value>That\'s too many burpees. Liars will be disqualified from the competition</value>\n\t\t\t\t\t</text>\n\t\t\t\t</translation>\n\t\t\t</itext>\n\t\t</model>\n\t</h:head>\n\t<h:body>\n\t\t<trigger vellum:ref="#form/verify_current_num_burpees" ref="/data/verify_current_num_burpees" appearance="minimal">\n\t\t\t<label ref="jr:itext(\'verify_current_num_burpees-label\')" />\n\t\t</trigger>\n\t\t<group vellum:ref="#form/new_burpee_data" ref="/data/new_burpee_data" appearance="field-list">\n\t\t\t<input vellum:ref="#form/new_burpee_data/burpee_date" ref="/data/new_burpee_data/burpee_date">\n\t\t\t\t<label ref="jr:itext(\'new_burpee_data/burpee_date-label\')" />\n\t\t\t\t<alert ref="jr:itext(\'burpee_date-constraintMsg\')" />\n\t\t\t</input>\n\t\t\t<input vellum:ref="#form/new_burpee_data/num_burpees" ref="/data/new_burpee_data/num_burpees">\n\t\t\t\t<label ref="jr:itext(\'new_burpee_data/num_burpees-label\')" />\n\t\t\t\t<alert ref="jr:itext(\'num_burpees-constraintMsg\')" />\n\t\t\t</input>\n\t\t</group>\n\t</h:body>\n\t<case_mappings />\n</h:html>\n';var m,h=o().assert,v=u.A.call,b=[{id:"commcaresession",uri:"jr://instance/session",path:"/session/data",name:"Session",structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/cases/case",name:"Cases",structure:{name:{}},subsets:[{id:"parent",name:"parent",key:"@case_type",structure:{edd:{}}},{id:"case",name:"child",key:"@case_type",structure:{case:{},dob:{},f_1065:{}},related:{parent:{hashtag:"#case/parent",subset:"parent",subset_key:"@case_type",key:"@case_id"}}}]}];function g(t){return t.startsWith("fa-")?i()("<i>").addClass(t).html("&nbsp;"):i()("<i>").addClass("fcc "+t).html("&nbsp;")}function x(){return g("fcc-fd-case-property")}function y(t,e,n,a,o){var r=i()("<span>").addClass("label label-datanode").attr({"data-value":t,contenteditable:!1,"data-toggle":"popover",id:o});return a&&!s.Ay.isString(a)?r.addClass("label-datanode-internal"):"case"===a||m.isValidHashtag(t)?r.addClass("label-datanode-external"):m.hasValidHashtagPrefix(t)?r.addClass("label-datanode-external-unknown"):r.addClass("label-datanode-unknown"),r.append(n).append(e)}function _(t){return'<output value="'+t+'"></output>'}function w(t){return i()("<div>").append(t)}function A(t){return w(i()("<p>").text("â€‹").append(t).append("â€‹"))}function q(t){return w(t).html()}function T(t){u.A.init({javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(t){t(b)},onReady:function(){u.A.addQuestion("Text","text"),u.A.addQuestion("Text","othertext"),u.A.addQuestion("Date","date"),u.A.addQuestion("Group","group"),m=this.data.core.form,t()}}})}function E(t){const e=document.createElement("div");e.innerHTML=t;const n=e.querySelector("span[id]");return n?n.id:null}function j(t){return t.replace(/<span([^>]*)\s+id="[^"]*"([^>]*)>/g,"<span$1$2>")}describe("Rich text utilities",(function(){before(T),describe("simple conversions",(function(){var t=[["#form/text","text",g("fcc-fd-text"),!0],["#case/case","case",x(),!1],["#case/parent/edd","edd",x(),!1],["#case/parent/unknown","unknown",g("fa-solid fa-triangle-exclamation"),!1]],e={isExpression:!0};s.Ay.each(t,(function(t){it("from text to html: "+t[0],(function(){const n=d().toRichText(t[0],m,e),a=(o=y(t[0],t[1],t[2],t[3],E(n)),w(i()("<p>").append(o))).html();var o;h.strictEqual(n,a)})),it("from text to html with output value: "+t[0],(function(){const e=d().toRichText(_(t[0]),m),n=A(y(t[0],t[1],t[2],t[3],E(e))).html();h.strictEqual(e,n)}))}))})),describe("date conversions",(function(){var t=[{xmlValue:"format-date(date(#form/date), '%d/%n/%y')",valueInBubble:"#form/date",bubbleDispValue:"date",icon:g("fa-solid fa-calendar-days"),internalRef:!0,extraAttrs:{"data-date-format":"%d/%n/%y"}}];s.Ay.each(t,(function(t){it("from text to html with output value: "+t.xmlValue,(function(){const e=d().toRichText(_(t.xmlValue),m);h.equal(e,A(y(t.valueInBubble,t.bubbleDispValue,t.icon,t.internalRef,E(e)).attr(t.extraAttrs)).html())}))})),it("bubble a drag+drop reference",(function(){var t="%d/%n/%y",e=p().getOutputRef("#form/text",t),n=d().toRichText(e,m);h.strictEqual(i()(n).find("span").data("date-format"),t)}))})),describe("equation conversions",(function(){var t="#case/f_1065",e=g("fcc-fd-text"),n={isExpression:!0},a=[["#form/text = #form/othertext",q(y("#form/text","text",e,!0))+" = "+q(y("#form/othertext","othertext",e,!0))],["#form/text <= #form/othertext",q(y("#form/text","text",e,!0))+" <= "+q(y("#form/othertext","othertext",e,!0))],[t+" = "+t,q(y(t,"f_1065",g("fcc-fd-case-property"),"case"))+" = "+q(y(t,"f_1065",g("fcc-fd-case-property"),"case"))]];s.Ay.each(a,(function(t){it("from text to html: "+t[0],(function(){h.strictEqual(j(d().toRichText(t[0],m,n)),"<p>"+t[1]+"</p>")}))}))})),describe("text conversions",(function(){var t='<div contenteditable="true" name="property-dataParent" class="form-control jstree-drop fd-input" spellcheck="true" placeholder="Drag question here"><span class="label label-datanode label-datanode-external popover-initialized" data-value="#case/dob" contenteditable="false" data-toggle="popover" id="bubble-yalqu945d" data-original-title="" title="" ><i class="fcc fcc-fd-case-property">&nbsp;</i></span></div>',e=[["blah\nblah","<p>blah</p><p>blah</p>"],["blah\nblah\n","<p>blah</p><p>blah</p><p>&nbsp;</p>"],["blah\n\nblah\n\n","<p>blah</p><p>&nbsp;</p><p>blah</p><p>&nbsp;</p><p>&nbsp;</p>"],["list\n* item\n* item","<p>list</p><p>* item</p><p>* item</p>"],["list\n\n* item\n* item","<p>list</p><p></p><p>* item</p><p>* item</p>"],["list\n\n\n* item\n* item","<p>list</p><p></p><p></p><p>* item</p><p>* item</p>"],[" "," "],["   "," Â  "],["   "," &nbsp; "],['This dob: <output value="#case/dob" /> is of child',"This dob:&nbsp;"+t+"â€…is of child"],['This dob: <output value="#case/dob" />',"This dob:&nbsp;"+t],['<output value="#case/dob" /> is of child',t+"â€…is of child"],['<output value="#case/dob" />',t],['This dob: <output value="#case/dob" /> is of child','This dob: &lt;output value="#case/dob" /&gt; is of child']];s.Ay.each(e,(function(t){it("from html to text: "+JSON.stringify(t[1]),(function(){h.strictEqual(j(d().fromRichText(t[1])),t[0])}))})),s.Ay.each(e,(function(t){it("(text -> html -> text): "+JSON.stringify(t[0]),(function(){h.strictEqual(j(d().fromRichText(d().toRichText(t[0],m))),t[0])}))}))})),describe("doesn't convert",(function(){var t={isExpression:!0};s.Ay.each(["instance('casedb')/cases/case[@case_id = instance('casedb')/cases/case[@case_id = instance('commcaresession')/session/data/case_id]/index/parent]/edd[@other = 'blah']","/data/group[@prop = 'something']","instance('casedb')/cases/case[@case_id = /data/blah]"],(function(e){it("from text to html: "+e,(function(){h.strictEqual(d().toRichText(e,m,t),"<p>"+e+"</p>")}))}))})),describe("convert value with output and escaped HTML",(function(){var t=g("fcc-fd-text");s.Ay.each([['<h1><output value="#form/text" /></h1>',"&lt;h1&gt;â€‹{text}â€‹&lt;/h1&gt;"],['<output value="#form/text" /> <tag /> <output value="#form/othertext" />',"â€‹{text}â€‹ &lt;tag /&gt; â€‹{othertext}â€‹"],["{blah}","{blah}"],['<output value="unknown(#form/text)" />','&lt;output value="unknown(#form/text)" /&gt;'],['<output value="#form/text + now()" />','&lt;output value="#form/text + now()" /&gt;'],['<output value="concat(1, 2" />','&lt;output value="concat(1, 2" /&gt;'],["<output value=\"#form/question,'-label')\" />","&lt;output value=\"#form/question,'-label')\" /&gt;"],["<output />","&lt;output /&gt;"]],(function(e){it("to text: "+e[0],(function(){var n=j(d().bubbleOutputs(e[0],m,!0)),a=e[1].replace(/{(.*?)}/g,(function(e,n){return m.getIconByPath("#form/"+n)?y("#form/"+n,n,t,!0)[0].outerHTML:e}));h.equal(n,a)}))}))})),describe("serialize formats correctly",(function(){it("should handle output refs",(function(){h.equal(d().applyFormats({value:"#case/f_2685"}),'&lt;output value="#case/f_2685" /&gt;')})),it("should handle dates",(function(){h.equal(d().applyFormats({dateFormat:"%d/%n/%y",value:"#form/question1"}),"&lt;output value=\"format-date(date(#form/question1), '%d/%n/%y')\" /&gt;")}))})),describe("invalid xpath unescaper",(function(){it("should pass through xpath not marked as invalid",(function(){h.equal(d().unescapeXPath("/data/valid",m),"/data/valid")})),s.Ay.each({"#invalid/xpath `#form/text` xpath":"/data/text xpath","#invalid/xpath `#form/text`xpath":"/data/text xpath"},(function(t,e){it("should unescape invalid xpath: "+e+" -> "+t,(function(){h.equal(d().unescapeXPath(e,m),t)}))}))}))})),describe("The rich text editor",(function(){before(T),describe("",(function(){var t,e,n,a,o=i()("<div id='cktestparent'><div contenteditable></div><div contenteditable></div></div>"),r={isExpression:!1};function u(t,e,n){const a=new DataTransfer,o=new ClipboardEvent("copy",{clipboardData:a,bubbles:!0,cancelable:!0});t[0].dispatchEvent(o),h.equal(a.getData("text/plain"),e),h.strictEqual(a.getData("text/html"),""),n()}before((function(s){i()("body").append(o),t=o.children().first(),e=d().editor(t,m,r),n=i()(o.children()[1]),a=d().editor(n,m,{isExpression:!0}),t.promise.then((function(){n.promise.then((function(){s()}))}))})),beforeEach((function(t){e.setValue("",(function(){a.setValue("",(function(){t()}))}))})),after((function(){e.destroy(),a.destroy(),h.equal(i()("#cktestparent").length,1),o.remove(),h.equal(i()("#cktestparent").length,0)})),it("should be accessible via various jquery paths",(function(n){var a=e,o=d().editor(t);h.equal(a,o),a.setValue("test",(function(){h.equal(o.getValue(),"test");var t=i()("#cktestparent").children().first();h.equal(d().editor(t),a),n()}))})),it("should return just-set value on get value",(function(){var t='<output value="#form/text" />';h.notEqual(e.getValue(),t),e.setValue(t),h.equal(e.getValue(),t)})),it("should create output on insert expression into label editor",(function(t){e.setValue("one two",(function(){h.equal(e.getValue(),"one two"),e.select(3),e.insertExpression("#form/text"),h.equal(e.getValue(),'one<output value="#form/text" />  two'),t()}))})),it("should insert output into label editor",(function(t){var n='<output value="#form/text" />';e.setValue("one two",(function(){h.equal(e.getValue(),"one two"),e.select(3),e.insertOutput(n),h.equal(e.getValue(),"one"+n+" two"),t()}))})),it("should not copy output value from label to expression editor",(function(o){var r='<output value="#form/text" />';e.setValue(r,(function(){h.equal(e.getValue(),r);var i=t[0].innerHTML;h(/^<p>â€‹<span .*<.span>â€‹<.p>â€‹$/.test(i),i),n[0].innerHTML=i,h.equal(a.getValue(),"#form/text"),o()}))})),it("should copy output value from expression editor to label",(function(o){a.setValue("#form/text",(function(){h.equal(a.getValue(),"#form/text");var r=n[0].innerHTML;h(/^<p>â€‹<span .*<.span>â€‹<.p>â€‹$/.test(r),r),t[0].innerHTML=r,h.equal(e.getValue(),'<output value="#form/text" />'),o()}))})),it("should not paste style content into editor",(function(){t[0].focus(),document.execCommand("insertHTML",!1,'<style type="text/css">\x3c!--td--\x3e</style><span>A</span>'),h.equal(e.getValue(),"A")}));var l="if(today() + (#case/dob - 3), #form/text, 0)";it("should copy output tag from rich text editor",(function(n){e.setValue('Weight: <output value="#form/text" /> grams',(function(){e.select(6,4),u(t,': <output value="#form/text" />',(function(){n()}))}))})),it("should copy expression with hashtags from expression editor",(function(t){a.setValue(l,(function(){a.select(11,5),u(n,"+ (#case/dob",(function(){t()}))}))}));const c=l.replace("#case/dob","XXXX");function p(t){return function(e){return t.apply(this,e)}}s.Ay.each([[1,c,14,4,{text:"#case/dob"}],[1,c,11,7,{text:"+ (#case/dob"}],[1,c,11,7,{text:"< (#case/dob"}],[1,c,11,7,{html:"<span>+ (#case/dob</span>"}],[1,c,11,7,{html:"<meta charset='utf-8'>+ (#case/dob"}]],(function(e){const a=e[0],o=e[1],r=e[2],i=e[3],s=e[4],u=s.text||s.html.replace(/<.*?>/g,""),l=JSON.stringify(s),c={isExpression:!0};it("should paste "+(a?"expression":"text")+": "+l,(function(e){const l=a?n:t,p=d().editor(l),f=o.substring(r,r+i);p.setValue(o,(function(){p.select(r,i);const t=new DataTransfer;s.text?t.setData("text/plain",u):t.setData("text/html",u);const n=new ClipboardEvent("paste",{clipboardData:t,bubbles:!0,cancelable:!0});l[0].dispatchEvent(n);const a=j(l[0].innerHTML).replace(/\u200B/g,""),v=j(d().toRichText(o,m,c).replace(f,function(t){var e={"<":"&lt;",">":"&gt;",'"':"&quot;","\n":"<br />"};return t.replace(/[<>"&\n]/g,(function(t){return e[t]}))}(u)));h.equal(a,v),h.equal(p.getValue(),o.substring(0,r)+u+o.substring(r+i)),e()}))}))}));var f=[["= two",0,"#form/text = two"],["one two",3,"#invalid/xpath one`#form/text`  two"],["one two",4,"#invalid/xpath one `#form/text` two"],["one\n\ntwo",3,"#invalid/xpath one`#form/text` \n\ntwo"],["one\n\ntwo",4,"#invalid/xpath one\n`#form/text` \ntwo"],["one``two",4,"#invalid/xpath one```#form/text` ``two"],["`one  two",5,"#invalid/xpath ``one `#form/text`  two"],["one =  ",6,"one = #form/text  "]];s.Ay.each(f,p((function(t,e,n){var o=JSON.stringify(n);it("should insert expression into expression at "+e+": "+o,(function(o){a.setValue(t,(function(){h.equal(a.getValue(),t),a.select(e),a.insertExpression("#form/text"),h.equal(a.getValue(),n),o()}))}))}))),s.Ay.each(f,p((function(t,e,n){var a=JSON.stringify(n);it("should make bubbles on converting to rich text: "+a,(function(){var a=d().toRichText(n,m,{isExpression:!0}),o=y("#form/text","text",g("fcc-fd-text"),!0),r=(t.slice(0,e)+q(o)+" "+t.slice(e)).replace(/  $/,"").replace(/  /g," &nbsp;").replace(/\n/g,"</p><p>");h.equal(j(a),"<p>"+r+"</p>")}))})))})),describe("in vellum",(function(){var t;describe("",(function(){beforeEach((function(e){u.A.init({javaRosa:{langs:["en"]},form:"",core:{onReady:function(){u.A.addQuestion("Text","text"),(t=u.A.getWidget("itext-en-label")).input.promise.then((function(){e()}))}},features:{rich_text:!0}})})),it("should show the markdown preview",(function(e){var n=t.handleChange;t.setValue("# blah",(function(){n(),h(i()(".has-markdown").length),e()}))})),it("should allow editing of validation message",(function(){var t=u.A.getMug("text"),e=i()("[name=itext-en-constraintMsg]");t.p.constraintAttr=".",e.focus(),h(e[0].isContentEditable)})),it("should not write empty attributes",(function(){u.A.loadXML(f),u.A.getMug("total_num_burpees").p.relevantAttr="",u.A.assertXmlEqual(v("createXML"),f)})),it("cursor should be at end of input on focus",(function(){var e=d().editor(t.input);t.setValue("testing cursor"),i()("[name=property-nodeID]").focus(),e.focus();var n=window.getSelection();h.exists(n);var a=n.getRangeAt(0);h.exists(a),h.isTrue(a.collapsed),h.strictEqual(a.startContainer,a.startContainer.parentNode.lastChild),h.strictEqual(a.startContainer.textContent,"â€‹")})),it("should change output ref to output value",(function(){u.A.loadXML('<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n  <h:head>\n    <h:title>Untitled Form</h:title>\n    <model>\n      <instance>\n        <data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/5BB149AC-6665-4C04-8B27-E23A0B267C24" uiVersion="1" version="1" name="Untitled Form">\n          <name />\n        </data>\n      </instance>\n      <instance src="jr://instance/casedb" id="casedb" />\n      <bind nodeset="/data/name" type="xsd:string" required="true()" />\n      <itext>\n        <translation lang="en" default="">\n          <text id="name-label">\n            <value><output ref="instance(\'casedb\')/casedb/case[@case_id = current()/../../@id]/case_name" /></value>\n          </text>\n        </translation>\n      </itext>\n    </model>\n  </h:head>\n  <h:body>\n    <input ref="/data/name">\n      <label ref="jr:itext(\'name-label\')" />\n    </input>\n  </h:body>\n</h:html>\n'),u.A.assertXmlEqual(v("createXML"),'<?xml version="1.0" encoding="UTF-8" ?>\n<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa" xmlns:vellum="http://commcarehq.org/xforms/vellum">\n  <h:head>\n    <h:title>Untitled Form</h:title>\n    <model>\n      <instance>\n        <data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/5BB149AC-6665-4C04-8B27-E23A0B267C24" uiVersion="1" version="1" name="Untitled Form">\n          <name />\n        </data>\n      </instance>\n      <instance src="jr://instance/casedb" id="casedb" />\n      <bind vellum:nodeset="#form/name" nodeset="/data/name" type="xsd:string" required="true()" />\n      <itext>\n        <translation lang="en" default="">\n          <text id="name-label">\n            <value><output value="instance(\'casedb\')/casedb/case[@case_id = current()/../../@id]/case_name" /></value>\n          </text>\n        </translation>\n      </itext>\n    </model>\n  </h:head>\n  <h:body>\n    <input vellum:ref="#form/name" ref="/data/name">\n      <label ref="jr:itext(\'name-label\')" />\n    </input>\n  </h:body>\n  <case_mappings />\n</h:html>\n')})),it("should bubble various case properties",(function(){u.A.loadXML("");var t=u.A.getWidget("itext-en-label"),e=i()(".fd-textarea[name='itext-en-label']");t.input.promise.then((function(){t.setValue('<output value="#case/not_a_child" /><output value="#case/not_a_thing" /><output value="#case/dob" />'),h.strictEqual(e.find(".label-datanode-external-unknown").length,1),h.strictEqual(e.find(".label-datanode-external").length,1),h.strictEqual(e.find(".label-datanode-unknown").length,1)}))})),it("should have native spellchecking on labels",(function(){h.strictEqual(i()("[name=itext-en-label]").attr("spellcheck"),"true")})),it("should not have native spellchecking on xpaths",(function(){h.strictEqual(i()("[name=property-relevantAttr]").attr("spellcheck"),"false")}))})),describe("popovers",(function(){before((function(t){u.A.init({javaRosa:{langs:["en"]},form:"",core:{onReady:function(){t()}},features:{rich_text:!0,disable_popovers:!1}})}));const t=500;it("should not change saved state",(function(t){u.A.loadXML(f),h(!u.A.saveButtonEnabled(),"Save button should not be enabled"),u.A.clickQuestion("total_num_burpees"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){h(!u.A.saveButtonEnabled(),"Save button should not be enabled"),t()}))})),it("should show xpath and tree reference link on popover",(function(e){u.A.loadXML(f),u.A.clickQuestion("total_num_burpees"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content").last();h.strictEqual(t.find("p").first().text(),"How many burpees did you do on #form/new_burpee_data/burpee_date ?");var n=t.find("a");h(n.length),n.click(),h.strictEqual(i()(".jstree-hovered").length,1),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should expand tree on click show in question list",(function(e){u.A.paste([["id","type","relevantAttr"],["/group","Group","null"],["/group/text","Text","null"],["/text","Text","#form/group/text"]]);var n=u.A.getMug("group");u.A.collapseGroup(n),u.A.clickQuestion("text"),u.A.getWidget("property-relevantAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last").find("a");h.strictEqual(i()(".jstree-hovered").length,0),h(t.length),t.click(),h.strictEqual(i()(".jstree-hovered").length,1),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should show case property description on popover",(function(e){u.A.loadXML(),u.A.addQuestion("Text","text").p.calculateAttr="#case/dob",u.A.clickQuestion("text"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last");h.equal(t.find("p:first").text(),"Date of Birth"),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should split long text in case property descriptions",(function(e){u.A.loadXML(),u.A.addQuestion("Text","text").p.calculateAttr="#case/long",u.A.clickQuestion("text"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last");h.equal(t.find("p:first").text(),"Property with a_very_long_word_in_the_description_that_ex\n\nceeds_43_chars"),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should destroy popover when moving mouse away",(function(e){u.A.loadXML(f),u.A.clickQuestion("total_num_burpees"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last p:first");h.strictEqual(t.text(),"How many burpees did you do on #form/new_burpee_data/burpee_date ?"),n.mouseleave(),h.strictEqual(i()(".popover:not(.fade)").length,0),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should expand tree on click show in question list",(function(e){u.A.paste([["id","type","relevantAttr"],["/group","Group","null"],["/group/text","Text","null"],["/text","Text","#form/group/text"]]);var n=u.A.getMug("group");u.A.collapseGroup(n),u.A.clickQuestion("text"),u.A.getWidget("property-relevantAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last").find("a");h.strictEqual(i()(".jstree-hovered").length,0),h(t.length),t.click(),h.strictEqual(i()(".jstree-hovered").length,1),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should show case property description on popover",(function(e){u.A.loadXML(),u.A.addQuestion("Text","text").p.calculateAttr="#case/dob",u.A.clickQuestion("text"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last");h.equal(t.find("p:first").text(),"Date of Birth"),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should split long text in case property descriptions",(function(e){u.A.loadXML(),u.A.addQuestion("Text","text").p.calculateAttr="#case/long",u.A.clickQuestion("text"),u.A.getWidget("property-calculateAttr").input.promise.then((function(){var n=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(n.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last");h.equal(t.find("p:first").text(),"Property with a_very_long_word_in_the_description_that_ex\n\nceeds_43_chars"),e()}finally{i()(".popover").remove()}})),setTimeout((function(){n.mouseenter()}),t)}))})),it("should destroy popover on destroy widget",(function(e){u.A.loadXML(f),u.A.clickQuestion("total_num_burpees");var n=u.A.getWidget("property-calculateAttr");n.input.promise.then((function(){var a=i()('div[contenteditable="true"] [data-toggle="popover"]').first();h(a.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){try{var t=i()(".popover-content:last p:first");h.strictEqual(t.text(),"How many burpees did you do on #form/new_burpee_data/burpee_date ?"),n.input.data("editorWrapper").destroy(),h.strictEqual(i()(".popover:not(.fade)").length,0),e()}finally{i()(".popover").remove()}})),setTimeout((function(){a.mouseenter()}),t)}))})),it("should not error on unknown question ref",(function(e){u.A.loadXML(""),u.A.addQuestion("Text","text");var n=u.A.getWidget("property-relevantAttr"),a=d().editor(n.input);setTimeout((function(){a.setValue("#form/unknown"),e()}),t)})),describe("for date references",(function(){var t;before((function(e){u.A.loadXML(""),u.A.paste([["id","type","labelItext:en-default"],["/date","Date","dob"],["/text","Text",""]]),u.A.clickQuestion("text"),(t=u.A.getWidget("itext-en-label")).input.promise.then(e)})),s.Ay.each({"#form/date":"#form/date (no formatting)","format-date(date(#form/date), '%e/%n/%y')":"#form/date (d/m/yy)","format-date(date(#form/date), '%a, %b %e, %Y')":"#form/date (ddd, mmm d, yyyy)"},(function(e,n){it("should show "+e+" on popover",(function(a){var o=d().editor(t.input),r='<output value="'+n+'" />';o.setValue(r,(function(){var n,o=t.input.find('[data-toggle="popover"]').first();h(o.length,"No bubbles detected"),i()(document).one("shown.bs.popover",(function(){n=i()(".popover-title .text-muted");try{h.equal(n.text(),e),h.equal(n.find("a").text(),/\((.*)\)/.exec(e)[1]),a()}finally{i()(".popover").remove()}})),o.mouseenter()}))}))}))}))}))}))})),describe("htmlToFragment",(function(){it("should convert a single tag",(function(){var t="<p>one</p>",e=d().htmlToFragment(t);const n=document.createElement("div");n.appendChild(e),h.equal(n.innerHTML,t)})),it("should mark spans as contenteditable=false",(function(){var t=d().htmlToFragment("<span>one</span>");const e=document.createElement("div");e.appendChild(t),h.equal(e.innerHTML,'<span contenteditable="false">one</span>')})),it("should convert mulitple tags",(function(){var t=d().htmlToFragment("<p>one</p><span>one</span>");const e=document.createElement("div");e.appendChild(t),h.equal(e.innerHTML,'<p>one</p><span contenteditable="false">one</span>')})),it("should work with zwsp",(function(){var t=d().htmlToFragment('â€‹<span class="label label-datanode label-datanode-internal" data-value="#form/text" contenteditable="false" data-toggle="popover" id="bubble-ga3iiwmw"><i class="fcc fcc-fd-text">&nbsp;</i>text</span>â€‹');const e=document.createElement("div");e.append(t),h.equal(e.childNodes.length,3),h.equal(e.innerHTML,'â€‹<span class="label label-datanode label-datanode-internal" data-value="#form/text" contenteditable="false" data-toggle="popover" id="bubble-ga3iiwmw"><i class="fcc fcc-fd-text">&nbsp;</i>text</span>â€‹')}))}))},1134:(t,e,n)=>{n.d(e,{A:()=>L});var a=n(8449),o=n(8324),r=n.n(o),i=n(6848),s=n.n(i),u=n(3794),l=n.n(u),d=n(4523),c=n(561),p=n.n(c),f=n(1437),m=n.n(f),h=n(3809),v=n.n(h),b=n(705),g=n.n(b),x=n(7229),y=n.n(x),_=(n(1460),n(8803),r().assert),w=["Form Builder clip","version 1"];function A(t,e,n){if((n=d.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=y().parseXML(e).find("data").attr("xmlns");t=t.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var o,r,i,u,l=(o=t,r=e,i=s().xml(o),u=s().xml(r),s().isEquivalent(i,u,{element_order:!0}));n.not&&(l=!l),l||q(t=T(t),e=T(e),"XML "+(n.not?"should not be equivalent":"mismatch"))}function q(t,e,n){if(t!==e){var a=l().createPatch("",t,e,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),_(!1,function(t){var e={"-":31,"+":32};return t.replace(/^.+?$/gm,(function(t){return"["+(e[t[0]]||0)+"m"+t+"[0m"}))}(a))}}function T(t){return(t=t.replace(/^\t+/gm,(function(t){return t.replace(/\t/g,"  ")}))).match(/\n$/)||(t+="\n"),t}function E(t){return k("getCurrentMugInput",t)}function j(t){var e=p()("#vellum").vellum("get"),n=d.Ay.isString(t)?p()("[name="+t+"]"):t;return g().util.getWidget(n,e)}function k(){var t=Array.prototype.slice.call(arguments),e=p()("#vellum");return e.vellum.apply(e,t)}function M(){var t=[],e=d.Ay.map(arguments,(function(e){var n=d.Ay.isString(e)?V(e):e;if(!n||!n.ufid)throw new Error("mug not found: "+e);return t.push(n),n.ufid}));return k("jstree","deselect_all",!0),k("jstree","select_node",e),p()(".collapse-toggle.collapsed").click(),t}function V(t){0!==t.indexOf("/")&&(t="/data/"+t);var e=k("getMugByPath",t);if(!e){var n=t.split("/"),a=k("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var o=k("getData").core.form.getChildren(a),r=n[n.length-1];if(1===o.length&&"itemset"===r&&"itemset"===o[0].options.tagName)return o[0];for(var i=0;i<o.length;i++)if(o[i].p.nodeID===r)return o[i]}}return e}_.equal=_.strictEqual,_.notEqual=_.notStrictEqual;const L={options:a.A,asyncatch:function(t){return function(){try{var e=Array.prototype.slice.call(arguments);return t.apply(this,e)}catch(t){throw t&&t.stack?new Error(t.stack):t}}},init:function(t){t=t||{};var e=p().extend(!0,{},a.A.options,t),n=p().fn.animate;p().fn.animate=function(t,e,a,o){n.apply(this,[t,0,a,o])},t.javaRosa&&t.javaRosa.langs&&(e.javaRosa.langs=t.javaRosa.langs),e.plugins=d.Ay.without(e.plugins,"atwho"),t.plugins&&(e.plugins=t.plugins),e&&e.features&&d.Ay.isUndefined(e.features.disable_popovers)&&(e.features.disable_popovers=!0),e.core=e.core||{};var o=e.core.saveUrl||function(){};e.core.saveUrl=function(t){return t.xform,o(t)};var r=p()("#vellum"),i=r.vellum("get");i&&(i.destroy(),p()("body > div.modal, body > div.modal-backdrop").remove()),r.empty().vellum(e)},call:k,loadXML:function(t,e,n,a,o=!0){var r=[],i=k("getData");return a||window.history.replaceState(null,null," "),i.core.parseWarnings=[],k("loadXML",t,e||{},{reset:o}),n?d.Ay.isRegExp(n)&&(r=d.Ay.filter(i.core.parseWarnings,(function(t){return!n.test(t)}))):r=i.core.parseWarnings,_(!r.length,"unexpected parse warnings:\n- "+r.join("\n- ")),delete i.core.parseWarnings,i.core.form},saveAndReload:function(t){k("loadXFormOrError",k("createXML"),t)},getMug:V,getInput:E,getWidget:j,getMediaUploader:function(t){var e,n={},a=j(t);if(!a)throw new Error("media uploader widget not found");if(d.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(e=t.closest(n)).length})),!e)throw new Error("media uploader element not found");return n.upload=function(t){var n={ref:{path:a.getRandomizedMediaPath(t)},errors:[]};e.trigger("mediaUploadComplete",n)},n},assertEqual:q,assertInputCount:function(t,e,n){d.Ay.isString(t)?(n=" for "+(n?n+" ":"")+t,t=E(t)):n=n?" for "+n:"",_.equal(t.length,e,"wrong number of inputs"+n)},assertXmlEqual:A,assertXmlNotEqual:function(t,e,n){(n=n||{}).not=!0,A(t,e,n)},assertJSTreeState:function(){var t=Array.prototype.slice.call(arguments).join("\n")+"\n";q(function t(e,n){var a,o,r,i=[];for("#"===e.id?n=-1:i.push(Array(2*n+1).join(" ")+e.text),a=0,o=e.children.length;a<o;a++)r=k("jstree","get_node",e.children[a]),i.push(t(r,n+1));return i.join("\n")}(k("jstree","get_node","#"))+"\n",t,"Unexpected jstree state")},assertTreeState:function(t){var e=Array.prototype.slice.call(arguments,1).join("\n")+"\n";q(function t(e,n){var a,o,r,i=[];for(e.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+e.value.p.nodeID),a=0,o=e.children.length;a<o;a++)r=e.children[a],i.push(t(r,n+1));return i.join("\n")}(t.rootNode,0)+"\n",e,"Unexpected tree state")},addQuestion:function(t,e,n){n=d.Ay.extend({},n),this.prevId&&M(this.prevId);var a=k("addQuestion",t);return e||a.p.nodeID||(e=k("nodeIDFromLabel",a)),e&&(_(d.Ay.isUndefined(n.nodeID),"unexpected attribute for "+t+"["+e+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=e,"Choice"!==t||n.hasOwnProperty("labelItext")||(n.labelItext=e)),d.Ay.each(n,(function(t,e){d.Ay.isBoolean(t)||(t=String(t)),/.+Itext/.test(e)?a.p[e].set(t):a.p[e]=t})),d.Ay.each(k("getSections",a),(function(t){k("collapseSection",t.slug,!1)})),a},paste:function(t,e,n){d.Ay.isString(t)||(t=v().tabDelimit([w].concat(t))),n&&window.console.log(t),_.deepEqual(m().paste(t),e||[])},clickQuestion:M,selectAll:function(){k("jstree","select_all")},deleteQuestion:function(){var t=d.Ay.map(arguments,(function(t){var e=V(t);return _(e,"mug not found: "+t),e}));k("getData").core.form.removeMugsFromForm(t),d.Ay.each(arguments,(function(t){_(!V(t),"mug not removed: "+t)}))},saveButtonEnabled:function(t){var e=k("getData").core.saveButton;if(!d.Ay.isUndefined(t)){var n=t?"save":"saved";e.setStateWhenReady(n),_.equal(e.state,n,"sanity check failed")}return"save"===e.state},expandGroup:function(t){k("jstree","open_node",t.ufid),k("jstree","redraw_node",t.ufid,!0,!1,!1)},collapseGroup:function(t){k("jstree","close_node",t.ufid),k("jstree","redraw_node",t.ufid,!0,!1,!1)},getMessages:function(t){var e=[],n=null;if(d.Ay.isString(t)){var a=t;t=V(a),_(t,"mug not found: "+a)}return t.messages.each((function(t,a){a!==n&&(e.push(a+":"),n=a),e.push("  - "+t.message)})),e.join("\n")},findNode:function(t,e,n){if(d.Ay.isString(e)){var a=e;e=function(t){return t.text===a}}return function n(a){var o,r,i;if(e(a))return a;for(o=0,r=a.children.length;o<r;o++)if(i=n(t.get_node(a.children[o])))return i;return null}(n||t.get_node("#"))},isTreeNodeValid:function(t){if(d.Ay.isString(t)){var e=t;t=V(e),_(t,"mug not found: "+e)}return 0===p()("#vellum").find("#"+t.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return p()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:y().parseXML}}}]);