"use strict";(self.webpackChunkvellum=self.webpackChunkvellum||[]).push([[588],{3588:(e,t,n)=>{n.r(t);var a=n(8324),r=n.n(a),o=n(1134),i=(n(4459),n(3876),r().assert),u=[{id:"commcaresession",uri:"jr://instance/session",path:"/session",name:"Session",structure:{data:{merge:!0,structure:{case_id:{reference:{hashtag:"#case",source:"casedb",subset:"case",subset_key:"@case_type",key:"@case_id"}}}},context:{merge:!0,structure:{userid:{reference:{hashtag:"#user",source:"casedb",subset:"commcare-user",subset_key:"@case_type",subset_filter:!0,key:"hq_user_id"}}}}}},{id:"casedb",uri:"jr://instance/casedb",path:"/casedb/case",name:"Cases",structure:{name:{}},subsets:[{id:"case",name:"release",key:"@case_type",structure:{release_date:{},release_length:{},contact_number:{},format:{},genres:{},case_name:{},quantity:{},footnote:{}}},{id:"commcare-user",name:"user",key:"@case_type",structure:{role:{},footnote:{}}}]}];describe("Bulk form actions",(function(){describe("should make all applicable questions required",(function(){function e(e,t){it("question "+e+(t?" is marked as required":" is ignored"),(function(){var a=n[e];t?i(a.p.requiredAttr,"required is false"):i(!a.p.requiredAttr,"required is true")}))}var t,n={};before((function(){t=o.A.loadXML(""),n.Text=o.A.addQuestion("Text"),n.PhoneNumber=o.A.addQuestion("PhoneNumber"),n.HiddenValue=o.A.addQuestion("DataBindOnly"),n.Select=o.A.addQuestion("Select"),n.Choice=o.A.addQuestion("Choice"),n.Label=o.A.addQuestion("Trigger"),n.Group=o.A.addQuestion("Group","groupA"),n.TextInGroup=o.A.addQuestion.bind({prevId:"groupA"})("Text","text2"),n.DataBindOnlyInGroup=o.A.addQuestion.bind({prevId:"groupA"})("DataBindOnly","hidden2"),t.vellum.makeAllQuestionsRequired()})),e("Text",!0),e("PhoneNumber",!0),e("HiddenValue",!1),e("Select",!0),e("Choice",!1),e("Label",!1),e("Group",!1),e("TextInGroup",!0),e("DataBindOnlyInGroup",!1)})),describe("should set matching case properties as default values on applicable question types",(function(){var e={};function t(t,n,a){it("the default value for "+t+(n?" matches the expected case property":a?" matched the existing default value":" was not applicable"),(function(){var r=e[t];n?i(r.p.defaultValue==="#case/"+r.p.nodeID,"default value didn't match the case property"):a?i(r.p.defaultValue===a,"the default value changed"):i(!r.p.defaultValue,"the default value was set")}))}before((function(t){o.A.init({javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(e){e(u)},onReady:function(){e.MatchingText=o.A.addQuestion("Text","release_date",{defaultValue:"existing default"}),e.MatchingHiddenValue=o.A.addQuestion("DataBindOnly","release_length"),e.MatchingPhoneNumber=o.A.addQuestion("PhoneNumber","contact_number"),e.MatchingSelect=o.A.addQuestion("Select","format"),e.ChoiceOfMatchingSelect=o.A.addQuestion("Choice","vinyl"),e.Text=o.A.addQuestion("Text","no_match_01",{defaultValue:"already set"}),e.HiddenValue=o.A.addQuestion("DataBindOnly","no_match_02",{defaultValue:"already set"}),e.Label=o.A.addQuestion("Trigger","no_match_03"),e.Group=o.A.addQuestion("Group","groupA"),e.MatchingTextInGroup=o.A.addQuestion.bind({prevId:"groupA"})("Text","quantity",{defaultValue:"existing default"}),e.MatchingHiddenValueInGroup=o.A.addQuestion.bind({prevId:"groupA"})("DataBindOnly","genres"),e.TextInGroup=o.A.addQuestion.bind({prevId:"groupA"})("Text","no_match_04",{defaultValue:"already set"}),e.HiddenValueInGroup=o.A.addQuestion.bind({prevId:"groupA"})("DataBindOnly","no_match_05",{defaultValue:"already set"}),e.userCaseProp=o.A.addQuestion("DataBindOnly","role"),e.similarCaseProp=o.A.addQuestion("DataBindOnly","footnote"),this.data.core.form.vellum.defaultMatchingQuestionsToCaseProperties(),t()}}})})),t("MatchingText",!0),t("MatchingHiddenValue",!0),t("MatchingPhoneNumber",!0),t("MatchingSelect",!0),t("ChoiceOfMatchingSelect",!1),t("Text",!1,"already set"),t("HiddenValue",!1,"already set"),t("Label",!1),t("Group",!1),t("MatchingTextInGroup",!0),t("MatchingHiddenValueInGroup",!0),t("TextInGroup",!1,"already set"),t("HiddenValueInGroup",!1,"already set"),it("user case properties are also matched with priority given to case properties",(function(){i(e.userCaseProp.p.defaultValue==="#user/"+e.userCaseProp.p.nodeID,"user case property was not set as default"),i(e.similarCaseProp.p.defaultValue==="#case/"+e.similarCaseProp.p.nodeID,"case property was not given priority over user case property")}))}))}))},1134:(e,t,n)=>{n.d(t,{A:()=>D});var a=n(8449),r=n(8324),o=n.n(r),i=n(6848),u=n.n(i),s=n(3794),l=n.n(s),d=n(4523),c=n(561),p=n.n(c),f=n(1437),g=n.n(f),h=n(3809),m=n.n(h),v=n(705),y=n.n(v),A=n(7229),b=n.n(A),x=(n(1460),n(8803),o().assert),_=["Form Builder clip","version 1"];function I(e,t,n){if((n=d.Ay.defaults(n||{},{normalize_xmlns:!1,not:!1})).normalize_xmlns){var a=b().parseXML(t).find("data").attr("xmlns");e=e.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+a+'"')}var r,o,i,s,l=(r=e,o=t,i=u().xml(r),s=u().xml(o),u().isEquivalent(i,s,{element_order:!0}));n.not&&(l=!l),l||M(e=w(e),t=w(t),"XML "+(n.not?"should not be equivalent":"mismatch"))}function M(e,t,n){if(e!==t){var a=l().createPatch("",e,t,"actual","expected");a=a.replace(/^Index:/,n||"Not equal:"),x(!1,function(e){var t={"-":31,"+":32};return e.replace(/^.+?$/gm,(function(e){return"["+(t[e[0]]||0)+"m"+e+"[0m"}))}(a))}}function w(e){return(e=e.replace(/^\t+/gm,(function(e){return e.replace(/\t/g,"  ")}))).match(/\n$/)||(e+="\n"),e}function Q(e){return S("getCurrentMugInput",e)}function q(e){var t=p()("#vellum").vellum("get"),n=d.Ay.isString(e)?p()("[name="+e+"]"):e;return y().util.getWidget(n,t)}function S(){var e=Array.prototype.slice.call(arguments),t=p()("#vellum");return t.vellum.apply(t,e)}function j(){var e=[],t=d.Ay.map(arguments,(function(t){var n=d.Ay.isString(t)?k(t):t;if(!n||!n.ufid)throw new Error("mug not found: "+t);return e.push(n),n.ufid}));return S("jstree","deselect_all",!0),S("jstree","select_node",t),p()(".collapse-toggle.collapsed").click(),e}function k(e){0!==e.indexOf("/")&&(e="/data/"+e);var t=S("getMugByPath",e);if(!t){var n=e.split("/"),a=S("getMugByPath",n.slice(0,-1).join("/"));if(a&&a.__className.indexOf("Select")>-1){var r=S("getData").core.form.getChildren(a),o=n[n.length-1];if(1===r.length&&"itemset"===o&&"itemset"===r[0].options.tagName)return r[0];for(var i=0;i<r.length;i++)if(r[i].p.nodeID===o)return r[i]}}return t}x.equal=x.strictEqual,x.notEqual=x.notStrictEqual;const D={options:a.A,asyncatch:function(e){return function(){try{var t=Array.prototype.slice.call(arguments);return e.apply(this,t)}catch(e){throw e&&e.stack?new Error(e.stack):e}}},init:function(e){e=e||{};var t=p().extend(!0,{},a.A.options,e),n=p().fn.animate;p().fn.animate=function(e,t,a,r){n.apply(this,[e,0,a,r])},e.javaRosa&&e.javaRosa.langs&&(t.javaRosa.langs=e.javaRosa.langs),t.plugins=d.Ay.without(t.plugins,"atwho"),e.plugins&&(t.plugins=e.plugins),t&&t.features&&d.Ay.isUndefined(t.features.disable_popovers)&&(t.features.disable_popovers=!0),t.core=t.core||{};var r=t.core.saveUrl||function(){};t.core.saveUrl=function(e){return e.xform,r(e)};var o=p()("#vellum"),i=o.vellum("get");i&&(i.destroy(),p()("body > div.modal, body > div.modal-backdrop").remove()),o.empty().vellum(t)},call:S,loadXML:function(e,t,n,a){var r=[],o=S("getData");return a||window.history.replaceState(null,null," "),o.core.parseWarnings=[],S("loadXML",e,t||{}),n?d.Ay.isRegExp(n)&&(r=d.Ay.filter(o.core.parseWarnings,(function(e){return!n.test(e)}))):r=o.core.parseWarnings,x(!r.length,"unexpected parse warnings:\n- "+r.join("\n- ")),delete o.core.parseWarnings,o.core.form},saveAndReload:function(e){S("loadXFormOrError",S("createXML"),e)},getMug:k,getInput:Q,getWidget:q,getMediaUploader:function(e){var t,n={},a=q(e);if(!a)throw new Error("media uploader widget not found");if(d.Ay.find([".widget[data-hqmediapath]",".itext-block-container"],(function(n){return(t=e.closest(n)).length})),!t)throw new Error("media uploader element not found");return n.upload=function(e){var n={ref:{path:a.getRandomizedMediaPath(e)},errors:[]};t.trigger("mediaUploadComplete",n)},n},assertEqual:M,assertInputCount:function(e,t,n){d.Ay.isString(e)?(n=" for "+(n?n+" ":"")+e,e=Q(e)):n=n?" for "+n:"",x.equal(e.length,t,"wrong number of inputs"+n)},assertXmlEqual:I,assertXmlNotEqual:function(e,t,n){(n=n||{}).not=!0,I(e,t,n)},assertJSTreeState:function(){var e=Array.prototype.slice.call(arguments).join("\n")+"\n";M(function e(t,n){var a,r,o,i=[];for("#"===t.id?n=-1:i.push(Array(2*n+1).join(" ")+t.text),a=0,r=t.children.length;a<r;a++)o=S("jstree","get_node",t.children[a]),i.push(e(o,n+1));return i.join("\n")}(S("jstree","get_node","#"))+"\n",e,"Unexpected jstree state")},assertTreeState:function(e){var t=Array.prototype.slice.call(arguments,1).join("\n")+"\n";M(function e(t,n){var a,r,o,i=[];for(t.isRootNode?n=-1:i.push(Array(2*n+1).join(" ")+t.value.p.nodeID),a=0,r=t.children.length;a<r;a++)o=t.children[a],i.push(e(o,n+1));return i.join("\n")}(e.rootNode,0)+"\n",t,"Unexpected tree state")},addQuestion:function(e,t,n){n=d.Ay.extend({},n),this.prevId&&j(this.prevId);var a=S("addQuestion",e);return t||a.p.nodeID||(t=S("nodeIDFromLabel",a)),t&&(x(d.Ay.isUndefined(n.nodeID),"unexpected attribute for "+e+"["+t+"]"),a.p.labelItext&&a.p.labelItext.set(a.getLabelValue()),a.p.nodeID=t,"Choice"!==e||n.hasOwnProperty("labelItext")||(n.labelItext=t)),d.Ay.each(n,(function(e,t){d.Ay.isBoolean(e)||(e=String(e)),/.+Itext/.test(t)?a.p[t].set(e):a.p[t]=e})),d.Ay.each(S("getSections",a),(function(e){S("collapseSection",e.slug,!1)})),a},paste:function(e,t,n){d.Ay.isString(e)||(e=m().tabDelimit([_].concat(e))),n&&window.console.log(e),x.deepEqual(g().paste(e),t||[])},clickQuestion:j,selectAll:function(){S("jstree","select_all")},deleteQuestion:function(){var e=d.Ay.map(arguments,(function(e){var t=k(e);return x(t,"mug not found: "+e),t}));S("getData").core.form.removeMugsFromForm(e),d.Ay.each(arguments,(function(e){x(!k(e),"mug not removed: "+e)}))},saveButtonEnabled:function(e){var t=S("getData").core.saveButton;if(!d.Ay.isUndefined(e)){var n=e?"save":"saved";t.setStateWhenReady(n),x.equal(t.state,n,"sanity check failed")}return"save"===t.state},expandGroup:function(e){S("jstree","open_node",e.ufid),S("jstree","redraw_node",e.ufid,!0,!1,!1)},collapseGroup:function(e){S("jstree","close_node",e.ufid),S("jstree","redraw_node",e.ufid,!0,!1,!1)},getMessages:function(e){var t=[],n=null;if(d.Ay.isString(e)){var a=e;e=k(a),x(e,"mug not found: "+a)}return e.messages.each((function(e,a){a!==n&&(t.push(a+":"),n=a),t.push("  - "+e.message)})),t.join("\n")},findNode:function(e,t,n){if(d.Ay.isString(t)){var a=t;t=function(e){return e.text===a}}return function n(a){var r,o,i;if(t(a))return a;for(r=0,o=a.children.length;r<o;r++)if(i=n(e.get_node(a.children[r])))return i;return null}(n||e.get_node("#"))},isTreeNodeValid:function(e){if(d.Ay.isString(e)){var t=e;e=k(t),x(e,"mug not found: "+t)}return 0===p()("#vellum").find("#"+e.ufid+" > a").children(".fd-valid-alert-icon").length},markdownVisible:function(){return p()(".itext-block-label-group-default").find(".markdown-output").is(":visible")},parseXML:b().parseXML}}}]);