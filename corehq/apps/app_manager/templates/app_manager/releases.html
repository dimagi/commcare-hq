{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load url_extras %}
{% load timezone_tags %}
{% load hq_shared_tags %}
{% load timezone_tags %}
{% load i18n %}
{% block js-inline %}{{ block.super }}
<script>
    $(function () {
        $('.release-build-link').popover({
            placement: 'left',
            title: 'Release Build',
            content: (
                "Once you've fully tested an application, you can star it to mark it as released. " +
                "When a CommCare application searches for updates, only starred builds will be considered."
            )
        });
        $('.unrelease-build-link').popover({
            placement: 'left',
            title: 'Retract Build',
            content: (
                "We recommend caution when retracting a build. Although " +
                "this build will no longer be considered when a CommCare application searches for updates, " +
                "it will not be purged from phones onto which it has already been downloaded."
            )
        });
        $('#build-errors').each(function () {
            var specialMessage = $('span', this)[0];
            var defaultMessage = $('span', this)[1];
            if ($.trim($(specialMessage).text())) {
                $(defaultMessage).hide();
            }
        });
    });
</script>
{% endblock %}
{% block head %}{{ block.super }}
<style>
    .build:hover {
        color: black !important;
    }
    .build.build-unreleased {
        color: #888;
    }
    .build.build-released {
    }
    .build.build-latest-release {
        background-color: #EFEFFF;
    }
    .nowrap {
        white-space: nowrap;
    }
</style>
{% endblock %}
{% block form-view %}
    <form id="make-new-build" action="{% url corehq.apps.app_manager.views.save_copy domain app.id %}" method="post">
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <input type="hidden" name="comment" value="" />
        <input type="submit" value="Make New Build" />
    </form>
    {% if build_errors %}
    <div class="message">
        Build Failed!
        <ul id="build-errors">
            {% for error in build_errors %}
            <li>
                <span>
            {% if error.type == "invalid xml" %}
                {% if error.form.content %}
                    Invalid xml in form
                {% else %}
                    Blank form
                {% endif %}
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "no ref detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses referrals but doesn't have
                detail screens configured for referrals.
            {% endif %}
            {% if error.type == "no case detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have
                detail screens configured for cases.
            {% endif %}
            {% if error.type == "no modules" %}
                This application has no modules.
            {% endif %}
            {% if error.type == "no forms" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                has no forms.
            {% endif %}
            {% if error.type == "no case type" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have a
                case type defined.
            {% endif %}
            {% if error.type == "form error" %}
                One or more forms are invalid: check all your forms for error messages.
            {% endif %}
            {% if error.type == "missing languages" %}
                {% include "app_manager/partials/form_error_message.html" %} missing languages:
                {% for lang in error.missing_languages %}
                    {{ lang }}
                {% endfor %}
            {% endif %}
            {% if error.type == "duplicate xmlns" %}
                You have two forms with the xmlns "{{ error.xmlns }}"
            {% endif %}
            {% if error.type == "update_case uses reserved word" %}
                Case Update uses reserved word "{{ error.word }}"
                in form
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "update_case word illegal" %}
                Case Update "{{ error.word }}" should start with a letter and only contain letters, numbers, '-', and '_'
                in form {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "path error" %}
                The case configuration in form
                {% include "app_manager/partials/form_error_message.html" %}
                contains the invalid path "{{ error.path }}".
            {% endif %}
            {% if error.type == "remote error" %}
                Remote Error: {{ error.message }}
            {% endif %}
            {% if error.type == "empty lang" %}
                One of your languages is empty. Check your <a href="{% url view_app domain app.id %}">app settings</a>.
            {% endif %}
                </span>
                <span>{{ error.message }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <table class="table">
        <tr>
            <th colspan="2">Version</th>
            <th colspan="2">Build Date &amp; Time</th>
            <th>CommCare Binary</th>

            <th></th>
            {% if edit %}
            <th></th>
            {% endif %}
            <th>Comment</th>
            <th>Released</th>

        </tr>
        {% for saved_app in saved_apps %}
        <tr class="build build-{% if saved_app.is_released %}released{% else %}unreleased{% endif %} {% if saved_app.id == latest_release.id %}build-latest-release{% endif %}">
            <td>
                {% if edit %}
                <form action="{% url corehq.apps.app_manager.views.delete_copy domain app.id %}"
                      data-title="Delete Build"
                      data-message="Are you sure you want to delete this build (version {{ saved_app.version }})?"
                      method="post">
                    <input type="hidden" name="saved_app" value="{{ saved_app.id }}" />
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <a class="delete_link confirm-submit" href="#"></a>
                </form>
                {% endif %}
            </td>
            <td class="nowrap">{{ saved_app.version }}</td>
            <td class="nowrap">{% utc_to_timezone saved_app.built_on timezone "%b %d, %Y" %}</td>
            <td class="nowrap">{% utc_to_timezone saved_app.built_on timezone "%H:%M %Z" %}</td>
            <td class="nowrap">
                {% if saved_app.built_with.get_label %}{{ saved_app.built_with.get_label }}{% endif %}
                <p>{{ saved_app.get_jar_path }}</p>
                {% if not saved_app.built_with.signed %}<h6>Unsigned Jar</h6>{% endif %}
            </td>
            <td class="nowrap">
                <div class="btn-group">
                    <span class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                        Deploy
                        <span class="caret"></span>
                    </span>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="{% url emulator domain saved_app.id %}">Preview</a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="dialog_opener" href="">CommCare J2ME Files</a>
                            <div class="dialog jar_download_dialog" title="Install Build {{ saved_app.version }} for J2ME">
                                <ol>
                                    <li>
                                        Download <strong>both</strong> of the following files:
                                        <p><a href="{% url corehq.apps.app_manager.views.download_jad domain saved_app.id %}">Download CommCare.jad</a></p>
                                        <p><a href="{% url corehq.apps.app_manager.views.download_jar domain saved_app.id %}">Download CommCare.jar</a></p>
                                    </li>
                                    <li>
                                        For help on how to install, see our <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Set+Up+Mobile+Phone">Set Up Mobile Phone</a>.
                                    </li>
                                    <li>
                                        If you have any issues with the installation, please refer to
                                        <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Troubleshooting+Phone+Problems">Troubleshooting Phone Problems</a>.
                                    </li>
                                </ol>

                            </div>
                        </li>
                        <li>
                            <a class="dialog_opener" href="">Send to Phones by SMS</a>
                            <div class="dialog send_app_dialog" title="Send Out Version {{ saved_app.version }}">
                                <form method="post" action="{% url corehq.apps.sms.views.send_to_recipients domain %}">
                                    <label>Send to: </label>
                                    <input type="text" name="recipients" class="sms-autocomplete" value="{{ app.recipients }}"/>
                                    {% if app.name|length <= 12 %}
                                        <textarea name="message">Update to CommCare: {{ saved_app.short_url }} ("{{ app.name }}" v.{{ saved_app.version }})</textarea>
                                    {% else %}
                                        <textarea name="message">Update to CommCare: {{ saved_app.short_url }} ("{{ app.name|slice:":10" }}.." v.{{ saved_app.version }})</textarea>
                                    {% endif %}
                                    <input type="submit" value="Send"/>
                                </form>
                            </div>
                        </li>
                        <li>
                            <a href="{% url corehq.apps.app_manager.views.odk_install domain saved_app.id %}" class="odk_install">Download to CommCare ODK</a>
                        </li>
                        {% if request.user.is_superuser %}
                            <li class="divider"></li>
                            <li>
                                <a href="{% url download_index domain saved_app.id %}">View Source Files</a>
                            </li>
                        {% endif %}
                        {% ifchanged %}
                            <li class="divider"></li>
                            {% if multimedia %}
                                <li>
                                    <a href="{% if multimedia.notice %}#multimediaIssuesModal{% else %}{% url download_multimedia_zip domain app.id %}{% endif %}" {% if multimedia.notice %}data-toggle="modal" data-target="#multimediaIssuesModal"{% endif %}>Download Multimedia Zip</a>
                                </li>
                            {% else %}
                                <li class="nav-header">(Multimedia Not Available)</li>
                            {% endif %}
                        {% endifchanged %}
                    </ul>
                </div>
            </td>
            {% if edit %}
            <td>
                {% if saved_app.version != app.version %}
                <button class="btn dialog_opener">Revert</button>
                <form class="dialog" action="{% url corehq.apps.app_manager.views.revert_to_copy domain app.id %}" method="post"
                        title="Revert to Build">
                    <p>Are you sure you want to revert to build {{ saved_app.version }}?</p>
                    <input type="hidden" name="saved_app" value="{{ saved_app.id }}" />
                    <button class="btn btn-primary" data-dismiss="modal" type="submit">Revert</button>
                </form>
                {% endif %}
            </td>
            {% endif %}
            <td>{% if saved_app.build_comment %}{{ saved_app.build_comment }}{% else %}<h6>(No Comment)</h6>{% endif %}</td>
            <td>
                {% if saved_app.is_released %}
                    {% if edit %}
                    <a href="{% url unrelease_build domain app.id saved_app.id %}" class="unrelease-build-link">
                        <img src="{% static 'app_manager/img/star-filled.svg' %}"/><!--
                        no whitespace
                    --></a>
                    {% else %}
                        <img src="{% static 'app_manager/img/star-filled.svg' %}"/>
                    {% endif %}
                    {% if saved_app.id == latest_release.id %}Latest{% endif %}
                {% else %}
                    {% if edit %}
                    <a href="{% url release_build domain app.id saved_app.id %}" class="release-build-link">
                        <img src="{% static 'app_manager/img/star-empty.svg' %}"/>
                    </a>
                    {% else %}
                        <img src="{% static 'app_manager/img/star-empty.svg' %}"/>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
{% endblock %}

{% block modals %}
{{ block.super }}
    {% if multimedia and multimedia.notice %}
        <div class="modal hide fade" id="multimediaIssuesModal">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">&times;</a>
                <h3>Issues may exist with your multimedia</h3>
            </div>
            <div class="modal-body">
                {% if multimedia.missing_image_refs > 0 or multimedia.missing_audio_refs > 0 %}
                    <p>
                        Your multimedia zip is missing {{ multimedia.missing_image_refs }} image reference{{ multimedia.missing_image_refs|pluralize }} and
                        {{ multimedia.missing_audio_refs }} audio reference{{ multimedia.missing_audio_refs|pluralize }}. Your app will likely crash unless this
                        is resolved.
                    </p>
                {% endif %}
                {% if multimedia.errors %}
                    <p>
                        Your application contains errors, therefore, your multimedia could not properly be assembled. Please fix your errors and any missing
                        multimedia references that are found afterward before using this file.
                    </p>
                {% endif %}
                <a class="btn btn-warning" href="{% url download_multimedia_zip domain app.id %}">Download Anyway</a>
            </div>
            <div class="modal-footer">
                <a class="btn" href="#" data-dismiss="modal">Close</a>
            </div>
        </div>
    {% endif %}
{% endblock %}
