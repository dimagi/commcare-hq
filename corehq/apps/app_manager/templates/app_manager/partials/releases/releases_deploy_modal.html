{% load hq_shared_tags %}
{% load i18n %}

<div class="modal-dialog" data-bind="attr: { id: 'id()' }">
  <div class="modal-content">
    <div class="modal-header">
      <h4 class="modal-title">
        {% trans "Version" %} <span data-bind="text: version"></span>
      </h4>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="{% trans 'Close' %}"
      ></button>
    </div>
    <div class="modal-body p-0">
      {% if not has_mobile_workers %}
        <div class="alert alert-danger">
          {% blocktrans %}
            Your project does not have any mobile workers! Only mobile workers
            can log into a CommCare application. Before you can publish your
            application,
          {% endblocktrans %}
          <a href="{% url "mobile_workers" domain %}"
            >{% trans "create your first mobile worker" %}</a
          >.
        </div>
      {% else %}
        <div
          class="accordion accordion-flush list-group list-group-flush"
          data-bind="attr: { id: 'deploy-accordion_' + id() }"
        >
          <div class="accordion-item">
            <h4 class="accordion-header">
              <a
                class="accordion-button icon-link fs-5 px-3"
                data-bs-toggle="collapse"
                href="#panel-android"
                aria-expanded="true"
                aria-controls="panel-android"
                data-bind="click: get_short_odk_url"
              >
                <i class="fcc fcc-applications"></i>
                {% trans "Download to Android" %}
              </a>
            </h4>
            <div
              class="accordion-collapse collapse show"
              id="panel-android"
              data-bind="attr: { 'data-bs-parent': '#deploy-accordion_' + id() }"
            >
              <div class="accordion-body">
                <div data-bind="bootstrapTabs: true">
                  <div class="tabbable">
                    <ul class="nav nav-pills" role="tablist">
                      <li class="nav-item">
                        <a
                          class="nav-link active"
                          href="#online-install-tab"
                          data-bs-toggle="tab"
                        >
                          {% trans "Online Install" %}
                        </a>
                      </li>

                      <li class="nav-item">
                        <a
                          class="nav-link"
                          href="#offline-install-tab"
                          data-bs-toggle="tab"
                        >
                          {% trans "Offline Install" %}
                        </a>
                      </li>
                    </ul>
                    <div class="tab-content mt-3">
                      <div class="tab-pane active" id="online-install-tab">
                        <div class="mb-2">
                          {% blocktrans %}
                            Download
                            <a
                              href="https://play.google.com/store/apps/details?id=org.commcare.dalvik"
                              >CommCare from Google Play</a
                            >
                            to your Android device.
                          {% endblocktrans %}
                        </div>
                        {% if build_profile_access and not app.is_remote_app and app.build_profiles %}
                          <div class="row mb-3">
                            <div class="col-sm-4">
                              <label
                                for="online-build-profile-select"
                                class="form-label col-form-label"
                                >{% trans "Application Profile" %}:</label
                              >
                            </div>
                            <div class="col-sm-8">
                              <select
                                class="form-select"
                                id="online-build-profile-select"
                                data-bind="optstr: build_profiles(), value: build_profile"
                              ></select>
                            </div>
                          </div>
                        {% endif %}
                        {% if multimedia_state.has_media %}
                          <div class="form-check mb-2">
                            <input
                              type="checkbox"
                              class="form-check-input"
                              id="include-multimedia-checkbox"
                              data-bind="
                                checked: include_media,
                                enable: mm_supported()"
                            />
                            <label
                              for="include-multimedia-checkbox"
                              class="form-check-label"
                              data-bind="visible: allow_media_install"
                            >
                              {% trans "Include Multimedia" %}
                              <span
                                data-bind="visible: !mm_supported()"
                                class="badge text-bg-secondary"
                              >
                                {% trans "Only supported for versions made after 2013-10-15" %}
                              </span>
                            </label>
                          </div>
                        {% endif %}
                        <div
                          class="form-check mb-2"
                          data-bind="visible: has_commcare_flavor_target"
                        >
                          <input
                            type="checkbox"
                            class="form-check-input"
                            data-bind="checked: download_targeted_version"
                            id="target-version-checkbox"
                          />
                          <label
                            for="target-version-checkbox"
                            class="form-check-label"
                            >{% trans "Download Targeted Version" %}</label
                          >
                        </div>
                        <div class="mb-2">
                          {% blocktrans %}
                            Open the app on your Android and use one of the
                            following installation methods:
                          {% endblocktrans %}
                        </div>
                        <ul>
                          <li>
                            <a
                              href="#"
                              data-bind="
                                openRemoteModal: full_odk_install_url,
                                click: clickScan
                              "
                            >
                              {% trans "Scan Application Barcode" %}
                            </a>
                          </li>
                          <li>
                            <a
                              href="#"
                              data-bind="
                                click: click_app_code,
                                visible: !app_code() && !failed_url_generation() && !generating_url()
                              "
                            >
                              {% trans "Enter App Code" %}
                            </a>
                            <span data-bind="visible: app_code">
                              {% trans "Enter app code on installation screen: " %}
                              <code
                                class="bitly"
                                data-bind="text: app_code"
                              ></code>
                            </span>
                            <i
                              data-bind="visible: generating_url()"
                              class="fa fa-spin fa-spinner"
                            ></i>
                            <span
                              class="text-warning-emphasis"
                              data-bind="visible: failed_url_generation() && !generating_url()"
                            >
                              {% blocktrans %}
                                (No app code available. If you would like to use
                                an app code instead of scanning the application
                                barcode, try making another version.)
                              {% endblocktrans %}
                            </span>
                          </li>
                        </ul>
                      </div>
                      <div class="tab-pane" id="offline-install-tab">
                        <div data-bind="ifnot: allowOfflineInstall()">
                          Upgrade to CommCare 2.13 to use this feature
                        </div>
                        <div data-bind="ifnot: allow_media_install">
                          Offline install is unavailable for Remote Apps.
                        </div>
                        <div
                          data-bind="if: allowOfflineInstall() && allow_media_install()"
                        >
                          {% if build_profile_access and not app.is_remote_app and app.build_profiles %}
                            <div class="row mb-3">
                              <div class="col-sm-4">
                                <label
                                  for="offline-build-profile-select"
                                  class="form-label col-form-label"
                                  >{% trans "Application Profile" %}:</label
                                >
                              </div>
                              <div class="col-sm-8">
                                <select
                                  class="form-select"
                                  id="offline-build-profile-select"
                                  data-bind="optstr: build_profiles(), value: build_profile"
                                ></select>
                              </div>
                            </div>
                          {% endif %}
                          <ol>
                            <li>
                              {% trans "Download" %}
                              <a
                                href="#"
                                data-bind="
                                  click: function () {
                                    downloadApplicationZip(false, build_profile());
                                  }"
                                >CommCare_v<span
                                  data-bind="text: version"
                                ></span
                                >.ccz
                              </a>
                            </li>
                            <li>
                              {% trans "Transfer this file to your Android phone's file system" %}
                            </li>
                            <li>
                              {% blocktrans %}
                                Login to the CommCare App, tap the three dots in
                                the top-right corner, select "Update App," then
                                tap the three-dot menu again and choose "Offline
                                Update."
                              {% endblocktrans %}
                            </li>
                            <li>
                              {% trans "You'll be prompted to select this file from your phone's file system and install will begin" %}
                            </li>
                          </ol>
                          {% if multimedia_state.has_media %}
                            <div>
                              {% blocktrans %}
                                Note: Offline install automatically installs all
                                multimedia included in your form. All subsequent
                                remote updates will also include multimedia
                                which could require a lot of data. See the
                                <a
                                  href="https://dimagi.atlassian.net/wiki/spaces/commcarepublic/pages/2143946239/Installing+CommCare+on+Android+Devices"
                                >
                                  Help Site
                                </a>
                                for more info.
                              {% endblocktrans %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% if can_view_cloudcare and app.cloudcare_enabled %}
            <a
              class="
                accordion-header list-group-item list-group-item-action
                icon-link p-3 fs-5 track-usage-link"
              target="_blank"
              data-category="App Manager"
              data-action="Deploy Type"
              data-label="Open in Web Apps"
              data-bind="
                attr: { href: $root.webAppsUrl(id, '{{ app.id }}') }"
            >
              <i class="fa fa-desktop"></i>
              {% trans 'Open in Web Apps' %}
            </a>
          {% endif %}
          {% if can_send_sms %}
            <div class="accordion-item">
              <h4 class="accordion-header">
                <a
                  class="accordion-button icon-link fs-5 px-3 collapsed"
                  data-bs-toggle="collapse"
                  data-bind="
                    click: onSMSPanelClick,
                    attr: {
                      href: '#' + id() + '_sms',
                      'data-bs-target': '#' + id() + '_sms',
                    }"
                  aria-expanded="true"
                  aria-controls="panel-sms"
                >
                  <i class="fcc fcc-messaging"></i>
                  {% trans "Send to phone via SMS" %}
                </a>
              </h4>
              <div
                class="accordion-collapse collapse"
                data-bind="attr: {
                  id: id() + '_sms',
                  'data-bs-parent': '#deploy-accordion_' + id()
                }"
              >
                <div class="accordion-body">
                  <div>
                    {% include 'app_manager/partials/releases/releases_deploy_modal_sms.html' %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          {% if multimedia_state.has_media %}
            <div class="accordion-item">
              <h4 class="accordion-header">
                <a
                  class="accordion-button icon-link fs-5 px-3 collapsed"
                  data-bs-toggle="collapse"
                  data-bind="
                    click: function() { track_deploy_type('Download Multimedia'); },
                    attr: {
                      href: '#' + id() + '_multimedia',
                      'data-bs-target': '#' + id() + '_multimedia',
                    }
                  "
                  aria-expanded="true"
                  aria-controls="panel-multimedia"
                >
                  <i class="fa fa-camera"></i>
                  {% trans 'Download Multimedia' %}
                </a>
              </h4>
              <div
                class="accordion-collapse collapse"
                data-bind="attr: {
                  id: id() + '_multimedia',
                  'data-bs-parent': '#deploy-accordion_' + id()
                }"
              >
                <div class="accordion-body">
                  {% include 'hqmedia/partials/bootstrap5/multimedia_zip_notice.html' with include_modal=False %}
                </div>
              </div>
            </div>
          {% endif %}
          {% if request|toggle_enabled:"SUPPORT" %}
            <a
              class="
                accordion-header list-group-item list-group-item-action
                icon-link fs-5 p-3 track-usage-link"
              target="_blank"
              data-category="App Manager"
              data-action="Deploy Type"
              data-label="View Source Files"
              data-bind="attr: { href: $root.reverse('download_index', id) }"
            >
              <i class="fa-regular fa-file-lines"></i>
              {% trans 'View Source Files' %}
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div class="modal-footer">
      <a href="#" class="btn btn-outline-primary" data-bs-dismiss="modal"
        >{% trans "Close" %}</a
      >
    </div>
  </div>
</div>
