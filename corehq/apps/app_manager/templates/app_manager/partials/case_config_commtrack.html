{% load i18n %}

{#{% include 'app_manager/partials/case_config_shared.html' %}#}

<script type="text/html" id="remove-action-modal-template">
    <div class="modal-header">
        <a href="#" class="close" data-dismiss="modal">Ã—</a>
        <h3>{% trans "Remove Form Action?" %}</h3>
    </div>
    <div class="modal-body">
        <p>{% trans "Are you sure you want to remove this action?" %}</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">{% trans "Cancel" %}</a>
        <a class="btn btn-danger" href="#" data-bind="click: $parent.removeFormAction" data-dismiss="modal">{% trans "Remove Action" %}</a>
    </div>
</script>

<script type="text/html" id="case-config:condition">
    <!--ko with: condition -->
    <div data-bind="visible: type() === 'always' && $root.edit">
        <a href="#" data-bind="click: function () {type('if')}"><i class="icon-plus"></i> {% trans "Only if the answer to..." %}</a>
    </div>
    <div data-bind="visible: type() === 'if'">
        <a href="#" data-bind="click: function () {type('always')}, visible: $root.edit"><i class="icon-remove"></i></a>
        {% trans "Only if the answer to" %}
        <input class="input-large" type="hidden" data-bind="
            questionsSelect: $root.getQuestions('select1', false, true),
            value: question,
            optionsCaption: ' ',
            edit: $root.edit"
        />
        {% trans "is" %}
        <span data-bind="if: $root.getAnswers({question: question()}).length">
            <select data-bind="
                optstr: $root.getAnswers({question: question()}),
                value: answer,
                edit: $root.edit"></select>
        </span>
        <span data-bind="if: !$root.getAnswers({question: question()}).length">
            <input type="text" class="code" data-bind="value: answer, edit: $root.edit"/>
        </span>
    </div>
    <!--/ko-->
</script>

<script type="text/html" id="case-config:case-properties:question">
    <input class="input-large" type="hidden" data-bind="
        questionsSelect: $root.getQuestions('all', false, true),
        value: path,
        optionsCaption: ' ',
        edit: $root.edit"
    />
    <p class="help-inline" data-bind="visible: required() && !path()">{% trans "Required" %}</p>
</script>

<script type="text/html" id="case-config:case-properties:property">
    <span data-bind="visible: !property.required()">
        <input type="text" class="input-medium" data-bind="
            valueDefault: property.key,
            default: property.defaultKey,
            edit: $root.edit,
            typeahead: suggestedProperties
        "/>
    </span>
    <span data-bind="visible: property.required()">
        <code data-bind="text: property.key"></code>
    </span>
</script>


<script type="text/html" id="case-config:case-load:preload">
    <em>{% trans "Load the following case properties into the form" %}</em>
    <div class="alert alert-block alert-info" data-bind="visible: !preload().length">
        {% trans "No case properties will be loaded" %}
    </div>
    <table class="table table-condensed" data-bind="visible: preload().length">
        <thead>
            <tr>
                <th></th>
                <th>{% trans "Case Property" %}</th>
                <th></th>
                <th>{% trans "Question" %}</th>
            </tr>
        </thead>

        <tbody data-bind="foreach: preload">
            <tr class="control-group" data-bind="css: {error: validateProperty() || validateQuestion()}">
                <td>
                    <a href="#" data-bind="
                        click: $parent.removePreload,
                        visible: $root.edit && !(isBlank() && $index() === $parent.preload().length - 1)">
                        <i class="icon-remove"></i>
                    </a>
                </td>
                <td>
                    <div data-bind="template: {
                        name: 'case-config:case-properties:property',
                        data: {'property': $data, 'suggestedProperties': $parent.suggestedProperties}
                    }"></div>
                    <p class="help-inline" data-bind="html: validateProperty, visible: validateProperty"></p>
                </td>
                <td>
                    <i class="icon-arrow-right"></i>
                </td>
                <td>
                    <div data-bind="template: 'case-config:case-properties:question'"></div>
                    <p class="help-inline" data-bind="html: validateQuestion, visible: validateQuestion"></p>
                </td>
            </tr>
        </tbody>
    </table>
    <a href="#" data-bind="click: addPreload, visible: $root.edit && !preload().length">
        <i class="icon-plus"></i>
        {% trans "Load properties" %}
    </a>
</script>

<script type="text/html" id="case-config:case-load:update">
    <em>{% trans "Save data to the following case properties" %}</em>
    <div class="alert alert-block alert-info" data-bind="visible: !case_properties().length">
        {% trans "No case properties will be saved" %}
    </div>
    <table class="table table-condensed" data-bind="visible: case_properties().length">
        <thead>
            <tr>
                <th></th>
                <th>{% trans "Question" %}</th>
                <th></th>
                <th>{% trans "Case Property" %}</th>
            </tr>
        </thead>

        <tbody data-bind="foreach: case_properties">
            <tr class="control-group" data-bind="css: {error: validate, warning: !validate() && required() && !path()}">
                <td>
                    <a href="#" data-bind="
                        click: $parent.removeProperty,
                        visible: $root.edit && !required() && !(isBlank() && $index() === $parent.case_properties().length - 1)
                    ">
                        <i class="icon-remove"></i>
                    </a>
                </td>
                <td>
                    <div data-bind="template: 'case-config:case-properties:question'"></div>
                </td>
                <td>
                    <i class="icon-arrow-right"></i>
                </td>
                <td>
                    <div data-bind="template: {
                        name: 'case-config:case-properties:property',
                        data: {property: $data, suggestedProperties: $parent.suggestedProperties}
                    }"></div>
                    <p class="help-inline" data-bind="html: validate, visible: validate"></p>
                </td>
            </tr>
        </tbody>
    </table>
    <a href="#" data-bind="click: addProperty, visible: $root.edit && !case_properties().length">
        <i class="icon-plus"></i>
        {% trans "Save properties" %}
    </a>
</script>

<script type="text/html" id="case-config:case-action">
    <h3><a href="#">
        <strong data-bind="text: case_tag"></strong>
        &nbsp;
        ({% trans "Type: " %}<span data-bind="text: case_type" />)
        </a>
    </h3>
    <div>
            <div>
                <i class="icon-ok"></i>
                {% trans "Select case module:" %}
                <span class="control-group" data-bind="css: {warning: validate()}">
                    <select data-bind="
                        options: config.caseTypes,
                        optionsText: $parent.getCaseTypeLabel,
                        value: case_type,
                        optionsCaption: 'Choose a Module...',
                        edit: $root.edit"
                    ></select>
                    &nbsp;
                    {% trans "Case Tag:" %}
                    <input type="text" class="input-medium" data-bind="value: case_tag" />
                    <span class="help-inline" data-bind="text: validate"></span>
                    <a href="#" data-bind="openModal: 'remove-action-modal-template', visible: $root.edit" class="pull-right">
                        <i class="icon-trash"></i>
                        {% trans "Remove action" %}
                    </a>
                </span>
            </div>
            <div data-bind="visible: !case_type">
                <em>{% trans "Please select a case type." %}</em>
            </div>
            <div data-bind="visible: case_type">
                <!--ko if: actionType == 'open'-->
                <div data-bind="template: {
                    name: 'case-config:condition',
                    data: {condition: open_condition}
                }"></div>
                <!-- /ko -->
                <div data-bind="if: actionType == 'load'" class="row-fluid">
                    <div class="well span6">
                        <div data-bind="template: 'case-config:case-load:preload'"></div>
                    </div>
                    <div class="well span6">
                        <div data-bind="template: 'case-config:case-load:update'"></div>
                    </div>
                </div>
                <div data-bind="if: actionType == 'open'" class="row-fluid">
                    <div class="well">
                        <div data-bind="template: 'case-config:case-load:update'"></div>
                    </div>
                    <div class="well">
                        <em>{% trans "Make this case a subcase of another case" %}</em>
                        <label>
                            <input type="checkbox" data-bind="checked: subcase"/>
                            {% trans "Make subcase" %}
                        </label>
                        <div data-bind="if: subcase">
                            <select data-bind="optstr: $parent.getCaseTags('load'),
                                value: parent_tag,
                                edit: $root.edit"></select>
                        </div>
                    </div>
                </div>
                <div class="well">
                    <em>{% trans "Close this case when the form is complete" %}</em>
                    <label>
                        <input type="checkbox" data-bind="checked: close_case"/>
                        {% trans "Close Case" %}
                    </label>
                    <div data-bind="template: {
                        name: 'case-config:condition',
                        data: {condition: close_condition},
                        if: close_case
                    }"></div>
                </div>
            </div>
    </div>
</script>
{#<!--ko if: actionType() !== 'none'-->#}
<div id="case-config-ko" class="row">
    <div data-bind="saveButton: saveButton, visible: $root.edit"></div>
    <div data-bind="with: caseConfigViewModel" class="span11">
        <div class="dropdown" data-bind="visible: actionOptions().length">
            <a href="#" data-toggle="dropdown">
                <i class="icon-plus icon-blue"></i>
                <span>{% trans "Add Action" %}</span><span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu" data-bind="foreach: actionOptions">
                <li><a href="#" data-bind="click: $parent.addFormAction, text: display"></a></li>
            </ul>
        </div>
        <div data-bind="visible: !actionOptions().length">
            <i class="icon-plus icon-muted"></i>
            <span class="muted">{% trans "Add Action" %}</span>
        </div>
        <div>
            <div class="row-fluid">
                <span data-bind="visible: actions.load_update_close_cases().length"><i class="icon-asterisk"></i> Load / Update / Close cases</span>
                <div id="case-load-accordion" data-bind="foreach: actions.load_update_close_cases, accordion: {header: '> div > h3', heightStyle: 'content', collapsible: true, autoFill: true}">
                    <div class="group" data-bind="template: {name: 'case-config:case-action'}"></div>
                </div>
            </div>
            <div class="row" data-bind="visible: actions.open_cases().length && actions.load_update_close_cases().length">
                <hr/>
            </div>
            <div class="row-fluid">
                <span data-bind="visible: actions.open_cases().length"><i class="icon-asterisk"></i> Open new cases</span>
                <div id="case-open-accordion" data-bind="foreach: actions.open_cases, accordion: {header: '> div > h3', heightStyle: 'content', collapsible: true, autoFill: true}">
                    <div class="group" data-bind="template: {name: 'case-config:case-action'}"></div>
                </div>
            </div>
        </div>
{#        <!--ko if: actionType() !== 'none'-->#}
{#        <header class="clearfix" data-bind="visible: actionType() !== 'open-other'">#}
{#            <h5 class="pull-left">{% trans "Child Cases" %}</h5>#}
{#            <span data-bind="makeHqHelp: {}"#}
{#              data-title="{% trans "Child Cases" %}"#}
{#              data-content="{% trans "Child Cases let you open other types of cases for use in other modules. When possible, they'll be linked to the current case so you'll always know where they came from. A great use of Child Cases is for tracking a newborn separately from its mother." %}"#}
{#            ></span>#}
{#        </header>#}
{##}
{#        <div data-bind="foreach: subcases" class="form">#}
{#            <div>#}
{#                <i class="icon-ok"></i>#}
{#                {% trans "Opens a case for a different case list:" %}#}
{#                <span class="control-group" data-bind="css: {warning: !case_type()}">#}
{#                    <select data-bind="#}
{#                        options: $parent.caseTypes,#}
{#                        optionsText: $parent.getCaseTypeLabel,#}
{#                        value: case_type,#}
{#                        optionsCaption: 'Choose a Module...',#}
{#                        edit: $root.edit"#}
{#                    ></select>#}
{#                    <span class="help-inline" data-bind="visible: !case_type()">{% trans "Required" %}</span>#}
{#                    {% if show_custom_ref %}#}
{#                        <label>{% trans "Override reference id: " %}</label>#}
{#                        <input type="text" data-bind="value: reference_id, edit: $root.edit"/>#}
{#                    {% endif %}#}
{#                </span>#}
{#                <a href="#" data-bind="openModal: 'remove-subcase-modal-template', visible: $root.edit" class="pull-right">#}
{#                    <i class="icon-trash"></i>#}
{#                    {% trans "Remove case" %}#}
{#                </a>#}
{#            </div>#}
{#            <div data-bind="template: 'case-config:case-transaction'"></div>#}
{#        </div>#}
{#        <div>#}
{#            <a href="#" data-bind="click: addSubCase, visible: $root.edit">#}
{#                <i class="icon-plus"></i>#}
{#                {% trans "Opens a case for a different case list..." %}#}
{#            </a>#}
{#        </div>#}
{#        <!--/ko-->#}
    </div>
</div>
