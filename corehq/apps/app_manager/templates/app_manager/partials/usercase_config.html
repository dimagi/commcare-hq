{% load i18n %}

<script type="text/html" id="usercase-config:case-properties:question">
    <input class="input-large" type="hidden" data-bind="
        questionsSelect: $root.getQuestions('all', false, true, true),
        value: path,
        optionsCaption: ' '
    "/>
    <!-- TODO: usercase_transaction not in scope: $root.getQuestions('all', false, usercase_transaction.allow.repeats(), true) -->
    <p class="help-inline" data-bind="visible: required() && !path()">{% trans "Required" %}</p>
    <p class="help-inline" data-bind="visible: !required() && !path() && key()">{% trans "Not assigned" %}</p>
</script>

<script type="text/html" id="usercase-config:case-properties:property">
    <span data-bind="visible: !property.required()">
        <input type="text" class="input-medium" data-bind="
            valueDefault: property.key,
            default: property.defaultKey,
            casePropertyTypeahead: suggestedProperties,
            event: {
                change: function(){
                    var el = $($element)
                    var caretPosition = el.caret();
                    el.val(el.val().replace(/ /g,'_'));
                    el.caret(caretPosition);
                    return true;
                }
            }
        "/>
    </span>
    <span data-bind="visible: property.required()">
        <code data-bind="text: property.key"></code>
    </span>
</script>

<script type="text/html" id="usercase-config:case-transaction:case-preload">
    <em>{% trans "Load the following user case properties into the form" %}</em>
    <div class="alert alert-block alert-info" data-bind="visible: !case_preload().length">
        {% trans "No user case properties will be loaded" %}
    </div>
    <table class="table table-condensed" data-bind="visible: case_preload().length">
        <thead>
            <tr>
                <th></th>
                <th>{% trans "User Case Property" %}</th>
                <th></th>
                <th>{% trans "Question" %}</th>
            </tr>
        </thead>

        <tbody data-bind="foreach: case_preload">
            <tr class="control-group" data-bind="css: {error: validateProperty || validateQuestion}">
                <td>
                    <a href="#" data-bind="
                        click: $parent.removePreload,
                        visible: !(isBlank() && $index() === $parent.case_preload().length - 1)">
                        <i class="icon-remove"></i>
                    </a>
                </td>
                <td>
                    <div data-bind="template: {
                        name: 'usercase-config:case-properties:property',
                        data: {'property': $data, 'suggestedProperties': case_transaction.suggestedPreloadProperties}
                    }"></div>
                    <p class="help-inline" data-bind="html: validateProperty, visible: validateProperty"></p>
                </td>
                <td>
                    <i class="icon-arrow-right"></i>
                </td>
                <td>
                    <div data-bind="template: 'usercase-config:case-properties:question'"></div>
                    <p class="help-inline" data-bind="html: validateQuestion, visible: validateQuestion"></p>
                </td>
            </tr>
        </tbody>
    </table>
    <a href="#" data-bind="click: addPreload, visible: !case_preload().length">
        <i class="icon-plus"></i>
        {% trans "Load properties" %}
    </a>
</script>

<script type="text/html" id="usercase-config:case-transaction:case-properties">
    <em>{% trans "Save data to the following user case properties" %}</em>
    <div class="alert alert-block alert-info" data-bind="visible: !case_properties().length">
        {% trans "No user case properties will be saved" %}
    </div>
    <table class="table table-condensed" data-bind="visible: case_properties().length">
        <thead>
            <tr>
                <th></th>
                <th>{% trans "Question" %}</th>
                <th></th>
                <th>{% trans "User Case Property" %}</th>
            </tr>
        </thead>

        <tbody data-bind="foreach: case_properties">
            <tr class="control-group" data-bind="css: {error: validate, warning: (!validate() && required() && !path()) || (!validate() && !required() && !path() && key())}">
                <td>
                    <a href="#" data-bind="
                        click: $parent.removeProperty,
                        visible: !required() && !(isBlank() && $index() === $parent.case_properties().length - 1)
                    ">
                        <i class="icon-remove"></i>
                    </a>
                </td>
                <td>
                    <div data-bind="template: 'usercase-config:case-properties:question'"></div>
                </td>
                <td>
                    <i class="icon-arrow-right"></i>
                </td>
                <td>
                    <div data-bind="template: {
                        name: 'usercase-config:case-properties:property',
                        data: {property: $data, suggestedProperties: case_transaction.suggestedSaveProperties}
                    }"></div>
                    <p class="help-inline" data-bind="html: validate, visible: validate"></p>
                </td>
            </tr>
        </tbody>
    </table>
    <a href="#" data-bind="click: addProperty, visible: !case_properties().length">
        <i class="icon-plus"></i>
        {% trans "Save properties" %}
    </a>
</script>

<script type="text/html" id="usercase-config:case-transaction">
    <div class="row-fluid top-spacer">
        <div class="well span6">
            <div data-bind="template: 'usercase-config:case-transaction:case-preload'"></div>
        </div>
        <div class="well span6">
            <div data-bind="template: 'usercase-config:case-transaction:case-properties'"></div>
        </div>
    </div>
</script>

<div id="usercase-config-ko">
    <div class="row-fluid">
        <div class="span12">
            <div data-bind="saveButton: saveUsercaseButton"></div>
        </div>
    </div>
    <div data-bind="with: caseConfigViewModel">
        <div data-bind="template: {name: 'usercase-config:case-transaction', data: usercase_transaction }"></div>
        {% comment %} subcases removed for now {% endcomment %}
    </div>
</div>
