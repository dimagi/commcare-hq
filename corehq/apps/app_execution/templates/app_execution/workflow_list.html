{% extends "hqwebapp/bootstrap5/base_section.html" %}
{% load hq_shared_tags %}
{% load compress %}
{% load i18n %}

{% block stylesheets %}{{ block.super }}
{% compress css %}
    <link type="text/css"
          rel="stylesheet"
          media="all"
          href="{% static 'nvd3-1.8.6/build/nv.d3.css' %}" />
  {% endcompress %}
{% endblock %}

{% requirejs_main_b5 'app_execution/js/workflow_timing_chart' %}

{% block page_content %}
  <div>
    <a class='btn btn-primary' href="{% url 'app_execution:new_workflow' request.domain %}">Create New</a>
  </div>
  <div>
    <h3>{% trans "Average Timings Per Hour" %}</h3>
    <div id="timing_linechart"><svg height="300px"></svg></div>
  </div>
  <table class="table table-striped table-hover">
  <thead>
  <tr>
    <th>Name</th>
    <th>App Name</th>
    <th>User</th>
    <th>Last Run</th>
    <th>Last 10 Runs</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  {% for workflow in workflows %}
  <tr>
    <td><a href="{% url "app_execution:edit_workflow" request.domain workflow.id %}">{{ workflow.name }}</a></td>
    <td>{{ workflow.app_name }}</td>
    <td>{{ workflow.django_user.username }}</td>
    <td>{{ workflow.last_run|default:""|date:"DATETIME_FORMAT" }}</td>
    <td>
      <div class="row g-0 column-gap-1">
        {% for status in workflow.last_n %}
          {% if not status %}
          <div class="col col-sm-1 bg-secondary-subtle" style="width: 10px">&nbsp;</div>
          {% else %}
           <div class="col col-sm-1 {% if status.success %}bg-success{% else %}bg-danger{% endif %}" style="width: 10px">
             <a href="{% url "app_execution:workflow_log" request.domain status.id %}" class="w-100 h-100 d-block">&nbsp;</a>
           </div>
          {% endif %}
        {% endfor %}
      </div>
    </td>
    <td>
      <div class="btn-group" role="group" aria-label="Actions">
        <a class="btn btn-primary" href="{% url "app_execution:test_workflow" request.domain workflow.id %}">Test</a>
        <a class="btn btn-primary" href="{% url "app_execution:workflow_logs" request.domain workflow.id %}">Logs</a>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>

{{ chart_data|json_script:"chart_data" }}
<script id="includeSeries" type="application/json">
  [{"label": "", "key": "avg_duration"}]
</script>
{% endblock %}
