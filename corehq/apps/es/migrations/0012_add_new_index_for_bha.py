# Generated by Django 4.2.11 on 2024-05-10 14:28

from django.conf import settings
from django.db import migrations

from corehq.apps.es.mappings.case_search_mapping import CASE_SEARCH_MAPPING
from corehq.apps.es.migration_operations import (
    CreateIndex,
    DeleteOnlyIfIndexExists,
)
from corehq.apps.es.utils import index_runtime_name


def _create_bha_index_on_saas_envs(apps, schema_editor):
    if settings.IS_SAAS_ENVIRONMENT:
        CreateIndex(
            name=index_runtime_name('case-search-bha-2024-05-10'),
            type_='case',
            mapping=CASE_SEARCH_MAPPING,
            analysis={
                'filter': {'soundex': {'encoder': 'soundex', 'replace': 'true', 'type': 'phonetic'}},
                'analyzer': {'default': {'filter': ['lowercase'], 'tokenizer': 'whitespace', 'type': 'custom'}, 'phonetic': {'filter': ['standard', 'lowercase', 'soundex'], 'tokenizer': 'standard'}},
            },
            settings_key='case_search_bha',
            es_versions=[5],
        ).run()


def _reverse(apps, schema_editor):
    if settings.IS_SAAS_ENVIRONMENT:
        DeleteOnlyIfIndexExists(index_runtime_name('case-search-bha-2024-05-10')).run()


class Migration(migrations.Migration):

    dependencies = [
        ('es', '0011_add_indices_for_es5_reindex'),
    ]

    operations = [
        migrations.RunPython(_create_bha_index_on_saas_envs, reverse_code=_reverse)
    ]
