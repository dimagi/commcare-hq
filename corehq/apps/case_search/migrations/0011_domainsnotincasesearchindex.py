# Generated by Django 3.2.18 on 2023-03-15 19:13

from django.db import migrations, models

from corehq.apps.case_search.models import case_search_enabled_domains
from corehq.apps.domain.models import Domain
from corehq.apps.hqcase.analytics import get_number_of_cases_in_domain
from corehq.toggles import CASE_LIST_EXPLORER, EXPLORE_CASE_DATA, ECD_MIGRATED_DOMAINS, CASE_API_V0_6
from corehq.util.django_migrations import skip_on_fresh_install


@skip_on_fresh_install
def _mark_domains_needing_case_search_migration(apps, schema_editor):
    from corehq.apps.case_search.models import DomainsNotInCaseSearchIndex
    domains_already_enabled_for_case_search = set(
        list(case_search_enabled_domains())
        + CASE_LIST_EXPLORER.get_enabled_domains()
        + EXPLORE_CASE_DATA.get_enabled_domains()
        + ECD_MIGRATED_DOMAINS.get_enabled_domains()
        + CASE_API_V0_6.get_enabled_domains()
    )
    for domain_data in Domain.get_all(include_docs=False):
        domain_name = domain_data["key"]
        if domain_name not in domains_already_enabled_for_case_search:
            num_cases = get_number_of_cases_in_domain(domain_name)
            DomainsNotInCaseSearchIndex.objects.create(
                domain=domain_name,
                estimated_size=num_cases,
            )


@skip_on_fresh_install
def _undo_mark_domains_needing_search_migration(apps, schema_editor):
    from corehq.apps.case_search.models import DomainsNotInCaseSearchIndex
    DomainsNotInCaseSearchIndex.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('case_search', '0010_casesearchconfig_synchronous_web_apps'),
    ]

    operations = [
        migrations.CreateModel(
            name='DomainsNotInCaseSearchIndex',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('domain', models.CharField(db_index=True, max_length=256)),
                ('estimated_size', models.IntegerField()),
            ],
        ),
        migrations.RunPython(
            _mark_domains_needing_case_search_migration,
            _undo_mark_domains_needing_search_migration
        ),
    ]
