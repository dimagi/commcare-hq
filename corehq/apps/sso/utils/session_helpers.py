import logging

log = logging.getLogger(__name__)


def store_saml_data_in_session(request):
    """
    This stores SAML-related authentication data in the request's session
    :param request: HttpRequest
    """
    request.session['samlUserdata'] = request.saml2_auth.get_attributes()
    request.session['samlNameId'] = request.saml2_auth.get_nameid()
    request.session['samlNameIdFormat'] = request.saml2_auth.get_nameid_format()
    request.session['samlNameIdNameQualifier'] = request.saml2_auth.get_nameid_nq()
    request.session['samlNameIdSPNameQualifier'] = request.saml2_auth.get_nameid_spnq()
    request.session['samlSessionIndex'] = request.saml2_auth.get_session_index()


def _get_saml_user_data_property(request, prop_slug):
    """
    Shortcut for getting samlUserData properties generated by python3-saml.
    These can sometimes manifest as lists or strings.
    :param request: HttpRequest
    :param prop_slug: string (property slug)
    :return: string or None
    """
    value = request.session.get('samlUserdata', {}).get(prop_slug)
    if isinstance(value, list):
        # for Azure AD the data is usually returned as a list
        value = value[0] if value else ''
    return value


def get_sso_user_first_name_from_session(request):
    """
    This gets the first name from sso user data stored in the session SAML data.
    :param request: HttpRequest
    :return: string or None
    """
    return _get_saml_user_data_property(
        request,
        'http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname'
    )


def get_sso_user_last_name_from_session(request):
    """
    This gets the last name from sso user data stored in the session SAML data.
    :param request: HttpRequest
    :return: string or None
    """
    return _get_saml_user_data_property(
        request,
        'http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname'
    )


def prepare_session_with_sso_username(request, username):
    """
    Prepares the request's Session to store username information related to
    a user that is signing up or a user that is signing in using SSO from
    a registration, invitation, or sign in form.
    :param request: HttpRequest
    :param username: string - username / email
    """
    request.session['ssoNewUsername'] = username


def get_sso_username_from_session(request):
    """
    If present, this gets the ssoUsername stored in the request's session.
    :param request: HttpRequest
    :return: string or None - username
    """
    return request.session.get('ssoNewUsername')
