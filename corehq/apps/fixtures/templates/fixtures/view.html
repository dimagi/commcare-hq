{% extends base_template %}
{% load hq_shared_tags %}

{% block oldstyle_tag %}{% endblock %}
{% block oldstyle_imports %}{% endblock %}
{% block oldstyle_hack_start %}{% endblock %}
{% block oldstyle_hack_end %}{% endblock %}

{% block js %}{{ block.super }}
<script src="{% static 'hqwebapp/javascripts/knockout-2.0.0.debug.js' %}"></script>
<script src="{% static 'hqwebapp/javascripts/knockout.mapping.js' %}"></script>
{% endblock %}
{% block head %}
<style>
    .selected, .table tr.selected, .table tr.selected:hover, .table tr.selected > td {
        background-color: #ddd !important;
    }
</style>
{% endblock %}
{% block js-inline %}
    <script>
        $(function () {
            function makeEditable(o) {


                o.editing = ko.observable(false);
                o.startEditing = function () {
                    o.editing(true);
                    o._backup = o.serialize();
                };
                o.stopEdit = function () {
                    o.editing(false);
                };
                o.cancelEdit = function () {
                    o.editing(false);
                    o.cancel();
                };
                o.saveEdit = function () {
                    o.editing(false);
                    o.save();
                };
            }
            function makeDataType(o) {
                var self = ko.mapping.fromJS(o),
                    raw_fields = self.fields();
                self.fields = ko.observableArray([]);
                self.data_items = ko.observableArray([]);
                makeEditable(self);

                self.addField = function (data, event, o) {
                    var i, field;
                    if (o) {
                        field = {
                            tag: ko.observable(o.tag),
                            editing: ko.observable(false)
                        };
                    } else {
                        field = {
                            tag: ko.observable(""),
                            editing: ko.observable(true)
                        };
                    }
                    field.editTag = ko.computed({
                        read: function () {
                            return field.tag();
                        },
                        write: function (tag) {
                            var j, noRepeats = true;
                            for (j = 0; j < self.fields().length; j += 1) {
                                if (self.fields()[j].tag === tag) {
                                    noRepeats = false;
                                }
                            }
                            if (noRepeats) {
                                var oldTag = field.tag;
                                field.tag(tag);
                            }
                        }
                    });
                    self.fields.push(field);
                    for (i = 0; i < self.data_items().length; i += 1) {
                        self.data_items()[i].fields.push({value: ko.observable(""), tag: field.tag});
                    }
                };
                self.removeField = function (field) {
                    var i,
                        index = self.fields.indexOf(field),
                        itemFields;
                    self.fields.remove(field);
                    for (i = 0; i < self.data_items().length; i += 1) {
                        itemFields = self.data_items()[i].fields;
                        itemFields.remove(itemFields()[index]);
                    }
                };
                for (var i = 0; i < raw_fields.length; i += 1) {
                    self.addField(undefined, undefined, {tag: raw_fields[i]});
                }
                self.addDataItem = function (data, event) {
                    var item = makeDataItem({
                        fields: {},
                        _id: null
                    });
                    item.editing(true);
                    self.data_items.push(item);
                };
                self.removeDataItem = function (item, event) {
                    self.data_items.destroy(item);
                    item.save();
                };
                function makeDataItem(o) {
                    var item = ko.mapping.fromJS(o);
                    var fields_dict = item.fields;
                    item.fields = ko.observableArray([]);
                    for (var i = 0; i < self.fields().length; i += 1) {
                        item.fields.push({
                            value: fields_dict[self.fields()[i].tag()] || ko.observable(""),
                            tag: self.fields()[i].tag
                        });
                    }
                    makeEditable(item);
                    item.saveState = ko.observable('saved');


                    item.serialize = function () {
                        return {
                            fields: (function () {
                                var i, fields = {};
                                for (i = 0; i < item.fields().length; i += 1) {
                                    fields[item.fields()[i].tag()] = item.fields()[i].value();
                                }
                                return fields;
                            }())
                        };
                    };
                    item.save = function () {
                        console.log('saving');
                        $.ajax({
                            type: item._id() ? (item._destroy ? 'delete': 'put') : 'post',
                            url: 'data-items/' + self._id() + '/' + (item._id() || ''),
                            data: JSON.stringify(item.serialize()),
                            dataType: 'json',
                            success: function (data) {
                                item.saveState('saved');
                                if (!item._id()) {
                                    item._id(data._id);
                                }
                            }
                        });
                        item.saveState('saving');
                    };
                    item.cancel = function () {
                        var backup = item._backup,
                            i,
                            tag;
                        for (i = 0; i < item.fields().length; i += 1) {
                            tag = item.fields()[i].tag();
                            item.fields()[i].value(backup.fields[tag]);
                        }
                    };
                    return item;
                }

                if (self._id) {
                    $.ajax({
                        url: 'data-items/' + self._id() + '/',
                        type: 'get',
                        dataType: 'json',
                        success: function (data) {
                            for (var i = 0; i < data.length; i += 1) {
                                self.data_items.push(makeDataItem(data[i]));
                            }
                        }
                    });
                }
                self.serialize = function () {
                    return ko.toJS(self);
                };
                return self;
            }
            function App() {
                var self = this;
                self.data_types = ko.observableArray([]);

                self.addDataType = function () {
                    var dataType = makeDataType({
                        name: "",
                        tag: "",
                        fields: ko.observableArray([])
                    });
                    dataType.editing(true);
                    self.data_types.push(dataType);
                };
                self.removeDataType = function (dataType) {
                    self.data_types.destroy(dataType);
                };

                $.ajax({
                    url: 'data-types/',
                    type: 'get',
                    dataType: 'json',
                    success: function (data) {
                        var dataType;
                        for (var i = 0; i < data.length; i += 1) {
                            self.data_types.push(makeDataType(data[i]));
                            dataType = self.data_types()[i];
                        }
                    }
                });
            }
            ko.applyBindings(new App());
        });
    </script>
{% endblock %}

{% block content %}
    <div>
        <div data-bind="foreach: data_types">
            <section class="well" data-bind="css: {selected: editing}">
                <h1 data-bind="text: name"></h1>
                <div style="float: left">
                    <button class="btn" data-bind="click: function (data) { data.editing(true); }">
                        <i class="icon-edit"></i>
                        Edit Type
                    </button>
                    <div class="modal" data-bind="visible: editing">
                        <div class="modal-header">
                            <a class="close" data-bind="click: function (data) { data.editing(false); }">×</a>
                            <h3>Edit Data Type "<span data-bind="text: name"></span>"</h3>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <label class="span2">Name</label>
                                <input data-bind="value: name"/>
                            </div>
                            <div class="row">
                                <label class="span2">Tag</label>
                                <input data-bind="value: tag"/>
                            </div>
                            <h4>Fields</h4>
                            <div>
                                <ul data-bind="foreach: fields">
                                    <li>
                                        <input class="input-small" data-bind="value: editTag, hasfocus: true"/>
                                        <button class="btn btn-danger" data-bind="click: $parent.removeField">
                                            <i class="icon-white icon-trash"></i>
                                        </button>
                                    </li>
                                </ul>
                                <button class="btn btn-primary btn-small" data-bind="click: addField">
                                    <i class="icon-white icon-plus"></i>
                                    Add Field
                                </button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" data-bind="click: stopEdit">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
                <div style="float: right">
                    <button class="btn btn-danger float-right" data-bind="click: $root.removeDataType">
                        <i class="icon-white icon-trash"></i>
                        Delete Type
                    </button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th class="span1"></th>
                            <th class="span1">Data</th>
                            <th class="span1">Groups</th>
                            <th class="span1">Users</th>
                            <th class="span1"></th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: data_items">

                        <tr data-bind="css: {selected: editing()}">
                            <td>
                                <button class="btn btn-small" data-bind="click: startEditing, visible: saveState() === 'saved'">
                                    <i class="icon-edit"></i>
                                    Edit Item
                                </button>
                                <button class="btn btn-small disabled" data-bind="visible: saveState() === 'saving'">Saving...</button>
                                <div class="modal" data-bind="visible: editing">
                                    <div class="modal-header">
                                        <a class="close" data-bind="click: cancelEdit">×</a>
                                        <h3>Edit <span data-bind="text: $parent.name"></span></h3>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-bordered">
                                            <tbody data-bind="foreach: fields">
                                            <tr>
                                                <th data-bind="text: tag"></th>
                                                <td><input data-bind="value: value"/></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary" data-bind="click: saveEdit">
                                            Save
                                        </button>
                                        <button class="btn" data-bind="click: cancelEdit">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </td>

                            <td>
                                <dl class="dl-horizontal" data-bind="foreach: fields">
                                    <dt data-bind="text: tag"></dt>
                                    <dd>
                                        <span data-bind="text: value"></span>
                                        <h6 data-bind="visible: !value()">(No data)</h6>
                                    </dd>
                                </dl>
                            </td>
                            <td>
                                <h6>(No groups)</h6>
                            </td>
                            <td>
                                <h6>(No users)</h6>
                            </td>
                            <td>
                                <button class="btn btn-small btn-danger" data-bind="click: $parent.removeDataItem">
                                    <i class="icon-white icon-trash"></i>
                                    Delete Item
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" data-bind="click: addDataItem">
                    <i class="icon-white icon-plus"></i>
                    Add Item
                </button>
            </section>
        </div>
        <section>
            <button class="btn btn-primary" data-bind="click: addDataType">
                <i class="icon-white icon-plus"></i>
                Add Data Type
            </button>
        </section>
    </div>
{% endblock %}