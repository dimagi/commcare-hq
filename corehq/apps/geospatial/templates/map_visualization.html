{% extends "reports/tabular.html" %}
{% load i18n %}

{% block reportcontent %}
<div class="panel panel-default" id="user-filters-panel">
    <div class="panel-body collapse in" aria-expanded="true">
        <legend>
            {% trans "Mobile Worker Filters" %}
        </legend>
        <div class="alert alert-danger" data-bind="visible: hasErrors()">
            <i class="fa fa-exclamation-triangle"></i>
            {% blocktrans %}
                <strong>There was an issue retrieving mobile workers from the server.</strong>
                If this problem continues, please
                <a href="#modalReportIssue" data-toggle="modal">report an issue</a>.
            {% endblocktrans %}
        </div>
        <fieldset>
            <div class="form-group">
                <label class="control-label col-sm-2">
                    {% trans "Show mobile workers on the map" %}
                </label>
                <div class="col-sm-4">
                    <input type="checkbox" data-bind="checked: $root.shouldShowUsers, event: {change: onFiltersChange}" />
                </div>
            </div>
        </fieldset>
        <fieldset>
            <div class="form-group">
                <label class="control-label col-sm-2">
                    {% trans "Location" %}
                </label>
                <div class="col-sm-4">
                    <select class="form-control"
                            type="text"
                            id="location-filter-select"
                            data-bind="select2: {},
                                       optionsText: 'text',
                                       optionsValue: 'id',
                                       event: {change: onLocationFilterChange},
                                       enable: $root.shouldShowUsers">
                    </select>
                    <p class="help-block">
                        <i class="fa fa-info-circle"></i>
                        {% blocktrans %}
                            Only users at this location will be shown on the map.
                        {% endblocktrans %}
                    </p>
                </div>
            </div>
        </fieldset>
        <div class="spacer"></div>
        <div class="form-actions">
            <button type="button" class="btn btn-primary" style="float:left; margin-left:1em" data-bind="event: {click: loadUsers}, enable: hasFiltersChanged()">
                {% trans "Apply" %}
            </button>
        </div>
    </div>
    <div class="panel-footer">
        <button class="btn btn-default" data-bind="event: {click: toggleFilterMenu}">
            <span data-bind="visible: showFilterMenu()">
                {% trans "Hide Filter Options" %}
            </span>
            <span data-bind="visible: !showFilterMenu()">
                {% trans "Show Filter Options" %}
            </span>
        </button>
    </div>
</div>
<div class="row panel" id="mapControls">
    <label for="saved-polygons" class="control-label col-sm-2 col-md-2 col-lg-2">
    {% trans "Filter by Saved Area" %}</label>
    <div class="controls col-sm-2 col-md-2 col-lg-2">
        <select id="saved-polygons"
                class="form-control"
                data-bind="select2: savedPolygons,
                        value: selectedSavedPolygonId,
                        ">
        </select>
    </div>
    <a id="btnExportDrawnArea" class="col-sm-2 btn btn-default" style="float:right; margin-right:1em" data-bind="attr: { disabled: btnExportDisabled }">
        {% trans 'Export Area' %}
    </a>
    <a id="btnSaveDrawnArea" class="col-sm-2 btn btn-default" style="float:right; margin-right:1em" data-bind="attr: { disabled: btnSaveDisabled }">
        {% trans 'Save Area' %}
    </a>
    <a id="btnRunDisbursement" class="col-sm-2 btn btn-primary" style="float:right; margin-right:1em" data-bind="attr: { disabled: btnRunDisbursementDisabled }">
        {% trans 'Run Disbursement' %}
    </a>
</div>
<div id="disbursement-spinner">
  <h4 id="loading" class="hide"
      data-bind="visible: isBusy(), css: {hide: false}">
    <i class="fa fa-spin fa-spinner"></i>
    {% trans "Running disbursement algorithm..." %}
  </h4>
</div>
<div id="geospatial-map" style="height: 500px"></div>

<!-- For Pagination -->
<div class="panel-body-datatable">
  {% block reporttable %}
    {% if report.needs_filters %}
      {% include 'reports/partials/description.html' %}
    {% else %}
      <table id="report_table_{{ report.slug }}" class="table table-striped datatable" width="100%" {% if pagination.filter %} data-filter="true"{% endif %}>
      </table>
    {% endif %}
  {% endblock reporttable %}
</div>

<div id="case-buttons" class="col-sm-12 col-md-12 col-lg-12">
    <div id="missing-gps-cases" style="display: inline;">
        <a class="btn btn-default" target="_blank" href="{% url 'gps_capture' domain %}"
                data-bind="visible: casesWithoutGPS().length > 0">
            <span data-bind="text: casesWithoutGPS().length"></span>
            &nbsp;{% trans "Cases Missing GPS Data" %}
        </a>
        <a class="btn btn-default" target="_blank" href="{% url 'gps_capture' domain %}?data_type=user" data-bind="visible: usersWithoutGPS().length">
            <span data-bind="text: usersWithoutGPS().length"></span>
            &nbsp;{% trans "Mobile Workers Missing GPS Data" %}
        </a>
    </div>

    <div id="user-modals" class="pull-right">
        <button class="btn btn-default" data-toggle="modal" data-target="#selected-user-list" data-bind="enable: selectedUsers().length">
            <span data-bind="text: selectedUsers().length"></span>
            &nbsp;{% trans "Selected Mobile Workers" %}
        </button>
        <div class="modal fade" id="selected-user-list">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                    <span class="sr-only">{% trans "Close" %}</span></button>
                    <h4 class="modal-title">{% trans "Selected Mobile Workers" %}</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-responsive">
                        <thead><th>{% trans "Username" %}</th></thead>
                        <tbody data-bind="foreach: selectedUsers">
                            <tr><td data-bind="html: $data.itemData.link"></td></tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
        <button class="btn btn-default" data-toggle="modal" data-target="#all-user-list">
            <span data-bind="text: userModels().length"></span>
            &nbsp;{% trans "Mobile Workers on Map" %}
        </button>
        <div class="modal fade" id="all-user-list">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                        <span class="sr-only">{% trans "Close" %}</span></button>
                        <h4 class="modal-title">{% trans "All Mobile Workers on Map" %}</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped table-responsive">
                            <thead><th>{% trans "Username" %}</th></thead>
                            <tbody data-bind="foreach: userModels">
                                <tr><td data-bind="html: $data.itemData.link"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="case-modals"  class="pull-right">
        <button class="btn btn-default" data-toggle="modal" data-target="#selected-case-list"
                data-bind="enable: selectedCases().length > 0">
            <span data-bind="text: selectedCases().length"></span>
            &nbsp;{% trans "Selected Cases" %}
        </button>
        <div class="modal fade" id="selected-case-list">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                    <span class="sr-only">{% trans "Close" %}</span></button>
                    <h4 class="modal-title">{% trans "Selected Cases" %}</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-responsive">
                        <thead><th>{% trans "Case Name" %}</th></thead>
                        <tbody data-bind="foreach: selectedCases">
                            <tr><td data-bind="html: $data.itemData.link"></td></tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
        <button class="btn btn-default" data-toggle="modal" data-target="#all-case-list">
            <span data-bind="text: caseModels().length"></span>
            &nbsp;{% trans "Cases on Map" %}
        </button>
        <div class="modal fade" id="all-case-list">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                        <span class="sr-only">{% trans "Close" %}</span></button>
                        <h4 class="modal-title">{% trans "All Cases on Map" %}</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped table-responsive">
                            <thead><th>{% trans "Case Name" %}</th></thead>
                            <tbody data-bind="foreach: caseModels">
                                <tr><td data-bind="html: $data.itemData.link"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="select-case">
    <small data-bind="html: getItemType()"></small>
    <div class="form-check">
      <input type="checkbox" class="form-check-input" data-bind="checked: isSelected, attr: {id: selectCssId}">
      <label class="form-check-label" data-bind="html: $data.itemData.link, attr: {for: selectCssId}"></label>
    </div>
</script>
{% endblock %}
