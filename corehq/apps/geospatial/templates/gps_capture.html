{% extends "hqwebapp/bootstrap3/base_section.html" %}
{% load compress %}
{% load i18n %}
{% load hq_shared_tags %}

{% requirejs_main 'geospatial/js/gps_capture' %}

{% block page_title %}
    {{ current_page.page_name }}
{% endblock page_title %}

{% block page_content %}
{% initial_page_data 'data_type' data_type %}
{% registerurl 'get_paginated_cases_or_users_without_gps' domain %}
{% registerurl 'case_data' domain '---' %}
{% registerurl 'edit_commcare_user' domain '---' %}
{% registerurl 'gps_capture' domain %}

<div id="no-gps-list" class="ko-template">
    <p class="lead">
        <p>
            {% if data_type == 'user' %}
                {% blocktrans %}
                    Mobile workers that do not have any associated GPS data.
                {% endblocktrans %}
            {% else %}
                {% blocktrans %}
                    Cases that do not have any associated GPS data.
                {% endblocktrans %}
            {% endif %}
        </p>
    </p>
    <div class="alert alert-success" data-bind="visible: isSubmissionSuccess">
        {% blocktrans %}
            Changes have been saved successfully!
        {% endblocktrans %}
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                {% if data_type == 'user' %}
                    {% trans 'Users without GPS Data' %}
                {% else %}
                    {% trans 'Cases without GPS Data' %}
                {% endif %}
            </h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-6">
                    <search-box data-apply-bindings="false"
                                params="value: query,
                                        action: function() { goToPage(1); },
                                        placeholder: '{% trans_html_attr "Search..." %}'"></search-box>
                </div>
            </div>
            <table class="table table-striped table-responsive"
                   style="margin-botton: 0;"
                   data-bind="visible: showTable">
                <thead>
                    <tr>
                        <th class="col-xs-3">
                            {% if data_type == 'user' %}
                                {% trans "Username" %}
                            {% else %}
                                {% trans "Name" %}
                            {% endif %}
                        </th>
                        <th class="col-xs-3">{% trans "Latitude" %}</th>
                        <th class="col-xs-3">{% trans "Longitude" %}</th>
                        <th class="col-xs-3">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: dataItems">
                    <tr>
                        <td>
                            <a target="_blank" data-bind="attr: {'href': url}">
                                <span data-bind="text: name"></span>
                            </a>
                        </td>
                        <td>
                            <input class="form-control"
                                   type="number"
                                   step="any"
                                   name="latInput"
                                   placeholder="{% trans 'Enter latitude...' %}"
                                   data-bind="value: lat, event: {change: onValueChanged}" />
                        </td>
                        <td>
                            <input class="form-control"
                                   type="number"
                                   step="any"
                                   name="lonInput"
                                   placeholder="{% trans 'Enter longitude...' %}"
                                   data-bind="value: lon, event: {change: onValueChanged}" />
                        </td>
                        <td>
                            <button type="button" class="btn btn-default" data-bind="event: {click: onMapCaptureStart}">
                                {% trans "Capture on Map" %}
                            </button>
                            <button type="button" class="btn btn-primary" data-bind="enable: canSaveRow, event: {click: $root.saveDataRow.bind($data)}">
                                {% trans "Save" %}
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="alert alert-info" data-bind="visible: showLoadingSpinner">
                <i class="fa fa-spin fa-spinner"></i>
                {% if data_type == 'user' %}
                    {% trans 'Loading users...' %}
                {% else %}
                    {% trans "Loading cases..." %}
                {% endif %}
            </div>
            <div class="alert alert-danger" data-bind="visible: hasError">
                <i class="fa fa-exclamation-triangle"></i>
                {% blocktrans %}
                  <strong>There was an issue retrieving data from the server.</strong>
                  Please check your internet connection.
                  If this problem continues, please
                  <a href="#modalReportIssue" data-toggle="modal">report an issue</a>.
                {% endblocktrans %}
            </div>
            <div class="alert alert-danger" data-bind="visible: hasSubmissionError">
                <i class="fa fa-exclamation-triangle"></i>
                {% blocktrans %}
                  <strong>There was an issue submitting data to the server.</strong>
                  Please check your internet connection.
                  If this problem continues, please
                  <a href="#modalReportIssue" data-toggle="modal">report an issue</a>.
                {% endblocktrans %}
            </div>
            <pagination data-apply-bindings="false"
                        data-bind="visible: showTable"
                        params="goToPage: goToPage,
                                slug: 'items-without-gps',
                                perPage: itemsPerPage,
                                totalItems: totalItems,
                                onLoad: onPaginationLoad,
                                showSpinner: showPaginationSpinner"></pagination>
        </div>
    </div>
</div>
{% endblock %}