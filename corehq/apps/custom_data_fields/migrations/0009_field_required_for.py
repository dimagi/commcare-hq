# Generated by Django 4.2.15 on 2024-10-09 17:52

from django.db import migrations, models

from corehq.util.django_migrations import skip_on_fresh_install

CUSTOM_USER_DATA_FIELD_TYPE = 'UserFields'
EXISTING_REQUIRED_FOR = ['web_user', 'commcare_user']
DEFAULT_REQUIRED_FOR = ['commcare_user']


@skip_on_fresh_install
def update_user_fields_required_for(apps, schema_editor):
    Field = apps.get_model('custom_data_fields', 'Field')
    CustomDataFieldsDefinition = apps.get_model('custom_data_fields', 'CustomDataFieldsDefinition')

    user_fields_definitions = CustomDataFieldsDefinition.objects.filter(field_type=CUSTOM_USER_DATA_FIELD_TYPE)

    for definition in user_fields_definitions:
        fields = Field.objects.filter(definition=definition, required_for=[])
        for field in fields:
            if field.is_required:
                field.required_for = EXISTING_REQUIRED_FOR
            else:
                field.required_for = DEFAULT_REQUIRED_FOR
            field.save()


class Migration(migrations.Migration):

    dependencies = [
        ('custom_data_fields', '0008_custom_data_fields_upstream_ids'),
    ]

    operations = [
        migrations.AddField(
            model_name='field',
            name='required_for',
            field=models.JSONField(default=list),
        ),
        migrations.RunPython(update_user_fields_required_for, migrations.RunPython.noop),
    ]
