{% extends "orgs/report_base.html" %}
{% load hq_shared_tags %}
{% load hqstyle_tags %}
{% load i18n %}

{% block js %}{{ block.super }}
    <link href="{% static 'hqwebapp/js/lib/nvd3/nv.d3.css' %}" rel="stylesheet">
    <script src="{% static 'hqwebapp/js/lib/nvd3/lib/d3.v2.js' %}"></script>
    <script src="{% static 'hqwebapp/js/lib/nvd3/lib/fisheye.js' %}"></script>
    <script src="{% static 'hqwebapp/js/lib/nvd3/nv.d3.js' %}"></script>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script src="{% static 'hqwebapp/js/hash-tab.js' %}"></script>
    <script src='{% static 'hqadmin/js/date_histogram_chart.js' %}' type='text/javascript'></script>
    <script type="text/javascript">
        // given the chart_id of a chart element in the dom, the function fetches the data associated with that chart
        // and renders the chart in the specified element
        function loadChartData(chart_id, startdate, enddate) {
            var xname = {
                'forms-chart': '# of form submissions',
                'cases-chart': '# of cases created'
            }[chart_id];
            var histo_type = {
                'forms-chart': 'forms',
                'cases-chart': 'cases'
            }[chart_id];
            var $chart = $('#' + chart_id);
            $chart.parent().children('.loading').show();
            $chart.hide();

            var data = {histogram_type: histo_type};
            if (enddate) {
                data["enddate"] = enddate;
            }
            if (startdate) {
                data["startdate"] = startdate;
            }

            $.getJSON('{% url orgs_stats_data org.name %}', data,
                    function(d) {
                        var starting_time = new Date(Date.UTC(d.startdate[0], d.startdate[1]-1, d.startdate[2])).getTime();
                        var ending_time = new Date(Date.UTC(d.enddate[0], d.enddate[1]-1, d.enddate[2])).getTime();
                        addHistogram(chart_id, xname, d.histo_data, starting_time, ending_time);
                        $chart.parent().children('.loading').hide();
                        $chart.html('').append('<svg style="height:320px"> </svg>');
                        $chart.show();
                    }
            )
        }

        $(function() {
            // load chart if not already visible on the screen
            $('#chart-tabs').on('click', 'a[data-toggle="hash-tab"]', function(){
                var $chart = $($(this).attr('href')).find('.nvd3-chart');
                 if ($chart.length > 0 && !$chart.is(':visible')) {
                    loadChartData($chart.attr('id'));
                }
            });

            // load new chart when daterange is clicked
            $(document).on('submit', '.reload-graph-form', function() {
                var $this = $(this);
                var startdate = $this.find('[name="startdate"]').val();
                var enddate = $this.find('[name="enddate"]').val();
                loadChartData($this.attr('data-chart'), startdate, enddate);
                return false;
            });

            // load initial chart
            var charts = ["forms-graph", "cases-graph"];
            var chart = window.location.hash ? window.location.hash.slice(1) : "";
            chart = $.inArray(chart, charts) > -1 ? chart : charts[0];

            function find_nvd3_graph(el_id) {
               return $('#' + el_id).find('.nvd3-chart').attr('id');
            }

            loadChartData(find_nvd3_graph(chart));
        });
    </script>
{% endblock %}

{% block report %}
    <span style="margin-bottom: 1em" class="label label-info">{% trans "All dates are in UTC" %}</span>
    <ul id="chart-tabs" class="nav nav-tabs">
        <li class="active"><a href="#forms-graph" data-toggle="hash-tab">{% trans "Forms" %}</a></li>
        <li><a href="#cases-graph" data-toggle="hash-tab">{% trans "Cases" %}</a></li>
    </ul>

    <div id="charts" class="tab-content">
        <div class="tab-pane active" id="forms-graph">
            {% include "orgs/partials/reload_chart.html" with chart_name='forms-chart' %}
            <div style="height: 320px; min-height: 320px;" class="loading">{% trans "Loading..." %}</div>
            <div id='forms-chart' class='nvd3-chart hide'>
                <svg style='height:320px'> </svg>
            </div>
        </div>
        <div class="tab-pane" id="cases-graph">
            {% include "orgs/partials/reload_chart.html" with chart_name='cases-chart' %}
            <div style="height: 320px; min-height: 320px;" class="loading">{% trans "Loading..." %}</div>
            <div id='cases-chart' class='nvd3-chart hide'>
                <svg style='height:320px'> </svg>
            </div>
        </div>
    </div>
{% endblock %}

{% block org-modals %}
{% endblock %}
