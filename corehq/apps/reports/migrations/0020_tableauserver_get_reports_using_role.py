# Generated by Django 4.2.14 on 2024-08-13 19:14

from django.db import migrations, models
from corehq.util.django_migrations import skip_on_fresh_install


@skip_on_fresh_install
def _move_ff_to_setting(apps, schema_editor):
    try:
        from corehq.toggles import EMBED_TABLEAU_REPORT_BY_USER
        from corehq.toggles import EMBEDDED_TABLEAU
    except ImportError:
        return
    TableauServer = apps.get_model('reports', 'TableauServer')
    for domain in EMBEDDED_TABLEAU.get_enabled_domains():
        if not EMBED_TABLEAU_REPORT_BY_USER.enabled(domain):
            try:
                server = TableauServer.objects.get(domain=domain)
            except TableauServer.DoesNotExist:
                pass
            else:
                server.get_reports_using_role = True
                server.save()


def noop(*args, **kwargs):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('reports', '0019_tableauvisualization_location_safe'),
    ]

    operations = [
        migrations.AddField(
            model_name='tableauserver',
            name='get_reports_using_role',
            field=models.BooleanField(default=False),
        ),
        migrations.RunPython(_move_ff_to_setting, reverse_code=noop),
    ]
