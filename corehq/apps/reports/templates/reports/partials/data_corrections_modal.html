{% load i18n %}

{% comment %}
    Modal-based UI for data corrections.
    Button to open the modal is in reports/partials/data_corrections_trigger.html
    Depends on reports/js/data_corrections.js
{% endcomment %}

<!-- class='hide' keeps modal from showing until knockout initializes & removes the class -->
<div class="hide modal fade data-corrections-modal" tabindex="-1"
     data-bind="css: { 'full-screen-modal': isFullScreenModal(), 'hide': false }, event: { 'hidden.bs.modal': init }">
    <div class="modal-dialog" data-bind="css: { 'modal-lg': isLargeModal() }">
        <div class="modal-content">
            <div class="modal-header with-controls">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="form-inline pull-right" data-bind="visible: !showSpinner()">
                    <!-- ko if: displayProperties.length > 1 -->
                        <ul class="nav nav-pills">
                            <!-- ko foreach: displayProperties -->
                                <li data-bind="click: function() { $root.updateDisplayProperty(property) }, css: { active: $root.displayProperty() === property }">
                                    <a data-bind="text: name"></a>
                                </li>
                            <!--/ko-->
                        </ul>
                    <!--/ko-->
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="{% trans "Search" %}"
                               data-bind="value: query, valueUpdate: 'afterkeydown'" />
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" data-bind="click: initQuery">
                                <i class="fa fa-times"></i>
                            </button>
                        </span>
                    </div>
                </div>
                <h4 class="modal-title">
                    {% trans "Data Corrections" %}
                </h4>
            </div>
            <div class="modal-body" data-bind="css: { 'text-center': showSpinner }">
                {% if instance %}{# This is a form, not a case #}
                    <div class='alert alert-warning'>
                        <i class="fa fa-exclamation-triangle"></i>
                        {% blocktrans %}
                            Data Corrections is replacing the old "Edit this form" functionality, which will be removed in June 2018.
                        {% endblocktrans %}
                        <a href="{% url 'edit_form_instance' domain instance.form_id %}" target="_blank" id="edit-form">
                            {% trans 'Click here to access the old "edit this form" page.' %}
                        </a>

                        <br><br>

                        <i class="fa fa-exclamation-triangle"></i>
                        {% blocktrans %}
                            Data Corrections will only update individual question responses.
                            It will <strong>not</strong> run any logic or make any changes to cases.
                        {% endblocktrans %}
                    </div>
                {% endif %}
                <div class='alert alert-danger' data-bind="visible: showError">
                    {% blocktrans %}
                        Something unexpected happened.
                        Please refresh the page and try again, or report an issue if the problem persists.
                    {% endblocktrans %}
                </div>
                <div class='alert alert-danger' data-bind="visible: showRetry">
                    {% blocktrans %}
                        Something unexpected happened.
                        Please try again, or report an issue if the problem persists.
                    {% endblocktrans %}
                </div>
                <i class="fa fa-spinner fa-spin fa-5x" data-bind="visible: showSpinner"></i>
                <div data-bind="visible: !showSpinner()">
                    <div class="text-muted" data-bind="visible: showNoData">{% trans "No editable properties found" %}</div>
                    <div class="container-fluid">
                        <!-- ko foreach: visibleColumns -->
                            <div data-bind="attr: { 'class': $root.columnClass }">
                                <!-- ko foreach: $data -->
                                    <div class="form-group container-fluid" data-bind="css: {'has-success': dirty()}">
                                        <label class="col-sm-6 control-label">
                                            <i class="fa fa-pencil-square pull-left" data-bind="visible: dirty()"></i>
                                            <span data-bind="template: $root.propertyTemplate"></span>
                                        </label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control"
                                                   data-bind="value: value,
                                                              attr: { 'data-name': name },
                                                              event: { change: function() { this.dirty(true); } }" />
                                        </div>
                                    </div>
                                <!-- /ko -->
                            </div>
                        <!-- /ko -->
                    </div>
                </div>
            </div>
            <div class="modal-footer with-controls">
                <ul class="pagination pull-left" data-bind="visible: showPagination">
                    <li><a href="#" data-bind="click: function() { incrementPage(-1); }">&laquo;</a></li>
                    <!-- ko foreach: visiblePages -->
                        <li data-bind="css: { active: $parent.currentPage() == $data }">
                            <a href="#" data-bind="click: function() { $parent.currentPage($data); }, text: $data"></a>
                        </li>
                    <!-- /ko -->
                    <li><a href="#" data-bind="click: function() { incrementPage(1); }">&raquo;</a></li>
                </ul>
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-primary" data-bind="click: submitForm, attr: { disabled: disallowSave }">
                    <span data-bind="visible: !showRetry()">
                        {% trans "Save" %}
                    </span>
                    <span data-bind="visible: showRetry()">
                        {% trans "Try Again" %}
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
