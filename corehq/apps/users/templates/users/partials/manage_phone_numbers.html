{% load i18n %}

{% if phonenumbers %}
  <hr />
  {% block phonenumber_list %}
    <div class="form form-horizontal">
      <fieldset>
        <legend>{% blocktrans %}Registered Phone Numbers{% endblocktrans %}</legend>
        {% for phone in phonenumbers %}
          <div class="form-group">  {# todo B5: css-form-group #}
            <label class="form-label col-md-3 col-lg-2">+{{ phone.number }}<br />
              {% if user_type == "mobile" %}

                {% if phone.status == "verified" %}
                  <span class="badge text-bg-success">{% trans 'VERIFIED' %}</span>
                {% endif %}

                {% if phone.status == "pending" %}
                  <span class="badge text-bg-secondary">{% trans 'VERIFICATION PENDING' %}</span>
                {% endif %}

                {% if phone.status == "duplicate" %}
                  {% if phone.dup_url %}<a href="{{ phone.dup_url }}">{% endif %}
                <span class="badge text-bg-warning">{% trans 'ALREADY IN USE' %}</span>
                {% if phone.dup_url %}</a>{% endif %}
                {% endif %}

                {% if phone.status == "invalid" %}
                  <span class="badge text-bg-secondary">{% trans 'INVALID FORMAT' %}</span>
                {% endif %}

              {% endif %}
            </label>
            {% if not request.is_view_only %}
              <div class="col-md-9 col-lg-8 col-xl-6">
                {% if user_type == "mobile" and can_use_inbound_sms %}
                  {% if phone.status == "unverified" %}
                    <form method="post"
                          action="{% url "verify_phone_number" domain couch_user.couch_id %}?phone_number={{phone.number|urlencode}}"
                          style="display: inline;">  {# todo B5: inline-style #}
                      {% csrf_token %}
                      <button type="submit"
                              data-html="true"
                              data-title="<div class='alert alert-warning'><i class='fa-solid fa-triangle-exclamation'></i> <strong>{% trans 'SMS charges will incur.' %}</strong></div>{% trans 'Send a verification SMS to this phone. When the user replies to this SMS, the phone number will be verified.' %}"
                              class="btn btn-primary verify-button"><i class="fa fa-signal"></i> {% trans 'Verify' %}
                      </button>
                    </form>
                  {% endif %}

                  {% if phone.status == "duplicate" %}
                    <button data-title="You cannot verify this phone because it is already being used elsewhere"
                            class="btn btn-primary disabled verify-button">
                      <i class="fa fa-signal"></i> {% trans 'Verify' %}
                    </button>
                  {% endif %}

                  {% if phone.status == "pending" %}
                    <button data-title="Re-send the verification SMS to this phone"
                            class="btn btn-primary verify-button"
                            data-bs-toggle="modal"
                            href="#reverify_{{phone.number|urlencode}}">
                      <i class="fa fa-signal"></i> {% trans 'Verify (retry)' %}
                    </button>
                  {% endif %}
                {% endif %}

                <a class="btn btn-outline-danger"
                   data-bs-toggle="modal"
                   href="#delete_phonenumber_{{ forloop.counter }}">
                  <i class="fa fa-remove"></i> {% trans 'Delete' %}
                </a>
                {% if not forloop.first %}
                  <form class="input-inline input-append"
                        name="make_phone_number_default"
                    {% if user_type == "mobile" %}
                        action="{% url "make_phone_number_default" domain couch_user.couch_id %}"
                    {% endif %}
                        method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="make-phone-number-default"/>
                    <input type="hidden" name="phone_number" value="{{ phone.number }}"/>
                    <button type="submit" class="btn btn-outline-primary">
                      {% blocktrans %}Mark as primary{% endblocktrans %}
                    </button>
                  </form>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </fieldset>
    </div>
  {% endblock %}
{% endif %}

{% if not request.is_view_only %}
  <hr />
  <form id="add_phone_number" class="form form-horizontal" name="add_phone_number" method="post">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="add-phonenumber" />
    <fieldset>
      <legend>{% trans 'Add a Phone Number' %}</legend>
      <div class="form-group">  {# todo B5: css-form-group #}
        <label class="form-label col-md-3 col-lg-2" for="id_add_phone_number">{% trans 'Phone Number' %}</label>
        <div class="col-md-9 col-lg-8 col-xl-6">
          <div class="input-group">
            <span class="input-group-addon">+</span>  {# todo B5: css-input-group-addon #}
            <input id="id_add_phone_number" class="form-control" type="tel" pattern="\d+" name="phone_number" value="" maxlength="50" />
          </div>
          <p id="phone_number_paste_error" class="help-block" style="display: none;">  {# todo B5: inline-style #}
            <strong>
              {% trans "Phone numbers can only contain digits and we were unable to convert yours automatically." %}
            </strong>
          </p>
          <p class="help-block">
            {% blocktrans %}Please enter number, including country code, in digits only.{% endblocktrans %}
          </p>
        </div>
      </div>
    </fieldset>
    <div class="form-actions">
      <div class="offset-md-3 offset-lg-2 col-md-9 col-lg-8 col-xl-6">
        <button type="submit" class="btn btn-primary disable-on-submit">{% trans 'Add Number' %}</button>
      </div>
    </div>
  </form>
{% endif %}
