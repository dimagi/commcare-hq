{% extends "users/users_base.html" %}
{% load i18n %}
{% load hq_shared_tags %}
{% block js-inline %}{{ block.super }}
    <script>
        $(function () {
            function selectText(element) {
                /* copied from http://stackoverflow.com/questions/985272/jquery-selecting-text-in-an-element-akin-to-highlighting-with-your-mouse */
                var doc = document;
                var text = element[0];

                if (doc.body.createTextRange) { // ms
                    var range = doc.body.createTextRange();
                    range.moveToElementText(text);
                    range.select();
                } else if (window.getSelection) { // moz, opera, webkit
                    var selection = window.getSelection();
                    var range = doc.createRange();
                    range.selectNodeContents(text);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            $('#show_all_web_users_emails').click(function () {
                var open = false,
                    p = $('#all_web_users_emails');
                p.toggle();
                open = !open;
                if (open) {
                    selectText(p);
                }
                return false;
            });
        });
    </script>
    <script>
        $('.check-x').each(function () {
            if($(this).data('bool') == 'True') {
                $(this).addClass('icon-ok');
            } else if($(this).data('bool') == 'False') {
                $(this).addClass('icon-remove');
            } else {
                $(this).text('?');
            }
        })
    </script>
{% endblock %}
{% block head %}
    {{ block.super }}
    <style>
    </style>
{% endblock %}


{% block subsection-title %}
    <li class="active">
        <a href="{% url web_users domain %}">{% hq_web_user %}s</a>
    </li>
{% endblock %}

{% block user-view %}
<div class="row-fluid">
    <div>
    <h2>List of {% hq_web_user %}s for Project "{{ domain }}"</h2>
    <p>{% hq_web_user %}s can manage and view data on CommCare HQ. However, these users cannot submit forms from phones using the CommCare Application.</p>
    <div class="btn-toolbar">
        <a class="btn btn-success" href="{% url invite_web_user domain %}"><i class="icon icon-white icon-plus"></i> Invite {% hq_web_user %}</a>
    </div>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>{% trans "E-mail" %}</th>
                <th>{% trans "Role" %}</th>
                <th>{% trans "Name" %}</th>
                <th>{% trans "Phone Numbers" %}</th>
                <th>{% trans "Remove" %}</th>
            </tr>
        </thead>
        <tbody>
        {% for user in web_users %}
            <tr>
                <td>
                    <a href="{% url user_account domain user.couch_id %}">
                        {{ user.html_username|safe }}
                    </a>
                </td>
                <td>{{ user.role_label }}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td>
                    {% if user.phone_numbers %}
                        +{{ user.default_phone_number }}
                        {% if user.phone_numbers.1 %}
                            (and more)
                        {% endif %}
                    {% else %}{% endif %}
                </td>
                <td>
                    {% ifnotequal request.user.username user.username %}
                    <form style="margin-bottom: 0;" action="{% url remove_web_user domain user.user_id %}" method="post">
                        <button type="submit" class="btn btn-danger"><i class="icon icon-white icon-remove"></i> Remove Membership</button>
                    </form>
                    {% endifnotequal %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <h2>Roles</h2>
    <table class="table table-striped table-bordered">
        <thead>
        <tr>
            <th></th>
            <th>Edit Web Users</th>
            <th>Edit CommCare Users</th>
            <th>Edit Data</th>
            <th>Edit Apps</th>
            <th>View Reports</th>
        </tr>
        </thead>
        <tbody>
        {% for role in user_roles %}
        <tr>
            <th>{% if role.name %}{{ role.name }}{% else %}{{ role.get_id }}<h6>(No Name)</h6>{% endif %}</th>
            <td><i class="check-x" data-bool="{{ role.permissions.edit_web_users }}"></i></td>
            <td><i class="check-x" data-bool="{{ role.permissions.edit_commcare_users }}"></i></td>
            <td><i class="check-x" data-bool="{{ role.permissions.edit_data }}"></i></td>
            <td><i class="check-x" data-bool="{{ role.permissions.edit_apps }}"></i></td>
            <td>
                {% if role.permissions.view_reports %}
                    <i class="check-x" data-bool="True"></i>
                {% else %}
                {% if role.permissions.view_report_list %}
                <ul>
                    {% for report in role.permissions.view_report_list %}
                    <li>{{ report }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                    <i class="check-x" data-bool="False"></i>
                {% endif %}
                {% endif %}

            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
</div>
<div class="row-fluid">
    {% if user.is_superuser %}
    <div class="span6">
        <div class="btn-toolbar"><a id="show_all_web_users_emails" class="btn" href="#">Copy and paste admin emails</a></div>
        <div id="all_web_users_emails" class="well hide">
            {% for user in web_users %}
                {% if user.is_domain_admin %}
                    {% if user.first_name or user.last_name %}
                        "{{ user.first_name }} {{ user.last_name }}"
                        &lt;{{ user.username }}&gt;,
                    {% else %}
                        {{ user.username }},
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>


{% endblock %}

