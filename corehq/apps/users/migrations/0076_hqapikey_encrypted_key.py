# Generated by Django 4.2.16 on 2024-11-18 19:52

from django.db import migrations, models

from corehq.util.django_migrations import skip_on_fresh_install
from corehq.motech.utils import b64_aes_cbc_encrypt


@skip_on_fresh_install
def copy_key_to_hashed_key(apps, schema_editor):
    HQApiKey = apps.get_model('users', 'HQApiKey')
    for api_key in HQApiKey.objects.all():
        if not api_key.encrypted_key:
            api_key.encrypted_key = b64_aes_cbc_encrypt(api_key.key)
            api_key.save()


def reverse_copy_key_to_hashed_key(apps, schema_editor):
    HQApiKey = apps.get_model('users', 'HQApiKey')
    for api_key in HQApiKey.objects.all():
        api_key.encrypted_key = ''
        api_key.save()


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0075_connectiduserlink_messaging_consent_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='hqapikey',
            name='encrypted_key',
            field=models.CharField(blank=True, db_index=True, default='', max_length=128),
        ),
        migrations.RunPython(copy_key_to_hashed_key, reverse_copy_key_to_hashed_key),
    ]
