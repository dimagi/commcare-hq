{% extends "hqwebapp/base_section.html" %}
{% load compress %}
{% load hq_shared_tags %}
{% load static %}
{% load i18n %}

{% block stylesheets %}{{ block.super }}
  {% compress css %}
  <link type="text/less"
        rel="stylesheet"
        media="all"
        href="{% static 'registry/less/registry.less' %}" />
  {% endcompress %}
{% endblock %}

{% requirejs_main 'registry/js/registry_list' %}

{% block page_content %}
  {% initial_page_data "owned_registries" owned_registries %}
  {% initial_page_data "invited_registries" invited_registries %}
  <div id="data-registry-list">
    <div class="row">
      <div class="col-sm-8 col-md-6">
        <h3>{% trans "Data Registries" %}</h3>
      </div>
      <div class="col-sm-4 col-md-3">
        <div class="pull-right" style="margin-top: 17px; margin-bottom: 8.5px">
          <button type="button" class="btn btn-primary" data-bind="click: newRegistry">
            <i class="fa fa-plus"></i>
            {% trans "New Registry" %}
          </button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12 col-md-9">
      <!-- ko foreach: ownedRegistries -->
      <div class="panel panel-default show-focus">
        <div class="panel-heading clickable">
          <span data-bind="text: name"></span>
          <div class="pull-right">
            <span class="label label-primary">
              <i class="fa fa-user"></i>
              {% trans "Owner" %}
            </span>
            <button type="button" class="btn btn-default btn-xs" data-bind="click: showDeleteModal">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="panel-body">
          <p data-bind="text: description"></p>
          <span class="label label-plain" data-bind="ifnot: invitation_count">
            {% trans "No project spaces invited to this registry" %}
          </span>
          <span class="label label-plain" data-bind="if: accepted_invitation_count">
            <i class="fa fa-check-circle-o text-success"></i>
            <span data-bind="text: acceptedText"></span>
          </span>
          <span class="label label-plain" data-bind="if: pending_invitation_count">
            <i class="fa fa-clock-o text-info"></i>
            <span data-bind="text: pendingText"></span>
          </span>
          <span class="label label-plain" data-bind="if: rejected_invitation_count">
            <i class="fa fa-ban text-warning"></i>
            <span data-bind="text: rejectedText"></span>
          </span>
          <button type="button" class="btn btn-default btn-xs" data-bind="click: inviteProject">
            <i class="fa fa-plus"></i>
            {% trans "Invite Project" %}
          </button>
        </div>
      </div>
      <!-- /ko -->

    <!-- ko foreach: invitedRegistries -->
      <div class="panel panel-default show-focus">
        <div class="panel-heading clickable">
          <span data-bind="text: name"></span>
          <div class="pull-right">
            <span class="label label-warning" data-bind="if: invitation.status === 'rejected'">
              <i class="fa fa-user"></i>
              {% trans "Rejected" %}
            </span>
            <span class="label label-success" data-bind="if: invitation.status === 'accepted'">
              <i class="fa fa-user"></i>
              {% trans "Participant" %}
            </span>
            <span class="label label-info" data-bind="if: invitation.status === 'pending'">
              <i class="fa fa-user"></i>
              {% trans "Pending" %}
            </span>
          </div>
        </div>
        <div class="panel-body">
          <p data-bind="text: description"></p>
          <p><small><b>{% trans "Owner" %}:&nbsp;</b><b data-bind="text: domain_name"></b></small></p>
          <!-- ko if: invitation.status === 'rejected' -->
            <p>{% trans "Invitation rejected" %}
            <small>
              (
              {% blocktrans with user=registry.invitation.rejected_by.username date=registry.invitation.rejected_on|date:"d M Y" %}
                Rejected by {{ user }} on {{ date }}
              {% endblocktrans %}
              )
            </small>
            </p>
          <!-- /ko -->
          <!-- ko if: invitation.status === 'accepted' -->
            <span class="label label-plain" data-bind="ifnot: participator_count">
              {% trans "No other project spaces are participating in this registry" %}
            </span>
            <span class="label label-plain" data-bind="if: participator_count">
              <span data-bind="text: participatorCountText"></span>
            </span>
          <!-- /ko -->
          <!-- ko if: invitation.status === 'pending' -->
            <button type="button" class="btn btn-default btn-xs" data-bind="click: rejectInvitation">
              <i class="fa fa-remove"></i>
              {% trans "Reject" %}
            </button>
            <button type="button" class="btn btn-success btn-xs" data-bind="click: acceptInvitation">
              <i class="fa fa-check"></i>
              {% trans "Accept and Participate" %}
            </button>
          <!-- /ko -->
        </div>
      </div>
    <!-- /ko -->
      </div>
    </div>
  </div>

  <div class="modal fade" id="delete-registry-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
          <span class="sr-only">{% trans "Close" %}</span></button>
        <h4 class="modal-title">{% trans "Delete Registry" %}</h4>
      </div>
      <div class="modal-body">
        <p>
          {% trans "Are you sure you want to delete this data registry?" %}
          <b data-bind="text: registryName"></b>
        </p>
        <p>
          {% blocktrans %}
            Deleting a registry will remove all access to it from this project space and any
            other project spaces that are using it. Areas that may be impacted are:
          {% endblocktrans %}
        </p>
        <ul>
          <li>{% trans "Applications using the registry for case search" %}</li>
          <li>{% trans "Custom reports built using registry data" %}</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">
          {% trans "Cancel" %}
        </button>
        <button type="submit" class="btn btn-danger" data-bind="click: deleteRegistry">
          {% trans "Delete" %}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
