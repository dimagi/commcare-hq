{% extends "hqadmin/faceted_report.html" %}
{% load hq_shared_tags %}
{% load hqstyle_tags %}
{% load i18n %}

{% block js %}{{ block.super }}
    <link href="{% static 'hqwebapp/js/lib/nvd3/nv.d3.css' %}" rel="stylesheet">
    <script src="{% static 'hqwebapp/js/lib/nvd3/lib/d3.v2.js' %}"></script>
    <script src="{% static 'hqwebapp/js/lib/nvd3/lib/fisheye.js' %}"></script>
    <script src="{% static 'hqwebapp/js/lib/nvd3/nv.d3.min.js' %}"></script>
    <script src="{% static 'hqwebapp/js/lib/history-1.7.1.js' %}"></script>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script src="{% static 'hqwebapp/js/hash-tab.js' %}"></script>
    <script src='{% static 'hqadmin/js/nvd3_charts_helper.js' %}' type='text/javascript'></script>
    <script src='{% static 'hqadmin/js/visualizations.js' %}' type='text/javascript'></script>
    <script type="text/javascript">
        var visualizations = {
            forms: {name: "forms", xaxis_label: "# form submissions", viz: null},
            cases: {name: "cases", xaxis_label: "# case creations", viz: null},
            users: {name: "users", xaxis_label: "# mobile workers created", viz: null},
            domains: {name: "domains", xaxis_label: "# domains created", viz: null }
        };

        function parse_url_params() {
            var result = {}, queryString = location.search.slice(1),
                re = /([^&=]+)=([^&]*)/g, m;

            while (m = re.exec(queryString)) {
                var param = decodeURIComponent(m[1]), val = decodeURIComponent(m[2]);
                if (result.hasOwnProperty(param)) {
                    result[param] = [result[param], val];
                } else {
                    result[param] = val;
                }
            }

            return result;
        }
        var url_params = parse_url_params();

        for (var key in visualizations) {
            if (visualizations.hasOwnProperty(key)) {
                visualizations[key].viz = new HQVisualizations({
                    chart_name: key,
                    histogram_type: key,
                    xaxis_label: visualizations[key].xaxis_label,
                    ajax_url: "{% url admin_stats_data %}",
                    data: url_params,
                    should_update_url: false,
                    interval: "{{ interval }}"
                });
                visualizations[key].viz.init();
            }
        }
    </script>
{% endblock %}
{% block main_column %}{{ block.super }}
    <hr />
    <h4>{% trans "Total Distinct Active Users (matching filters)" %}: {{ total_distinct_users }}</h4>
    <hr />
    <h2>{% trans "Visualize Project Spaces" %}</h2>
    {% include "orgs/partials/visualizations.html" with chart_name="domains" %}
    <h2>{% trans "Visualize Forms" %}</h2>
    {% include "orgs/partials/visualizations.html" with chart_name="forms" %}
    <h2>{% trans "Visualize Cases" %}</h2>
    {% include "orgs/partials/visualizations.html" with chart_name="cases" %}
    <h2>{% trans "Visualize Users" %}</h2>
    {% include "orgs/partials/visualizations.html" with chart_name="users" %}
{% endblock %}
