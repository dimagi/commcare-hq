# TopoJson Setup

This module serves topojson files for blocks based on the selected district.
This avoids having to send down 20+MB of shape data on every dashboard page.

As of December, 2019 this functionality is used by the mobile dashboard and is in QA
on web.

## Generating the files

The files in `static` have been generated by the management command `split_topojsons` in 
this application.

You will need to install mapshaper to run it:

```
npm install -g mapshaper
```

## File structure

[See here for details](https://github.com/dimagi/commcare-hq/blob/master/custom/icds_reports/static/js/topojsons/README.md)

## Functionality

The `get_block_topojson_for_state` function first looks up the appropriate state file
for the district by matching on the district name. 
Then returns the appropriate topojson file for the whole state.

## Downsizing Topojsons

To downsize topojsons simply run:

`./manage.py downsize_topojson [level] [output_file] [pct]`

This will output a *topojson* file to the same directory with all metadata from the original file included.

Note that we are in the process of attempting to phase out the JavaScript versions of these files.

**Advanced Editing Only***

If you need more advanced options you can follow these instructions instead:

1. Export raw topojson to a file using `./manage.py format_topojson [level]`
2. Open the file in [mapshaper](https://mapshaper.org/) and adjust the resolution until desired.
3. Export the file from mapshaper.
4. Run `./manage.py merge_topojsons [level] [new filename]`
5. Add the JS variable declaration to the file (e.g. `STATES_TOPOJSON = [topojson];`) and save 
   it somewhere

## Todos

The following is a brain dump of todos to improve this setup:

- Reliably run `split_topojsons` and confirm it produces the same results
- Implement this functionality for districts and not just blocks
- Don't return the whole state's data when just the single district's blocks are needed
- Maybe load the data via a static view instead of having it pass through django so it
  can be served by nginx (would require porting some logic to the front end)
- Or else, do some caching on the data so we aren't hitting the filesystem with every request
