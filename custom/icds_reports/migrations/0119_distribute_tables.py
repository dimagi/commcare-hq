# -*- coding: utf-8 -*-
# Generated by Django 1.11.20 on 2019-05-14 12:45
from __future__ import absolute_import, unicode_literals

from django.db import migrations

from corehq.sql_db.connections import is_citus_db
from custom.icds_reports.const import DISTRIBUTED_TABLES, REFERENCE_TABLES
from custom.icds_reports.utils.migrations import (
    create_citus_distributed_table,
    create_citus_reference_table,
)


def _distribute_citus_tables(apps, schema_editor):
    with schema_editor.connection.cursor() as cursor:
        if not is_citus_db(cursor):
            return

        for table, col in DISTRIBUTED_TABLES:
            create_citus_distributed_table(cursor, table, col)

        for table in REFERENCE_TABLES:
            create_citus_reference_table(cursor, table)


class Migration(migrations.Migration):

    dependencies = [
        ('icds_reports', '0118_monthly_pk'),
    ]

    operations = [
        migrations.RunPython(_distribute_citus_tables, migrations.RunPython.noop)
    ]
